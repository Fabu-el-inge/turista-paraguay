<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TURISTA PARAGUAY - Sistema de Inventario</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f5f5f5;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            color: #333;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #4CAF50;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-danger {
            background: #f44336;
            color: white;
        }

        .badge-info {
            background: #2196F3;
            color: white;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .low-stock-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .unit-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav {
                flex-wrap: wrap;
            }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
    
        /* Selector personalizado con im√°genes */
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        
        .custom-select-button {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .custom-select-button:hover {
            border-color: #667eea;
        }
        
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .product-option {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .product-option:hover {
            background: #f5f5f5;
        }
        
        .product-option:last-child {
            border-bottom: none;
        }
        
        .product-option-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 12px;
            border: 1px solid #ddd;
        }
        
        .product-option-no-image {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 5px;
            margin-right: 12px;
            font-size: 24px;
        }
        
        .product-option-info {
            flex: 1;
        }
        
        .product-option-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }
        
        .product-option-details {
            font-size: 12px;
            color: #666;
        }

        </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üáµüáæ TURISTA PARAGUAY - Sistema de Inventario</div>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="showSection('products')">üì¶ Productos</button>
                <button class="nav-btn" onclick="showSection('clients')">üë• Clientes</button>
                <button class="nav-btn" onclick="showSection('sales')">üí∞ Ventas</button>
                <button class="nav-btn" onclick="showSection('reports')">üìà Reportes</button>
            </div>
        </div>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 20px;">Dashboard General</h2>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-warning" onclick="migrateLocalStorageToSupabase()" style="width: 100%;">Migrar Datos desde localStorage</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Productos</div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">en inventario</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valor Total Inventario</div>
                        <div class="stat-value" id="totalValue">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ventas Hoy</div>
                        <div class="stat-value" id="todaySales">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Bajo</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div class="stat-label">productos</div>
                    </div>
                </div>

                <div id="lowStockAlerts"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Productos M√°s Vendidos</h3>
                <div class="table-container">
                    <table id="topProductsTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Cantidad Vendida</th>
                                <th>Ingresos</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <div class="empty-state-icon">üì¶</div>
                                    <div>No hay datos de ventas a√∫n</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUCTOS -->
            <div id="products" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Productos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">‚ûï Agregar Producto</button>
                </div>

                <div class="info-box">
                    <div class="info-box-title">üí° Sistema con Unidades de Medida</div>
                    <div>Ahora puedes gestionar productos con diferentes unidades: unidades, metros, hojas, paquetes, litros, kilos, etc.</div>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchProducts" placeholder="üîç Buscar productos..." onkeyup="filterProducts()">
                    <select id="categoryFilter" onchange="filterProducts()">
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Marca</th>
                                <th>Categor√≠a</th>
                                <th>Stock</th>
                                <th>Precio de Venta</th>
                                <th>Imagen</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clients" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Clientes</h2>
                    <button class="btn btn-primary" onclick="openClientModal()">‚ûï Nuevo Cliente</button>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchClients" placeholder="üîç Buscar clientes por nombre, documento o tel√©fono..." onkeyup="filterClients()">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre Completo</th>
                                <th>Documento</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Ciudad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VENTAS -->
            <div id="sales" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Registrar Venta</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Seleccionar Producto</label>
                        <!-- Selector personalizado con im√°genes -->
                        <div class="custom-select-container">
                            <div id="customSelectButton" class="custom-select-button" onclick="toggleProductDropdown()">
                                <span id="selectedProductText">-- Seleccionar Producto --</span>
                                <span style="float:right;">‚ñº</span>
                            </div>
                            <div id="productDropdown" class="custom-dropdown" style="display:none;">
                                <input type="text" id="productSearchInput" placeholder="üîç Buscar producto..." onkeyup="filterProductOptions()" style="width:100%;padding:10px;border:none;border-bottom:2px solid #eee;box-sizing:border-box;">
                                <div id="productOptionsList" style="max-height:300px;overflow-y:auto;">
                                    <!-- Las opciones se cargan din√°micamente -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="saleProduct">
                    </div>
                    <div class="form-group">
                        <label>Cantidad <span id="saleUnitLabel"></span></label>
                        <input type="number" id="saleQuantity" min="1" step="1" value="1" onchange="updateSaleTotal()">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio Unitario</label>
                        <input type="text" id="salePrice" readonly style="text-align:left; font-weight:bold;">
                    </div>
                    <div class="form-group">
                        <label>Total</label>
                        <input type="text" id="saleTotal" readonly style="font-weight:bold; font-size:18px; text-align:left;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cliente *</label>
                        <select id="saleCustomer" required>
                            <option value="">-- Seleccionar Cliente --</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="openClientModal()" style="width: 100%;">‚ûï Nuevo Cliente</button>
                    </div>
                </div>

                <button class="btn btn-success" onclick="registerSale()" style="width: 100%; font-size: 16px;">‚úÖ Registrar Venta</button>

                <h3 style="margin-top: 40px; margin-bottom: 15px;">Historial de Ventas</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Marca</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Cliente</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistoryBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reports" class="section">
                <h2 style="margin-bottom: 20px;">Reportes y Estad√≠sticas</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (Mes)</div>
                        <div class="stat-value" id="monthSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (A√±o)</div>
                        <div class="stat-value" id="yearSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Transacciones</div>
                        <div class="stat-value" id="totalSoldUnits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Categor√≠a M√°s Vendida</div>
                        <div class="stat-value" style="font-size: 24px;" id="topCategory">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Ventas por Categor√≠a</h3>
                    <div id="categoryReport"></div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="exportData()">üì• Exportar Datos (JSON)</button>
                    <button class="btn btn-warning" onclick="generateCSVReport()">üìä Exportar Reporte (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>

            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">

                <!-- Secci√≥n de vista previa del producto (solo visible en edici√≥n) -->
                <div id="productDetailView" style="display:none;background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <div style="display:grid;grid-template-columns:200px 1fr;gap:20px;align-items:start;">
                        <div>
                            <img id="detailProductImage" style="width:100%;border-radius:8px;border:2px solid #ddd;display:none;">
                            <div id="noImagePlaceholder" style="width:100%;height:200px;background:#e0e0e0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;">
                                üì¶ Sin imagen
                            </div>
                        </div>
                        <div>
                            <h3 id="detailProductName" style="margin:0 0 15px 0;color:#667eea;"></h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #ff6b6b;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üí∞ Precio de Compra</div>
                                    <div id="detailCostPrice" style="font-size:20px;font-weight:bold;color:#ff6b6b;"></div>
                                </div>
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #51cf66;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üíµ Precio de Venta</div>
                                    <div id="detailSalePrice" style="font-size:20px;font-weight:bold;color:#51cf66;"></div>
                                </div>
                            </div>
                            <div style="margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <div>
                                    <span style="font-size:12px;color:#666;">Stock:</span>
                                    <strong id="detailStock" style="margin-left:5px;"></strong>
                                </div>
                                <div>
                                    <span style="font-size:12px;color:#666;">Estado:</span>
                                    <span id="detailStatus" style="margin-left:5px;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Producto *</label>
                        <input type="text" id="productCode" required placeholder="Ej: TP-001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="productCategory" required>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openCategoryModal()" style="margin-top:10px;width:100%;">‚öôÔ∏è Gestionar Categor√≠as</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="productName" required placeholder="Ej: Remera Paraguay" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="productBrand" placeholder="Ej: Nike, Adidas (opcional)" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label>Stock *</label>
                        <input type="number" id="productStock" required min="0" step="1" placeholder="Cantidad">
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida *</label>
                        <select id="productUnit" required>
                            <option value="unidades">Unidades</option>
                            <option value="metros">Metros</option>
                            <option value="hojas">Hojas</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="litros">Litros</option>
                            <option value="kilos">Kilos</option>
                            <option value="gramos">Gramos</option>
                            <option value="cajas">Cajas</option>
                            <option value="rollos">Rollos</option>
                            <option value="pares">Pares</option>
                            <option value="docenas">Docenas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="productMinStock" min="0" step="1" value="3" placeholder="M√≠nimo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio de Costo (‚Ç≤)</label>
                        <input type="text" id="productCost" placeholder="Ej: 50.000" oninput="formatPriceInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Precio de Venta (‚Ç≤) *</label>
                        <input type="text" id="productPrice" required placeholder="Ej: 100.000" oninput="formatPriceInput(this)">
                    </div>
                </div>

               <!-- Campo de Foto -->
<div class="form-group">
    <label>üì∏ Foto del Producto (Opcional)</label>
    <div id="dropZone" style="border:2px dashed #ccc;border-radius:5px;padding:20px;text-align:center;background:#f9f9f9;margin-bottom:10px;cursor:pointer;"
         ondragover="event.preventDefault();this.style.background='#e3f2fd';"
         ondragleave="this.style.background='#f9f9f9';"
         ondrop="handleDrop(event)"
         onclick="document.getElementById('productImage').click()">
        <p style="margin:0;color:#666;">üñºÔ∏è Arrastra una imagen aqu√≠ o haz clic para seleccionar</p>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <input type="file" id="productImage" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('productImage').click()">üìÅ Subir Archivo</button>
        <button type="button" class="btn btn-primary" onclick="takePhoto()">üì∑ Tomar Foto</button>
    </div>
    <div id="imagePreview" style="margin-top:10px;display:none;">
        <img id="previewImg" style="max-width:200px;max-height:200px;border-radius:5px;border:2px solid #ddd;">
        <button type="button" class="btn btn-danger" onclick="clearImage()" style="display:block;margin-top:10px;width:200px;">üóëÔ∏è Eliminar Foto</button>
    </div>
</div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle">Agregar Cliente</h2>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Cliente *</label>
                        <input type="text" id="clientCode" required placeholder="CL-0001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Documento *</label>
                        <select id="clientDocType" required>
                            <option value="CI">C√©dula de Identidad</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero de Documento *</label>
                        <input type="text" id="clientDocNumber" required placeholder="Ej: 1.234.567" oninput="formatDocumentNumber(this)">
                    </div>
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="clientName" required placeholder="Nombre y Apellido" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="clientPhone" required placeholder="Ej: 0981234567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad *</label>
                        <input type="text" id="clientCity" required placeholder="Ej: Asunci√≥n" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="clientAddress" placeholder="Direcci√≥n completa" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="clientNotes" rows="2" placeholder="Notas adicionales (opcional)" oninput="capitalizeFirst(this)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar Cliente</button>
                    <button type="button" class="btn btn-danger" onclick="closeClientModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Base de datos con Supabase
        let products = [];
        let sales = [];
        let clients = [];

        // Variables globales
        let editingProductId = null;
        let editingClientId = null;
        let selectedImageFile = null;
        let currentCameraMode = 'environment'; // 'user' para frontal, 'environment' para trasera

        // Categor√≠as del sistema
        let categories = [];

        // Cargar categor√≠as desde Supabase
        async function loadCategories() {
            try {
                categories = await loadCategoriesFromDB();
                updateCategorySelects();
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
                // Usar categor√≠as predeterminadas si falla
                categories = [
                    'Remeras', 'Recuerdos', 'Botellas', 'Stickers', 
                    'Gorras', 'Llaveros', 'Tazas', 'Materiales', 'Telas', 'Otros'
                ];
                updateCategorySelects();
            }
        }

        // Ya no se usa - las categor√≠as se guardan directamente en Supabase

        // Actualizar todos los selects de categor√≠as
        function updateCategorySelects() {
            // Select del formulario de productos
            const productCategorySelect = document.getElementById('productCategory');
            if (productCategorySelect) {
                const currentValue = productCategorySelect.value;
                productCategorySelect.innerHTML = '<option value="">-- Seleccionar --</option>';
                categories.forEach(cat => {
                    productCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentValue && categories.includes(currentValue)) {
                    productCategorySelect.value = currentValue;
                }
            }

            // Select del filtro
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                const currentFilter = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
                categories.forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentFilter && categories.includes(currentFilter)) {
                    categoryFilter.value = currentFilter;
                }
            }

            // Lista en el modal de gesti√≥n
            if (document.getElementById('categoriesList')) {
                updateCategoriesList();
            }
        }

        // Abrir modal de categor√≠as
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            updateCategoriesList();
        }

        // Cerrar modal de categor√≠as
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryName').value = '';
        }

        // Agregar nueva categor√≠a
        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre para la categor√≠a');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('‚ö†Ô∏è Esta categor√≠a ya existe');
                return;
            }

            try {
                await saveCategoryToDB(categoryName);
                categories.push(categoryName);
                categories.sort();
                updateCategorySelects();
                document.getElementById('newCategoryName').value = '';
                alert('‚úÖ Categor√≠a agregada correctamente');
            } catch (error) {
                alert('‚ùå Error al agregar categor√≠a: ' + error.message);
            }
        }

        // Eliminar categor√≠a
        async function deleteCategory(categoryName) {
            if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?

Nota: Los productos con esta categor√≠a no se eliminar√°n.`)) {
                return;
            }

            try {
                await deleteCategoryFromDB(categoryName);
                categories = categories.filter(cat => cat !== categoryName);
                updateCategorySelects();
                alert('‚úÖ Categor√≠a eliminada correctamente');
            } catch (error) {
                alert('‚ùå Error al eliminar categor√≠a: ' + error.message);
            }
        }

        // Actualizar lista de categor√≠as en el modal
        function updateCategoriesList() {
            const list = document.getElementById('categoriesList');
            if (!list) return;
            
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No hay categor√≠as</p>';
                return;
            }

            categories.forEach(cat => {
                list.innerHTML += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;">
                        <span style="font-weight:500;">${cat}</span>
                        <button class="btn btn-danger" onclick="deleteCategory('${cat}')" style="padding:5px 10px;font-size:12px;">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            });
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCategories();
            await loadProducts();
            await loadSales();
            await loadClients();
            await updateDashboard();
            await updateReports();
        });

        // Navegaci√≥n
        async function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'dashboard') await updateDashboard();
            if (sectionName === 'products') await loadProducts();
            if (sectionName === 'clients') await loadClients();
            if (sectionName === 'sales') await loadSalesForm();
            if (sectionName === 'reports') await updateReports();
        }

        // Generar c√≥digo autom√°tico √∫nico
        function generateProductCode() {
            const prefix = 'TP';
            const existingCodes = products.map(p => p.code);
            let number = 1;
            let code = '';

            // Buscar el siguiente n√∫mero disponible
            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Modal de productos
        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();

            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('modalTitle').textContent = 'Editar Producto';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productCode').value = product.code;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand || '';
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productUnit').value = product.unit || 'unidades';
                    document.getElementById('productCost').value = product.cost ? product.cost.toLocaleString('de-DE') : '';
                    document.getElementById('productPrice').value = product.price.toLocaleString('de-DE');
                    document.getElementById('productMinStock').value = product.minStock || 3;
                    document.getElementById('productDescription').value = product.description || '';
                    editingProductId = productId;

                    // Mostrar vista detallada del producto
                    document.getElementById('productDetailView').style.display = 'block';
                    document.getElementById('detailProductName').textContent = product.name + (product.brand ? ` - ${product.brand}` : '');
                    document.getElementById('detailCostPrice').textContent = formatGuaranies(product.cost || 0);
                    document.getElementById('detailSalePrice').textContent = formatGuaranies(product.price);
                    document.getElementById('detailStock').textContent = formatUnit(product.stock, product.unit);

                    // Calcular estado
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';
                    document.getElementById('detailStatus').innerHTML = stockStatus;

                    // Mostrar imagen en la vista detallada
                    if (product.imageUrl) {
                        document.getElementById('detailProductImage').src = product.imageUrl;
                        document.getElementById('detailProductImage').style.display = 'block';
                        document.getElementById('noImagePlaceholder').style.display = 'none';

                        // Tambi√©n en el preview del formulario
                        document.getElementById('previewImg').src = product.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('detailProductImage').style.display = 'none';
                        document.getElementById('noImagePlaceholder').style.display = 'flex';
                    }
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Agregar Producto';
                document.getElementById('productDetailView').style.display = 'none';
                editingProductId = null;
                // Generar c√≥digo autom√°tico para producto nuevo
                document.getElementById('productCode').value = generateProductCode();
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
            clearImage();
        }

        // Guardar producto
        async function saveProduct(event) {
            event.preventDefault();

            const productData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value || '',
                category: document.getElementById('productCategory').value,
                stock: parseFloat(document.getElementById('productStock').value),
                unit: document.getElementById('productUnit').value,
                cost: parseFormattedPrice(document.getElementById('productCost').value),
                price: parseFormattedPrice(document.getElementById('productPrice').value),
                minStock: parseFloat(document.getElementById('productMinStock').value) || 3,
                description: document.getElementById('productDescription')?.value || ''
            };

            // Si hay imagen, subirla primero
            if (selectedImageFile && productData.code) {
                const imageUrl = await uploadProductImage(selectedImageFile, productData.code);
                if (imageUrl) {
                    productData.imageUrl = imageUrl;
                }
            }

            try {

                // Obtener el ID del producto del campo oculto o de la variable global

                const productId = document.getElementById('productId').value || editingProductId;

                if (productId) {

                    // Modo edici√≥n - actualizar producto existente
                    await updateProductInDB(parseInt(productId), productData);
                    alert('‚úÖ Producto actualizado correctamente');
                    closeProductModal();
                } else {

                    // Modo creaci√≥n - crear nuevo producto

                    await saveProductToDB(productData);
                    alert('‚úÖ Producto agregado correctamente');

                    // Limpiar formulario para agregar otro producto r√°pidamente
                    document.getElementById('productForm').reset();
                    document.getElementById('productCode').value = generateProductCode();
                    document.getElementById('productUnit').value = 'unidades';
                    document.getElementById('productMinStock').value = 3;
                    document.getElementById('productName').focus();
                    clearImage();
                }

                await loadProducts();
                await updateDashboard();
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al guardar producto: ' + error.message);
            }
        }

        // Formatear guaran√≠es con separador de miles (punto decimal)
        function formatGuaranies(amount) {
            if (amount === null || amount === undefined || amount === '') return 'Gs. 0';
            // Convertir a n√∫mero y redondear
            const num = Math.round(Number(amount));
            // Convertir a string
            let str = num.toString();
            // Aplicar separador de miles (punto)
            str = str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const result = `Gs. ${str}`;
            console.log(`formatGuaranies(${amount}) = ${result}`); // DEBUG
            return result;
        }

        // Capitalizar primera letra
        function capitalizeFirst(input) {
            if (input.value.length > 0) {
                input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
            }
        }



        // Formatear n√∫mero con puntos (auxiliar)
        function formatNumberWithDots(number) {
            if (!number) return '';
            const str = number.toString();
            return str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Formatear n√∫mero de documento con puntos
        function formatDocumentNumber(input) {
            // Obtener solo n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Aplicar formato con puntos cada 3 d√≠gitos
            if (value.length > 0) {
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            input.value = value;
            // Guardar valor sin formato en data attribute
            input.dataset.rawValue = value.replace(/\./g, '');
        }

        // ===== FUNCIONES PARA MANEJO DE FOTOS =====
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                return;
            }

            // Validar formato
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('‚ùå Formato no v√°lido. Usa JPG, PNG o WEBP.');
                return;
            }

            selectedImageFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropZone').style.background = '#f9f9f9';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Validar que sea imagen
                if (!file.type.match('image.*')) {
                    alert('‚ùå Por favor arrastra una imagen');
                    return;
                }

                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                    return;
                }

                selectedImageFile = file;

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        async function takePhoto() {
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo acceder a la c√°mara: ' + error.message);
            }
        }

        async function startCamera() {
            // Detener stream anterior si existe
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    facingMode: currentCameraMode
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Si ya existe el modal, solo actualizar el video
            if (window.cameraModal) {
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                window.currentStream = stream;
                return;
            }

            // Crear modal con video
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;">
                    <div style="background:white;padding:20px;border-radius:10px;max-width:90%;max-height:90%;">
                        <video id="cameraVideo" autoplay playsinline style="max-width:100%;border-radius:8px;"></video>
                        <div style="margin-top:15px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="capturePhoto()">üì∏ Capturar</button>
                            <button class="btn btn-secondary" onclick="flipCamera()">üîÑ Voltear C√°mara</button>
                            <button class="btn btn-secondary" onclick="closeCamera()">‚ùå Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;

            window.currentStream = stream;
            window.cameraModal = modal;
        }

        async function flipCamera() {
            // Cambiar entre frontal y trasera
            currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo cambiar la c√°mara: ' + error.message);
                // Volver al modo anterior si falla
                currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob((blob) => {
                selectedImageFile = new File([blob], 'photo.jpg', { type: 'image/jpeg' });

                document.getElementById('previewImg').src = canvas.toDataURL();
                document.getElementById('imagePreview').style.display = 'block';

                closeCamera();
            }, 'image/jpeg');
        }

        function closeCamera() {
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }
            if (window.cameraModal) {
                window.cameraModal.remove();
            }
        }

        function clearImage() {
            selectedImageFile = null;
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function showImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;" onclick="this.parentElement.remove()">
                    <div style="max-width:90%;max-height:90%;text-align:center;">
                        <img src="${imageUrl}" style="max-width:100%;max-height:90vh;border-radius:10px;">
                        <p style="color:white;margin-top:10px;">Click para cerrar</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Formatear input de precio con punto decimal
        function formatPriceInput(input) {
            // Remover todo excepto n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Si est√° vac√≠o, dejar vac√≠o
            if (value === '') {
                input.value = '';
                return;
            }

            // Convertir a n√∫mero
            let num = parseInt(value, 10);

            // Formatear con puntos
            input.value = num.toLocaleString('de-DE'); // Usa formato alem√°n que tiene punto como separador
        }

        // Convertir precio formateado a n√∫mero
        function parseFormattedPrice(formattedValue) {
            if (!formattedValue || formattedValue === '') return 0;
            // Remover puntos y convertir a n√∫mero
            return parseFloat(formattedValue.replace(/\./g, '')) || 0;
        }

        // Formatear unidad de medida
        function formatUnit(quantity, unit) {
            const formatted = parseFloat(quantity).toFixed(2).replace(/\.?0+$/, '');
            return `${formatted} ${unit}`;
        }

        // Cargar productos
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            try {
                products = await loadProductsFromDB();

                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <div>No hay productos registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openProductModal()">Agregar Primer Producto</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                products.forEach(product => {
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';

                    const brandCell = product.brand ? `<td>${product.brand}</td>` : '<td><em style="color: #999;">-</em></td>';

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${product.code}</strong></td>
                            <td>${product.name}</td>
                            ${brandCell}
                            <td>${product.category}</td>
                            <td><strong>${formatUnit(product.stock, product.unit)}</strong></td>
                            <td><strong>${formatGuaranies(product.price)}</strong></td>
                             <td>${product.imageUrl ? `<img src="${product.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;cursor:pointer;" onclick='showImageModal("${product.imageUrl}")'>` : '‚ùå'}</td>
                            <td>${stockStatus}</td>
                            <td class="action-btns">
                                <button class="action-btn btn-primary" onclick="openProductModal(${product.id})">‚úèÔ∏è Editar</button>
                                <button class="action-btn btn-danger" onclick="deleteProduct(${product.id})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            }
        }

        // Eliminar producto
        async function deleteProduct(productId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
                try {
                    await deleteProductFromDB(productId);
                    await loadProducts();
                    await updateDashboard();
                    alert('‚úÖ Producto eliminado correctamente');
                } catch (error) {
                    alert('Error al eliminar producto: ' + error.message);
                }
            }
        }

        // Filtrar productos
        function filterProducts() {
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            const rows = document.querySelectorAll('#productsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.children[2]?.textContent || '';

                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;

                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }


        // ===== FUNCIONES PARA SELECTOR PERSONALIZADO DE PRODUCTOS =====
        
        function toggleProductDropdown() {
            const dropdown = document.getElementById('productDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeProductDropdown() {
            document.getElementById('productDropdown').style.display = 'none';
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.custom-select-container');
            if (container && !container.contains(event.target)) {
                closeProductDropdown();
            }
        });
        
        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Actualizar campo oculto
            document.getElementById('saleProduct').value = productId;
            
            // Actualizar texto del bot√≥n
            document.getElementById('selectedProductText').textContent = product.name + ' (' + formatUnit(product.stock, product.unit) + ')';
            
            // Cerrar dropdown
            closeProductDropdown();
            
            // Actualizar precio
            updateSalePrice();
        }
        
        function filterProductOptions() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const options = document.querySelectorAll('.product-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function loadProductOptions() {
            const optionsList = document.getElementById('productOptionsList');
            optionsList.innerHTML = '';
            
            // Filtrar solo productos con stock
            const availableProducts = products.filter(p => p.stock > 0);
            
            if (availableProducts.length === 0) {
                optionsList.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No hay productos disponibles</div>';
                return;
            }
            
            availableProducts.forEach(product => {
                const option = document.createElement('div');
                option.className = 'product-option';
                option.onclick = () => selectProduct(product.id);
                
                // Imagen o placeholder
                let imageHTML = '';
                if (product.imageUrl && product.imageUrl.trim() !== '') {
                    imageHTML = `<img src="${product.imageUrl}" class="product-option-image" alt="${product.name}">`;
                } else {
                    imageHTML = '<div class="product-option-no-image">üì¶</div>';
                }
                
                option.innerHTML = `
                    ${imageHTML}
                    <div class="product-option-info">
                        <div class="product-option-name">${product.name}</div>
                        <div class="product-option-details">
                            Stock: ${formatUnit(product.stock, product.unit)} | Precio: ${formatGuaranies(product.price)}
                        </div>
                    </div>
                `;
                
                optionsList.appendChild(option);
            });
        }

        // Cargar formulario de ventas
        async function loadSalesForm() {
            // Cargar productos en selector personalizado
            loadProductOptions();

            // Cargar clientes
            const selectCustomer = document.getElementById('saleCustomer');
            selectCustomer.innerHTML = '<option value="">-- Seleccionar Cliente --</option>';

            clients.forEach(client => {
                selectCustomer.innerHTML += `<option value="${client.id}">${client.name} - ${client.docType}: ${client.docNumber}</option>`;
            });

            await loadSalesHistory();
        }

        // Actualizar precio de venta
        function updateSalePrice() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                document.getElementById('salePrice').value = formatGuaranies(product.price);
                document.getElementById('salePrice').dataset.rawValue = product.price; // Guardar valor num√©rico
                document.getElementById('saleUnitLabel').textContent = `(${product.unit})`;
                updateSaleTotal();
            } else {
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleUnitLabel').textContent = '';
            }
        }

        // Actualizar total de venta
        function updateSaleTotal() {
            const priceElement = document.getElementById('salePrice');
            const price = parseFloat(priceElement.dataset.rawValue) || 0;
            const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('saleTotal').value = formatGuaranies(total);
            document.getElementById('saleTotal').dataset.rawValue = total; // Guardar valor num√©rico
        }

        // Registrar venta
        async function registerSale() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseFloat(document.getElementById('saleQuantity').value);
            const customerId = parseInt(document.getElementById('saleCustomer').value);

            if (!productId || !quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            if (!customerId) {
                alert('‚ö†Ô∏è Por favor selecciona un cliente');
                return;
            }

            const product = products.find(p => p.id === productId);
            const client = clients.find(c => c.id == customerId);

            if (quantity > product.stock) {
                alert(`‚ö†Ô∏è No hay suficiente stock disponible. Stock actual: ${formatUnit(product.stock, product.unit)}`);
                return;
            }

            const saleData = {
                productId: productId,
                productName: product.name,
                productBrand: product.brand || '',
                category: product.category,
                quantity: quantity,
                unit: product.unit,
                price: product.price,
                total: product.price * quantity,
                customerId: client.id,
                customer: client.name,
                customerDoc: `${client.docType}: ${client.docNumber}`
            };

            try {
                // Guardar venta
                await saveSaleToDB(saleData);

                // Actualizar stock del producto
                const newStock = product.stock - quantity;
                await updateProductInDB(productId, { stock: newStock });

                alert('‚úÖ Venta registrada exitosamente');

                // Limpiar formulario
                document.getElementById('saleProduct').value = '';
                document.getElementById('selectedProductText').textContent = '-- Seleccionar Producto --';
                document.getElementById('saleQuantity').value = 1;
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleCustomer').value = '';
                document.getElementById('saleUnitLabel').textContent = '';

                await loadProducts();
                await loadSalesForm();
                await updateDashboard();
            } catch (error) {
                alert('Error al registrar venta: ' + error.message);
            }
        }

        // Cargar historial de ventas
        async function loadSalesHistory() {
            const tbody = document.getElementById('salesHistoryBody');
            tbody.innerHTML = '';

            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <div>No hay ventas registradas</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Mostrar √∫ltimas 20 ventas
            const recentSales = [...sales].reverse().slice(0, 20);

            recentSales.forEach(sale => {
                const date = new Date(sale.created_at);
                const brandCell = sale.productBrand ? `<td>${sale.productBrand}</td>` : '<td><em style="color: #999;">Sin marca</em></td>';
                tbody.innerHTML += `
                    <tr>
                        <td>${date.toLocaleString('es-PY')}</td>
                        <td>${sale.productName}</td>
                        ${brandCell}
                        <td>${formatUnit(sale.quantity, sale.unit)}</td>
                        <td><strong>${formatGuaranies(sale.total)}</strong></td>
                        <td>${sale.customer}</td>
                    </tr>
                `;
            });
        }

        // Cargar ventas
        async function loadSales() {
            try {
                sales = await loadSalesFromDB();
                await loadSalesHistory();
            } catch (error) {
                alert('Error al cargar ventas: ' + error.message);
            }
        }

        // Actualizar dashboard
        async function updateDashboard() {
            // Total productos
            document.getElementById('totalProducts').textContent = products.length;

            // Valor total inventario (basado en precio de costo)
            const totalValue = products.reduce((sum, p) => sum + (p.stock * (p.cost || 0)), 0);
            document.getElementById('totalValue').textContent = formatGuaranies(totalValue);

            // Ventas de hoy
            const today = new Date().toDateString();
            const todaySales = sales.filter(s => new Date(s.created_at).toDateString() === today);
            const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('todaySales').textContent = formatGuaranies(todayTotal);

            // Stock bajo
            const lowStock = products.filter(p => p.stock <= p.minStock);
            document.getElementById('lowStockCount').textContent = lowStock.length;

            // Alertas de stock bajo
            const alertsDiv = document.getElementById('lowStockAlerts');
            alertsDiv.innerHTML = '';

            if (lowStock.length > 0) {
                alertsDiv.innerHTML = `
                    <div class="low-stock-alert">
                        <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Alertas de Stock Bajo</h3>
                        ${lowStock.map(p => `
                            <div style="margin: 5px 0;">
                                <strong>${p.name}</strong> - Solo quedan ${formatUnit(p.stock, p.unit)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Productos m√°s vendidos
            const productSales = {};
            sales.forEach(sale => {
                if (!productSales[sale.productId]) {
                    productSales[sale.productId] = {
                        name: sale.productName,
                        category: sale.category,
                        units: 0,
                        unit: sale.unit,
                        revenue: 0
                    };
                }
                productSales[sale.productId].units += sale.quantity;
                productSales[sale.productId].revenue += sale.total;
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';

            if (topProducts.length > 0) {
                topProducts.forEach(p => {
                    topBody.innerHTML += `
                        <tr>
                            <td><strong>${p.name}</strong></td>
                            <td>${p.category}</td>
                            <td>${formatUnit(p.units, p.unit)}</td>
                            <td><strong>${formatGuaranies(p.revenue)}</strong></td>
                        </tr>
                    `;
                });
            } else {
                topBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div>No hay datos de ventas a√∫n</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Actualizar reportes
        async function updateReports() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Ventas del mes
            const monthSales = sales.filter(s => {
                const saleDate = new Date(s.created_at);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthTotal = monthSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('monthSales').textContent = formatGuaranies(monthTotal);

            // Ventas del a√±o
            const yearSales = sales.filter(s => new Date(s.created_at).getFullYear() === currentYear);
            const yearTotal = yearSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('yearSales').textContent = formatGuaranies(yearTotal);

            // Total transacciones
            document.getElementById('totalSoldUnits').textContent = sales.length;

            // Categor√≠a m√°s vendida
            const categorySales = {};
            sales.forEach(s => {
                if (!categorySales[s.category]) categorySales[s.category] = 0;
                categorySales[s.category] += s.total;
            });

            const topCategory = Object.entries(categorySales)
                .sort((a, b) => b[1] - a[1])[0];

            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';

            // Reporte por categor√≠a
            const categoryReport = document.getElementById('categoryReport');
            categoryReport.innerHTML = '';

            if (Object.keys(categorySales).length > 0) {
                Object.entries(categorySales)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, total]) => {
                        const percentage = (total / yearTotal * 100).toFixed(1);
                        categoryReport.innerHTML += `
                            <div style="margin: 10px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${category}</strong>
                                    <span>${formatGuaranies(total)} (${percentage}%)</span>
                                </div>
                                <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div style="background: #667eea; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    });
            } else {
                categoryReport.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No hay datos de ventas para mostrar</div></div>';
            }
        }

        // Exportar datos
        function exportData() {
            const data = {
                products: products,
                sales: sales,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `turista_paraguay_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            alert('‚úÖ Datos exportados correctamente');
        }

        // Generar reporte CSV
        function generateCSVReport() {
            let csv = 'Producto,Categor√≠a,Stock,Unidad,Precio,Valor Total\n';

            products.forEach(p => {
                csv += `"${p.name}","${p.category}",${p.stock},"${p.unit}",${p.price},${p.stock * p.price}\n`;
            });

            csv += '\n\nHistorial de Ventas\n';
            csv += 'Fecha,Producto,Cantidad,Unidad,Total,Cliente\n';

            sales.forEach(s => {
                const date = new Date(s.created_at).toLocaleString('es-PY');
                csv += `"${date}","${s.productName}",${s.quantity},"${s.unit}",${s.total},"${s.customer}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_turista_paraguay_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('‚úÖ Reporte CSV generado correctamente');
        }

        // ========================
        // GESTI√ìN DE CLIENTES
        // ========================

        // Generar c√≥digo autom√°tico de cliente
        function generateClientCode() {
            const prefix = 'CL';
            const existingCodes = clients.map(c => c.code);
            let number = 1;
            let code = '';

            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Abrir modal de cliente
        function openClientModal(clientId = null) {
            document.getElementById('clientModal').classList.add('active');
            document.getElementById('clientForm').reset();

            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                    document.getElementById('clientCode').value = client.code;
                    document.getElementById('clientDocType').value = client.docType;
                    const docInput = document.getElementById('clientDocNumber');
                    docInput.value = formatNumberWithDots(client.docNumber);
                    docInput.dataset.rawValue = client.docNumber;
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientCity').value = client.city;
                    document.getElementById('clientAddress').value = client.address || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    editingClientId = clientId;
                }
            } else {
                document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
                editingClientId = null;
                document.getElementById('clientCode').value = generateClientCode();
            }
        }

        // Cerrar modal de cliente
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingClientId = null;
        }

        // Guardar cliente
        async function saveClient(event) {
            event.preventDefault();

            const docInput = document.getElementById('clientDocNumber');
            const clientData = {
                code: document.getElementById('clientCode').value,
                docType: document.getElementById('clientDocType').value,
                docNumber: docInput.dataset.rawValue || docInput.value.replace(/./g, ''),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                city: document.getElementById('clientCity').value,
                address: document.getElementById('clientAddress').value,
                notes: document.getElementById('clientNotes').value
            };

            try {
                if (editingClientId) {
                    await updateClientInDB(editingClientId, clientData);
                    alert('‚úÖ Cliente actualizado correctamente');
                } else {
                    await saveClientToDB(clientData);
                    alert('‚úÖ Cliente registrado correctamente');
                }

                closeClientModal();
                await loadClients();
                await loadSalesForm();
            } catch (error) {
                alert('Error al guardar cliente: ' + error.message);
            }
        }

        // Cargar clientes
        async function loadClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            try {
                clients = await loadClientsFromDB();

                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div>No hay clientes registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openClientModal()">Agregar Primer Cliente</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                clients.forEach(client => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${client.code}</strong></td>
                            <td>${client.name}</td>
                            <td>${client.docType}: ${client.docNumber}</td>
                            <td>${client.phone}</td>
                            <td>${client.email || '-'}</td>
                            <td>${client.city}</td>
                            <td class="action-btns">
                                <button class="action-btn btn-warning" onclick="openClientModal(${client.id})">‚úèÔ∏è Editar</button>
                                <button class="action-btn btn-danger" onclick="deleteClient(${client.id})">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar clientes: ' + error.message);
            }
        }

        // Filtrar clientes
        function filterClients() {
            const search = document.getElementById('searchClients').value.toLowerCase();
            const rows = document.querySelectorAll('#clientsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Eliminar cliente
        async function deleteClient(clientId) {
            if (!confirm('¬øEst√°s seguro de eliminar este cliente?')) return;

            try {
                await deleteClientFromDB(clientId);
                await loadClients();
                await loadSalesForm();
                alert('‚úÖ Cliente eliminado correctamente');
            } catch (error) {
                alert('Error al eliminar cliente: ' + error.message);
            }
        }
    </script>

    <!-- MODAL DE CATEGOR√çAS -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gestionar Categor√≠as</h2>
                <span class="close-btn" onclick="closeCategoryModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px;">
                    <label>Nueva Categor√≠a</label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="newCategoryName" placeholder="Nombre de la categor√≠a" style="flex:1;">
                        <button class="btn btn-primary" onclick="addCategory()">‚ûï Agregar</button>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom:10px;">Categor√≠as actuales:</h3>
                    <div id="categoriesList" style="max-height:300px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    </body>
</html>
