<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=10.0, user-scalable=yes">
    <title>TURISTA PARAGUAY - Sistema de Inventario</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            max-width: 100%;
            overflow-x: hidden;
            /* Permitir zoom con dedos */
            touch-action: manipulation;
        }

        * {
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            max-width: 100%;
            width: 100%;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            /* Permitir zoom con dedos */
            touch-action: manipulation;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            overflow-x: hidden;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section {
            display: none;
            max-width: 100%;
            overflow-x: hidden;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .sales-filter-btn,
        .transformations-filter-btn {
            background: #f0f0f0;
            color: #333;
            border: 2px solid transparent;
        }

        .sales-filter-btn:hover,
        .transformations-filter-btn:hover {
            background: #e0e0e0;
        }

        .sales-filter-btn.active,
        .transformations-filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f5f5f5;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            color: #333;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #4CAF50;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-danger {
            background: #f44336;
            color: white;
        }

        .badge-info {
            background: #2196F3;
            color: white;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 500;
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .low-stock-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .unit-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            /* Layout general m√≥vil */
            * {
                max-width: 100%;
            }

            html, body {
                overflow-x: hidden !important;
                width: 100% !important;
                position: relative;
            }

            .container {
                padding: 10px;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .header {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                width: 100%;
            }

            .header h1 {
                font-size: 20px;
                text-align: center;
            }

            .logo {
                font-size: 20px;
            }

            /* Navegaci√≥n m√≥vil mejorada */
            .nav {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .nav-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                text-align: center;
                white-space: normal;
            }

            /* Formularios m√°s amigables */
            .form-group {
                width: 100%;
            }

            .form-group label {
                font-size: 13px;
                font-weight: 600;
            }

            input, select, textarea {
                font-size: 16px !important;
                padding: 12px;
                width: 100%;
                max-width: 100%;
            }

            /* Botones m√°s grandes para dedos */
            .btn {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 48px;
                width: 100%;
            }

            .action-btn {
                padding: 10px 14px;
                min-width: 44px;
                min-height: 44px;
            }

            /* Contenedores de botones en m√≥vil */
            .modal-content > form > div:last-child,
            .section > div > button {
                width: 100%;
            }

            /* Alinear botones de acci√≥n en filas verticales */
            .action-btns {
                display: flex;
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                width: 100%;
            }

            /* Otros botones de acci√≥n: ancho completo */
            .action-btns .action-btn {
                width: 100%;
                justify-content: center;
            }

            /* TODOS los contenedores flex con botones */
            div[style*="display: flex"],
            div[style*="display:flex"] {
                flex-wrap: wrap !important;
            }

            div[style*="display: flex"][style*="gap"],
            div[style*="display:flex"][style*="gap"] {
                flex-direction: column !important;
                gap: 10px !important;
                width: 100% !important;
            }

            div[style*="display: flex"] > button,
            div[style*="display:flex"] > button,
            div[style*="display: flex"] > .btn,
            div[style*="display:flex"] > .btn {
                width: 100% !important;
                flex: 1 1 100% !important;
            }

            /* Tablas responsivas - Vista de tarjetas en m√≥vil */
            .table-container {
                overflow-x: visible;
                width: 100%;
            }

            /* Ocultar cabecera de tabla en m√≥vil */
            table thead {
                display: none;
            }

            /* Tabla sin bordes ni estilos en m√≥vil */
            table {
                display: block;
                background: transparent;
                border: none;
                box-shadow: none;
            }

            /* Mostrar productos como tarjetas en m√≥vil */
            #productsTableBody {
                display: block !important;
            }

            #productsTableBody tr {
                display: grid;
                grid-template-columns: 1fr 70px;
                gap: 12px;
                background: white;
                border-radius: 10px;
                padding: 12px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                position: relative;
            }

            #productsTableBody td {
                display: block;
                padding: 3px 0;
                border: none;
                text-align: left;
                white-space: normal;
            }

            /* Ocultar columna de marca en m√≥vil */
            #productsTableBody .col-brand {
                display: none;
            }

            /* Imagen en tarjeta m√≥vil - segunda columna del grid (derecha) */
            #productsTableBody .col-image {
                grid-column: 2;
                grid-row: 1 / span 10;
                padding: 0;
                margin: 0;
                display: flex;
                align-items: flex-start;
                justify-content: flex-end;
            }

            #productsTableBody .col-image img {
                width: 70px !important;
                height: 70px !important;
                object-fit: cover;
                border-radius: 8px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.15) !important;
            }

            /* C√≥digo y Nombre destacados - primera columna */
            #productsTableBody .col-code {
                grid-column: 1;
                font-size: 12px;
                color: #667eea;
                font-weight: 700;
                margin-bottom: 2px;
                padding-right: 0;
            }

            #productsTableBody .col-name {
                grid-column: 1;
                font-size: 16px;
                font-weight: 600;
                color: #212529;
                margin-bottom: 8px;
                padding-right: 0;
            }

            /* Resto de columnas en la primera columna del grid */
            #productsTableBody .col-category,
            #productsTableBody .col-stock,
            #productsTableBody .col-price,
            #productsTableBody .col-status {
                grid-column: 1;
            }

            /* Botones ocupan ambas columnas */
            #productsTableBody .col-actions {
                grid-column: 1 / -1;
            }

            /* Agregar etiquetas antes de cada dato */
            #productsTableBody .col-category:before {
                content: "üìÇ ";
                font-weight: 600;
                color: #6c757d;
            }

            #productsTableBody .col-stock:before {
                content: "üì¶ Stock: ";
                font-weight: 600;
                color: #6c757d;
            }

            #productsTableBody .col-price:before {
                content: "üíµ Precio: ";
                font-weight: 600;
                color: #6c757d;
            }

            #productsTableBody .col-status {
                margin: 10px 0;
            }

            /* Botones de acci√≥n en tarjeta */
            #productsTableBody .col-actions {
                display: flex;
                gap: 6px;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #eee;
                justify-content: space-between;
            }

            #productsTableBody .action-btn {
                flex: 1;
                width: auto !important;
                padding: 12px 8px;
                font-size: 18px;
                text-align: center;
                min-height: 50px;
                max-width: none;
            }

            /* Ocultar texto de botones en m√≥vil, solo mostrar emojis */
            #productsTableBody .action-btn {
                font-size: 20px;
                line-height: 1;
            }

            #productsTableBody .action-btn::after {
                content: attr(data-label);
                display: block;
                font-size: 10px;
                margin-top: 4px;
                opacity: 0.8;
            }

            /* Mostrar clientes como tarjetas en m√≥vil */
            #clientsTableBody {
                display: block !important;
            }

            #clientsTableBody tr {
                display: block;
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                position: relative;
            }

            #clientsTableBody td {
                display: block;
                padding: 8px 0;
                border: none;
                text-align: left;
                white-space: normal;
            }

            /* C√≥digo destacado */
            #clientsTableBody .col-client-code {
                font-size: 12px;
                color: #667eea;
                font-weight: 700;
                margin-bottom: 5px;
            }

            /* Nombre destacado */
            #clientsTableBody .col-client-name {
                font-size: 16px;
                font-weight: 600;
                color: #212529;
                margin-bottom: 10px;
            }

            /* Agregar etiquetas antes de cada dato */
            #clientsTableBody .col-client-doc:before {
                content: "üÜî ";
                font-weight: 600;
                color: #6c757d;
            }

            #clientsTableBody .col-client-phone:before {
                content: "üì± ";
                font-weight: 600;
                color: #6c757d;
            }

            #clientsTableBody .col-client-email:before {
                content: "‚úâÔ∏è ";
                font-weight: 600;
                color: #6c757d;
            }

            #clientsTableBody .col-client-city:before {
                content: "üìç ";
                font-weight: 600;
                color: #6c757d;
            }

            /* Botones de acci√≥n en tarjeta */
            #clientsTableBody .col-client-actions {
                display: flex;
                gap: 8px;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #eee;
            }

            #clientsTableBody .action-btn {
                flex: 1;
                width: auto !important;
                padding: 10px 8px;
                font-size: 12px;
                text-align: center;
                min-height: 40px;
            }

            /* Mostrar historial de ventas como tarjetas en m√≥vil */
            #salesHistoryBody {
                display: block !important;
            }

            #salesHistoryBody tr {
                display: block;
                background: white;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                position: relative;
            }

            #salesHistoryBody td {
                display: block;
                padding: 8px 0;
                border: none;
                text-align: left;
                white-space: normal;
            }

            /* Ocultar marca en m√≥vil para ahorrar espacio */
            #salesHistoryBody .col-sale-brand {
                display: none;
            }

            /* Fecha destacada */
            #salesHistoryBody .col-sale-date {
                font-size: 11px;
                color: #667eea;
                font-weight: 600;
                margin-bottom: 5px;
            }

            /* Producto destacado */
            #salesHistoryBody .col-sale-product {
                font-size: 16px;
                font-weight: 600;
                color: #212529;
                margin-bottom: 10px;
            }

            /* Total destacado con badge */
            #salesHistoryBody .col-sale-total {
                background: #667eea;
                color: white;
                padding: 6px 10px !important;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 700;
                text-align: left;
                margin: 8px 0;
                display: block;
                word-break: break-word;
            }

            #salesHistoryBody .col-sale-total strong {
                color: white;
                font-size: 14px;
            }

            #salesHistoryBody .col-sale-total:before {
                content: "üí∞ Total: ";
                font-weight: 600;
            }

            /* Agregar etiquetas antes de cada dato */
            #salesHistoryBody .col-sale-quantity:before {
                content: "üì¶ Cantidad: ";
                font-weight: 600;
                color: #6c757d;
            }

            #salesHistoryBody .col-sale-customer:before {
                content: "üë§ Cliente: ";
                font-weight: 600;
                color: #6c757d;
            }

            /* Cards m√°s compactas */
            .stat-card {
                padding: 15px;
                width: 100%;
            }

            .stat-value {
                font-size: 20px !important;
            }

            /* Modal casi full screen en m√≥vil */
            .modal {
                padding: 5px;
            }

            .modal-content {
                width: 98% !important;
                max-width: 98% !important;
                margin: 5px auto;
                max-height: 95vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 15px;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-body {
                padding: 15px;
            }

            /* Selector de productos m√°s grande */
            .custom-select-button {
                padding: 14px;
                font-size: 15px;
                width: 100%;
            }

            .custom-dropdown {
                max-height: 60vh;
                overflow-y: auto;
            }

            .product-option {
                padding: 12px;
                min-height: 60px;
            }

            .product-option-image {
                width: 50px;
                height: 50px;
            }

            /* Toast m√°s visible en m√≥vil */
            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 14px;
            }

            /* Carrito m√°s compacto */
            #cartSection {
                padding: 15px;
                width: 100%;
            }

            #cartSection table {
                font-size: 11px;
            }

            /* Mejorar espaciado general */
            .section {
                padding: 15px;
                width: 100%;
                max-width: 100vw;
                margin-bottom: 15px;
                overflow-x: hidden;
            }

            h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            h3 {
                font-size: 16px;
            }

            /* Header de secciones con botones */
            .section > div[style*="display: flex"][style*="justify-content: space-between"],
            .section > div[style*="display:flex"][style*="justify-content:space-between"] {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: stretch !important;
            }

            .section > div[style*="display: flex"][style*="justify-content: space-between"] > h2,
            .section > div[style*="display:flex"][style*="justify-content:space-between"] > h2 {
                text-align: center;
            }

            /* Botones de carrito */
            #cartSection > div:last-child,
            #cartSection div[style*="display:flex"],
            #cartSection div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
                width: 100% !important;
            }

            #cartSection > div:last-child > button,
            #cartSection div[style*="display:flex"] > button,
            #cartSection div[style*="display: flex"] > button {
                width: 100% !important;
                flex: none !important;
            }

            /* Info boxes */
            .info-box {
                padding: 12px;
                font-size: 13px;
                margin-bottom: 15px;
            }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }

        /* Estilos para detalles del producto */
        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .product-detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .product-detail-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .product-detail-value {
            font-size: 16px;
            color: #212529;
            font-weight: 500;
        }

        .product-image-container {
            grid-column: 1 / -1;
            text-align: center;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .product-image-large {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .product-description-box {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .product-details-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
    
        /* Selector personalizado con im√°genes */
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        
        .custom-select-button {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .custom-select-button:hover {
            border-color: #667eea;
        }
        
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .product-option {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .product-option:hover {
            background: #f5f5f5;
        }
        
        .product-option:last-child {
            border-bottom: none;
        }
        
        .product-option-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 12px;
            border: 1px solid #ddd;
        }
        
        .product-option-no-image {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 5px;
            margin-right: 12px;
            font-size: 24px;
        }
        
        .product-option-info {
            flex: 1;
        }
        
        .product-option-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }
        
        .product-option-details {
            font-size: 12px;
            color: #666;
        }

        /* Estilos para vista previa de transformaci√≥n responsive */
        .transformation-preview-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }

        /* Tarjetas de historial de transformaciones */
        .transformation-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .transformation-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .transformation-card-date {
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        .transformation-card-quantity {
            background: #667eea;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .transformation-card-body {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }

        .transformation-card-product {
            text-align: center;
        }

        .transformation-card-product-code {
            font-weight: bold;
            font-size: 15px;
            color: #333;
            margin-bottom: 4px;
        }

        .transformation-card-product-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .transformation-card-stocks {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .transformation-card-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .transformation-card-stock-item:last-child {
            margin-bottom: 0;
        }

        .transformation-card-stock-label {
            font-size: 11px;
            color: #666;
        }

        .transformation-card-stock-value {
            font-weight: bold;
            font-size: 13px;
        }

        .transformation-card-arrow {
            font-size: 28px;
            color: #667eea;
        }

        .transformation-card-notes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .transformation-preview-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .transformation-preview-grid > div:nth-child(2) {
                transform: rotate(90deg);
                font-size: 24px;
            }

            .transformation-card-body {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .transformation-card-arrow {
                transform: rotate(90deg);
            }

            .transformation-card {
                padding: 15px;
            }

            /* Hacer tabla de historial scrolleable horizontalmente */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-width: 100%;
            }

            .table-container table {
                width: 100%;
                font-size: 12px;
            }

            .table-container th,
            .table-container td {
                padding: 8px 6px;
                white-space: normal;
            }

            /* Ajustar info boxes en historial para m√≥vil */
            .table-container td > div[style*="background: #fff3cd"],
            .table-container td > div[style*="background: #d4edda"] {
                padding: 6px !important;
                min-width: 100px;
            }

            .table-container td > div[style*="background: #fff3cd"] > div,
            .table-container td > div[style*="background: #d4edda"] > div {
                font-size: 10px !important;
            }

            /* T√≠tulo de secci√≥n m√°s peque√±o */
            #production h2 {
                font-size: 20px;
            }

            #production h3 {
                font-size: 16px;
            }

            /* Formulario de transformaci√≥n */
            #production .form-row {
                grid-template-columns: 1fr;
            }

            #production .info-box {
                font-size: 13px;
                padding: 12px;
            }
        }

        </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üáµüáæ TURISTA PARAGUAY - Sistema de Inventario</div>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">üè† Men√∫ Principal</button>
                <button class="nav-btn" onclick="showSection('products')">üì¶ Productos</button>
                <button class="nav-btn" onclick="showSection('production')">üîÑ Producci√≥n</button>
                <button class="nav-btn" onclick="showSection('pedidos')">üìù Pedidos</button>
                <button class="nav-btn" onclick="showSection('clients')">üë• Clientes</button>
                <button class="nav-btn" onclick="showSection('sales')">üí∞ Ventas</button>
                <button class="nav-btn" onclick="showSection('reports')">üìà Reportes</button>
            </div>
        </div>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 20px;">Men√∫ Principal</h2>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-warning" onclick="migrateLocalStorageToSupabase()" style="width: 100%;">Migrar Datos desde localStorage</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Productos</div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">en inventario</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valor Total Inventario</div>
                        <div class="stat-value" id="totalValue">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ventas Hoy</div>
                        <div class="stat-value" id="todaySales">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Bajo</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div class="stat-label">productos</div>
                    </div>
                </div>

                <div id="lowStockAlerts"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Productos M√°s Vendidos</h3>
                <div class="table-container">
                    <table id="topProductsTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Cantidad Vendida</th>
                                <th>Ingresos</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <div class="empty-state-icon">üì¶</div>
                                    <div>No hay datos de ventas a√∫n</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUCTOS -->
            <div id="products" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Productos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">‚ûï Agregar Producto</button>
                </div>

                <div class="info-box">
                    <div class="info-box-title">üí° Sistema con Unidades de Medida</div>
                    <div>Ahora puedes gestionar productos con diferentes unidades: unidades, metros, hojas, paquetes, litros, kilos, etc.</div>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchProducts" placeholder="üîç Buscar productos..." onkeyup="filterProducts()">
                    <select id="categoryFilter" onchange="filterProducts()">
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-code">C√≥digo</th>
                                <th class="col-name">Nombre</th>
                                <th class="col-brand">Marca</th>
                                <th class="col-category">Categor√≠a</th>
                                <th class="col-stock">Stock</th>
                                <th class="col-price">Precio de Venta</th>
                                <th class="col-image">Imagen</th>
                                <th class="col-status">Estado</th>
                                <th class="col-actions">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clients" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Clientes</h2>
                    <button class="btn btn-primary" onclick="openClientModal()">‚ûï Nuevo Cliente</button>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchClients" placeholder="üîç Buscar clientes por nombre, documento o tel√©fono..." onkeyup="filterClients()">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre Completo</th>
                                <th>Documento</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Ciudad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUCCI√ìN / TRANSFORMACI√ìN -->
            <div id="production" class="section">
                <h2 style="margin-bottom: 20px;">üîÑ Producci√≥n / Transformaci√≥n</h2>

                <div class="info-box" style="margin-bottom: 30px;">
                    <div class="info-box-title">üí° Sistema de Transformaci√≥n</div>
                    <div>Convierte insumos en productos finales. Por ejemplo: Taza blanca ‚Üí Taza con dise√±o</div>
                </div>

                <!-- Formulario de Transformaci√≥n -->
                <div style="background: #f9f9f9; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">‚ûï Nueva Transformaci√≥n</h3>

                    <form id="transformationForm" onsubmit="executeTransformation(event)">
                        <div class="form-row">
                            <!-- Buscador de Insumo Origen -->
                            <div class="form-group" style="position: relative;">
                                <label>üì¶ Buscar Insumo Origen *</label>
                                <input type="text" id="sourceProductSearch" placeholder="Buscar por c√≥digo o nombre..." autocomplete="off" oninput="searchSourceProducts()" onfocus="searchSourceProducts()" required>
                                <div id="sourceProductsDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                <input type="hidden" id="sourceProduct" required>
                                <div id="sourceStockInfo" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
                            </div>

                            <!-- Buscador de Producto Destino -->
                            <div class="form-group" style="position: relative;">
                                <label>üõçÔ∏è Buscar Producto Destino *</label>
                                <input type="text" id="targetProductSearch" placeholder="Buscar por c√≥digo o nombre..." autocomplete="off" oninput="searchTargetProducts()" onfocus="searchTargetProducts()" required>
                                <div id="targetProductsDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #28a745; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                <input type="hidden" id="targetProduct" required>
                                <div id="targetStockInfo" style="margin-top: 8px; font-size: 13px; color: #666;"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Cantidad a Transformar *</label>
                                <input type="number" id="transformQuantity" required min="1" step="1" placeholder="Cantidad" oninput="calculateTransformation()">
                            </div>
                            <div class="form-group">
                                <label>Notas (Opcional)</label>
                                <input type="text" id="transformNotes" placeholder="Ej: Lote 123, Dise√±o especial...">
                            </div>
                        </div>

                        <div id="transformationPreview" style="display: none; background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                            <h4 style="margin-top: 0; color: #667eea; font-size: 16px;">üìã Vista Previa</h4>
                            <div class="transformation-preview-grid">
                                <div style="text-align: center; padding: 12px; background: #fff3cd; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #856404; margin-bottom: 5px; font-weight: 600;">INSUMO</div>
                                    <div id="previewSourceName" style="font-weight: bold; margin-bottom: 5px; font-size: 13px;"></div>
                                    <div id="previewSourceStock" style="font-size: 12px; color: #666;"></div>
                                </div>
                                <div style="font-size: 20px; color: #667eea; text-align: center; display: flex; align-items: center; justify-content: center;">‚Üí</div>
                                <div style="text-align: center; padding: 12px; background: #d4edda; border-radius: 8px;">
                                    <div style="font-size: 11px; color: #155724; margin-bottom: 5px; font-weight: 600;">PRODUCTO</div>
                                    <div id="previewTargetName" style="font-weight: bold; margin-bottom: 5px; font-size: 13px;"></div>
                                    <div id="previewTargetStock" style="font-size: 12px; color: #666;"></div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">‚úÖ Ejecutar Transformaci√≥n</button>
                            <button type="button" class="btn" style="background: #6c757d; color: white;" onclick="resetTransformationForm()">üîÑ Limpiar</button>
                        </div>
                    </form>
                </div>

                <!-- Historial de Transformaciones -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin: 0;">üìú Historial de Transformaciones</h3>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm transformations-filter-btn active" onclick="filterTransformations('today')" data-filter="today">Hoy</button>
                        <button class="btn btn-sm transformations-filter-btn" onclick="filterTransformations('week')" data-filter="week">Esta Semana</button>
                        <button class="btn btn-sm transformations-filter-btn" onclick="filterTransformations('month')" data-filter="month">Este Mes</button>
                        <button class="btn btn-sm transformations-filter-btn" onclick="filterTransformations('all')" data-filter="all">Todas</button>
                    </div>
                </div>
                <div id="transformationsHistoryContainer">
                    <!-- Se llenar√° din√°micamente -->
                </div>
            </div>

            <!-- PEDIDOS -->
            <div id="pedidos" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>üìù Gesti√≥n de Pedidos</h2>
                    <button class="btn btn-primary" onclick="openNuevoPedidoModal()">‚ûï Nuevo Pedido</button>
                </div>

                <!-- Filtros de Pedidos -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="searchPedidos" placeholder="üîç Buscar por n√∫mero, cliente..." style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;" onkeyup="filterPedidos()">
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-sm pedidos-filter-btn active" onclick="filterPedidosByEstado('todos')" data-estado="todos">Todos</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('presupuesto')" data-estado="presupuesto" style="background: #6c757d;">Presupuesto</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('confirmado')" data-estado="confirmado" style="background: #007bff;">Confirmado</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('en_produccion')" data-estado="en_produccion" style="background: #ffc107; color: #333;">En Producci√≥n</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('listo')" data-estado="listo" style="background: #17a2b8;">Listo</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('entregado')" data-estado="entregado" style="background: #28a745;">Entregado</button>
                            <button class="btn btn-sm pedidos-filter-btn" onclick="filterPedidosByEstado('cancelado')" data-estado="cancelado" style="background: #dc3545;">Cancelado</button>
                        </div>
                    </div>
                </div>

                <!-- Listado de Pedidos -->
                <div id="pedidosListContainer" style="display: grid; gap: 15px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>

                <!-- Estado vac√≠o -->
                <div id="pedidosEmptyState" style="display: none; text-align: center; padding: 60px 20px; background: white; border-radius: 10px;">
                    <div style="font-size: 60px; margin-bottom: 15px;">üìù</div>
                    <h3 style="color: #666; margin-bottom: 10px;">No hay pedidos a√∫n</h3>
                    <p style="color: #999; margin-bottom: 20px;">Crea tu primer pedido o presupuesto haciendo clic en "Nuevo Pedido"</p>
                    <button class="btn btn-primary" onclick="openNuevoPedidoModal()">‚ûï Crear Primer Pedido</button>
                </div>
            </div>

            <!-- VENTAS -->
            <div id="sales" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Registrar Venta</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Seleccionar Producto</label>
                        <!-- Selector personalizado con im√°genes -->
                        <div class="custom-select-container">
                            <div id="customSelectButton" class="custom-select-button" onclick="toggleProductDropdown()">
                                <span id="selectedProductText">-- Seleccionar Producto --</span>
                                <span style="float:right;">‚ñº</span>
                            </div>
                            <div id="productDropdown" class="custom-dropdown" style="display:none;">
                                <input type="text" id="productSearchInput" placeholder="üîç Buscar producto..." onkeyup="filterProductOptions()" style="width:100%;padding:10px;border:none;border-bottom:2px solid #eee;box-sizing:border-box;">
                                <div id="productOptionsList" style="max-height:300px;overflow-y:auto;">
                                    <!-- Las opciones se cargan din√°micamente -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="saleProduct">
                    </div>
                    <div class="form-group">
                        <label>Cantidad <span id="saleUnitLabel"></span></label>
                        <input type="number" id="saleQuantity" min="1" step="1" value="1" onchange="updateSaleTotal()" onfocus="this.select()">
                    </div>
                </div>

                <!-- Preview de imagen del producto seleccionado -->
                <div id="saleProductImagePreview" style="display:none; margin-bottom:15px;">
                    <button type="button" onclick="toggleImagePreview()" style="width:100%; padding:8px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; transition:all 0.2s;">
                        <span style="font-size:13px; color:#495057; font-weight:500;">üì∏ Ver imagen de referencia</span>
                        <span id="imageToggleIcon" style="font-size:12px; color:#6c757d;">‚ñº</span>
                    </button>
                    <div id="imagePreviewContent" style="display:none; margin-top:10px; padding:10px; background:#f8f9fa; border-radius:6px; border-left:4px solid #667eea;">
                        <img id="saleProductImage" style="width:100%; max-width:300px; height:auto; border-radius:6px; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:block; margin:0 auto;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio Unitario</label>
                        <input type="text" id="salePrice" readonly style="text-align:left; font-weight:bold;">
                    </div>
                    <div class="form-group">
                        <label>Subtotal Item</label>
                        <input type="text" id="saleTotal" readonly style="font-weight:bold; font-size:18px; text-align:left;">
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addToCart()" style="width: 100%; font-size: 16px;">üõí Agregar al Carrito</button>
                </div>

                <!-- Carrito de Compras -->
                <div id="cartSection" style="display:none; background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
                    <h3 style="margin:0 0 15px 0;">üõí Carrito de Compras</h3>
                    <div class="table-container" style="margin-bottom:15px;">
                        <table style="font-size:14px;">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>P. Unit.</th>
                                    <th>Subtotal</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="cartItems">
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align:right; padding:10px; background:white; border-radius:5px; margin-bottom:15px;">
                        <strong style="font-size:18px;">Total Venta: <span id="cartTotal" style="color:#28a745;">Gs. 0</span></strong>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente *</label>
                            <select id="saleCustomer" required>
                                <option value="">-- Seleccionar Cliente --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn btn-primary" onclick="openClientModal()" style="width: 100%;">‚ûï Nuevo Cliente</button>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="completeSale()" style="flex: 1; font-size: 16px;">‚úÖ Completar Venta</button>
                        <button class="btn btn-danger" onclick="clearCart()" style="padding: 10px 20px;">üóëÔ∏è Vaciar</button>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 40px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin: 0;">Historial de Ventas</h3>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm sales-filter-btn active" onclick="filterSales('today')" data-filter="today">Hoy</button>
                        <button class="btn btn-sm sales-filter-btn" onclick="filterSales('week')" data-filter="week">Esta Semana</button>
                        <button class="btn btn-sm sales-filter-btn" onclick="filterSales('month')" data-filter="month">Este Mes</button>
                        <button class="btn btn-sm sales-filter-btn" onclick="filterSales('all')" data-filter="all">Todas</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Marca</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Cliente</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistoryBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reports" class="section">
                <h2 style="margin-bottom: 20px;">Reportes y Estad√≠sticas</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (Mes)</div>
                        <div class="stat-value" id="monthSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (A√±o)</div>
                        <div class="stat-value" id="yearSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Transacciones</div>
                        <div class="stat-value" id="totalSoldUnits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Categor√≠a M√°s Vendida</div>
                        <div class="stat-value" style="font-size: 24px;" id="topCategory">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Ventas por Categor√≠a</h3>
                    <div id="categoryReport"></div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="exportData()">üì• Exportar Datos (JSON)</button>
                    <button class="btn btn-warning" onclick="generateCSVReport()">üìä Exportar Reporte (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>

            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">

                <!-- Secci√≥n de vista previa del producto (solo visible en edici√≥n) -->
                <div id="productDetailView" style="display:none;background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <div style="display:grid;grid-template-columns:200px 1fr;gap:20px;align-items:start;">
                        <div>
                            <img id="detailProductImage" style="width:100%;border-radius:8px;border:2px solid #ddd;display:none;">
                            <div id="noImagePlaceholder" style="width:100%;height:200px;background:#e0e0e0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;">
                                üì¶ Sin imagen
                            </div>
                        </div>
                        <div>
                            <h3 id="detailProductName" style="margin:0 0 15px 0;color:#667eea;"></h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #ff6b6b;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üí∞ Precio de Compra</div>
                                    <div id="detailCostPrice" style="font-size:20px;font-weight:bold;color:#ff6b6b;"></div>
                                </div>
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #51cf66;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üíµ Precio de Venta</div>
                                    <div id="detailSalePrice" style="font-size:20px;font-weight:bold;color:#51cf66;"></div>
                                </div>
                            </div>
                            <div style="margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <div>
                                    <span style="font-size:12px;color:#666;">Stock:</span>
                                    <strong id="detailStock" style="margin-left:5px;"></strong>
                                </div>
                                <div>
                                    <span style="font-size:12px;color:#666;">Estado:</span>
                                    <span id="detailStatus" style="margin-left:5px;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Producto *</label>
                        <input type="text" id="productCode" required placeholder="Ej: TP-001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Producto *</label>
                        <select id="productType" required onchange="updatePriceRequirement()">
                            <option value="producto">Producto Final</option>
                            <option value="insumo">Insumo</option>
                            <option value="material">Material</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="max-width: 50%; margin: 0 auto;">
                    <label>Categor√≠a *</label>
                    <select id="productCategory" required>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="openCategoryModal()" style="margin-top:10px;width:100%;">‚öôÔ∏è Gestionar Categor√≠as</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="productName" required placeholder="Ej: Remera Paraguay" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Marca o Sucursal</label>
                        <input type="text" id="productBrand" placeholder="Ej: Nike, Adidas, Sucursal Centro (opcional)" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label>Stock *</label>
                        <input type="number" id="productStock" required min="0" step="1" placeholder="Cantidad" oninput="calcularValorTotal()">
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida *</label>
                        <select id="productUnit" required onchange="updateStockInputType(); calcularValorTotal()">
                            <option value="unidades">Unidades</option>
                            <option value="metros">Metros</option>
                            <option value="hojas">Hojas</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="litros">Litros</option>
                            <option value="kilos">Kilos</option>
                            <option value="gramos">Gramos</option>
                            <option value="cajas">Cajas</option>
                            <option value="rollos">Rollos</option>
                            <option value="pares">Pares</option>
                            <option value="docenas">Docenas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="productMinStock" min="0" step="1" value="3" placeholder="M√≠nimo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio de Costo (‚Ç≤)</label>
                        <input type="text" id="productCost" placeholder="Ej: 50.000" oninput="formatPriceInput(this); calcularValorTotal()">
                    </div>
                    <div class="form-group">
                        <label id="productPriceLabel">Precio de Venta (‚Ç≤) *</label>
                        <input type="text" id="productPrice" required placeholder="Ej: 100.000" oninput="formatPriceInput(this); calcularValorTotal()">
                    </div>
                </div>

                <!-- Valores Totales Calculados en Tiempo Real -->
                <div id="valoresTotalesContainer" style="display: none; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Valor Total de Compra -->
                        <div id="valorCostoContainer" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 20px; border-radius: 10px; text-align: center; display: none;">
                            <div style="color: white; font-size: 14px; margin-bottom: 5px; opacity: 0.9;">üí∞ Valor Total de Compra</div>
                            <div id="valorCostoDisplay" style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 8px;">‚Ç≤ 0</div>
                            <div id="valorCostoFormula" style="color: white; font-size: 12px; opacity: 0.8;"></div>
                        </div>
                        <!-- Valor Total de Venta -->
                        <div id="valorVentaContainer" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); padding: 20px; border-radius: 10px; text-align: center; display: none;">
                            <div style="color: white; font-size: 14px; margin-bottom: 5px; opacity: 0.9;">üíé Valor Total de Venta</div>
                            <div id="valorVentaDisplay" style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 8px;">‚Ç≤ 0</div>
                            <div id="valorVentaFormula" style="color: white; font-size: 12px; opacity: 0.8;"></div>
                        </div>
                    </div>
                    <!-- Ganancia Potencial -->
                    <div id="gananciaPotencialContainer" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; text-align: center; margin-top: 15px; display: none;">
                        <div style="color: white; font-size: 13px; margin-bottom: 3px; opacity: 0.9;">üìà Ganancia Potencial</div>
                        <div id="gananciaPotencialDisplay" style="color: white; font-size: 22px; font-weight: bold;">‚Ç≤ 0</div>
                    </div>
                </div>

               <!-- Campo de Foto -->
<div class="form-group">
    <label>üì∏ Foto del Producto (Opcional)</label>
    <div id="dropZone" style="border:2px dashed #ccc;border-radius:5px;padding:20px;text-align:center;background:#f9f9f9;margin-bottom:10px;cursor:pointer;"
         ondragenter="event.preventDefault();event.stopPropagation();this.style.background='#e3f2fd';"
         ondragover="event.preventDefault();event.stopPropagation();this.style.background='#e3f2fd';"
         ondragleave="event.preventDefault();event.stopPropagation();this.style.background='#f9f9f9';"
         ondrop="handleDrop(event)"
         onclick="document.getElementById('productImage').click()">
        <p style="margin:0;color:#666;">üñºÔ∏è Arrastra una imagen aqu√≠ o haz clic para seleccionar</p>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <input type="file" id="productImage" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('productImage').click()">üìÅ Subir Archivo</button>
        <button type="button" class="btn btn-primary" onclick="takePhoto()">üì∑ Tomar Foto</button>
    </div>
    <div id="imagePreview" style="margin-top:10px;display:none;">
        <img id="previewImg" style="max-width:200px;max-height:200px;border-radius:5px;border:2px solid #ddd;">
        <button type="button" class="btn btn-danger" onclick="clearImage()" style="display:block;margin-top:10px;width:200px;">üóëÔ∏è Eliminar Foto</button>
    </div>
</div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle">Agregar Cliente</h2>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Cliente *</label>
                        <input type="text" id="clientCode" required placeholder="CL-0001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Documento *</label>
                        <select id="clientDocType" required>
                            <option value="CI">C√©dula de Identidad</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero de Documento *</label>
                        <input type="text" id="clientDocNumber" required placeholder="Ej: 1.234.567" oninput="formatDocumentNumber(this)">
                    </div>
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="clientName" required placeholder="Nombre y Apellido" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="clientPhone" required placeholder="Ej: 0981234567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad *</label>
                        <input type="text" id="clientCity" required placeholder="Ej: Asunci√≥n" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="clientAddress" placeholder="Direcci√≥n completa" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="clientNotes" rows="2" placeholder="Notas adicionales (opcional)" oninput="capitalizeFirst(this)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar Cliente</button>
                    <button type="button" class="btn btn-danger" onclick="closeClientModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalles del Producto -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üì¶ Detalles del Producto</h2>
                <span class="close" onclick="closeProductDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="productDetailsContent">
                    <!-- El contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos con Supabase
        let products = [];
        let sales = [];
        let clients = [];
        let cart = []; // Carrito de compras temporal
        let transformations = []; // Historial de transformaciones
        let currentSalesFilter = 'today'; // Filtro de ventas: today, week, month, all
        let currentTransformationsFilter = 'today'; // Filtro de transformaciones: today, week, month, all

        // Funci√≥n para mostrar notificaciones toast
        function showToast(message, duration = 2000) {
            // Crear elemento toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>‚úÖ</span><span>${message}</span>`;

            // Agregar al body
            document.body.appendChild(toast);

            // Remover despu√©s de la duraci√≥n especificada
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300); // Tiempo de la animaci√≥n de salida
            }, duration);
        }

        // Variables globales
        let editingProductId = null;
        let editingClientId = null;
        let selectedImageFile = null;
        let currentCameraMode = 'environment'; // 'user' para frontal, 'environment' para trasera

        // Categor√≠as del sistema
        let categories = [];

        // Cargar categor√≠as desde Supabase
        async function loadCategories() {
            try {
                categories = await loadCategoriesFromDB();
                updateCategorySelects();
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
                // Usar categor√≠as predeterminadas si falla
                categories = [
                    'Remeras', 'Recuerdos', 'Botellas', 'Stickers',
                    'Gorras', 'Llaveros', 'Tazas', 'Materiales', 'Telas', 'Paquete de Regalo', 'Otros'
                ];
                updateCategorySelects();
            }
        }

        // Ya no se usa - las categor√≠as se guardan directamente en Supabase

        // Actualizar todos los selects de categor√≠as
        function updateCategorySelects() {
            // Select del formulario de productos
            const productCategorySelect = document.getElementById('productCategory');
            if (productCategorySelect) {
                const currentValue = productCategorySelect.value;
                productCategorySelect.innerHTML = '<option value="">-- Seleccionar --</option>';
                categories.forEach(cat => {
                    productCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentValue && categories.includes(currentValue)) {
                    productCategorySelect.value = currentValue;
                }
            }

            // Select del filtro
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                const currentFilter = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
                categories.forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentFilter && categories.includes(currentFilter)) {
                    categoryFilter.value = currentFilter;
                }
            }

            // Lista en el modal de gesti√≥n
            if (document.getElementById('categoriesList')) {
                updateCategoriesList();
            }
        }

        // Abrir modal de categor√≠as
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            updateCategoriesList();
        }

        // Cerrar modal de categor√≠as
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryName').value = '';
        }

        // Agregar nueva categor√≠a
        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre para la categor√≠a');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('‚ö†Ô∏è Esta categor√≠a ya existe');
                return;
            }

            try {
                await saveCategoryToDB(categoryName);
                categories.push(categoryName);
                categories.sort();
                updateCategorySelects();
                document.getElementById('newCategoryName').value = '';
                alert('‚úÖ Categor√≠a agregada correctamente');
            } catch (error) {
                alert('‚ùå Error al agregar categor√≠a: ' + error.message);
            }
        }

        // Eliminar categor√≠a
        async function deleteCategory(categoryName) {
            if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?

Nota: Los productos con esta categor√≠a no se eliminar√°n.`)) {
                return;
            }

            try {
                await deleteCategoryFromDB(categoryName);
                categories = categories.filter(cat => cat !== categoryName);
                updateCategorySelects();
                alert('‚úÖ Categor√≠a eliminada correctamente');
            } catch (error) {
                alert('‚ùå Error al eliminar categor√≠a: ' + error.message);
            }
        }

        // Actualizar lista de categor√≠as en el modal
        function updateCategoriesList() {
            const list = document.getElementById('categoriesList');
            if (!list) return;
            
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No hay categor√≠as</p>';
                return;
            }

            categories.forEach(cat => {
                list.innerHTML += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;">
                        <span style="font-weight:500;">${cat}</span>
                        <button class="btn btn-danger" onclick="deleteCategory('${cat}')" style="padding:5px 10px;font-size:12px;">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            });
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCategories();
            await loadProducts();
            await loadSales();
            await loadClients();
            await loadTransformations();
            await loadPedidos();
            await updateDashboard();
            await updateReports();
        });

        // Navegaci√≥n
        async function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'dashboard') await updateDashboard();
            if (sectionName === 'products') await loadProducts();
            if (sectionName === 'production') await loadProductionForm();
            if (sectionName === 'clients') await loadClients();
            if (sectionName === 'sales') await loadSalesForm();
            if (sectionName === 'reports') await updateReports();
            if (sectionName === 'pedidos') await loadPedidos();
        }

        // Generar c√≥digo autom√°tico √∫nico
        function generateProductCode() {
            const prefix = 'TP';
            const existingCodes = products.map(p => p.code);
            let number = 1;
            let code = '';

            // Buscar el siguiente n√∫mero disponible
            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Modal de productos
        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();

            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('modalTitle').textContent = 'Editar Producto';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productCode').value = product.code;
                    document.getElementById('productType').value = product.type || 'producto';
                    updatePriceRequirement(); // Actualizar requerimiento del precio
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand || '';
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productUnit').value = product.unit || 'unidades';
                    document.getElementById('productCost').value = product.cost ? product.cost.toLocaleString('de-DE') : '';
                    document.getElementById('productPrice').value = product.price.toLocaleString('de-DE');
                    document.getElementById('productMinStock').value = product.minStock || 3;

                    // Campo description es opcional, puede no existir
                    const descField = document.getElementById('productDescription');
                    if (descField) {
                        descField.value = product.description || '';
                    }

                    editingProductId = productId;

                    // Calcular valores totales si estamos editando
                    calcularValorTotal();

                    // Mostrar vista detallada del producto
                    document.getElementById('productDetailView').style.display = 'block';
                    document.getElementById('detailProductName').textContent = product.name + (product.brand ? ` - ${product.brand}` : '');
                    document.getElementById('detailCostPrice').textContent = formatGuaranies(product.cost || 0);
                    document.getElementById('detailSalePrice').textContent = formatGuaranies(product.price);
                    document.getElementById('detailStock').textContent = formatUnit(product.stock, product.unit);

                    // Calcular estado
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';
                    document.getElementById('detailStatus').innerHTML = stockStatus;

                    // Mostrar imagen en la vista detallada
                    if (product.imageUrl) {
                        document.getElementById('detailProductImage').src = product.imageUrl;
                        document.getElementById('detailProductImage').style.display = 'block';
                        document.getElementById('noImagePlaceholder').style.display = 'none';

                        // Tambi√©n en el preview del formulario
                        document.getElementById('previewImg').src = product.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('detailProductImage').style.display = 'none';
                        document.getElementById('noImagePlaceholder').style.display = 'flex';
                    }
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Agregar Producto';
                document.getElementById('productDetailView').style.display = 'none';
                editingProductId = null;
                // Generar c√≥digo autom√°tico para producto nuevo
                document.getElementById('productCode').value = generateProductCode();
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
            clearImage();
        }

        // Actualizar requerimiento del precio seg√∫n el tipo de producto
        function updatePriceRequirement() {
            const productType = document.getElementById('productType').value;
            const priceInput = document.getElementById('productPrice');
            const priceLabel = document.getElementById('productPriceLabel');

            if (productType === 'insumo' || productType === 'material') {
                // Para insumos y materiales, el precio es opcional
                priceInput.removeAttribute('required');
                priceLabel.textContent = 'Precio de Venta (‚Ç≤) - Opcional';
                priceInput.placeholder = 'Ej: 100.000 (opcional si no se vende)';
            } else {
                // Para productos finales, el precio es obligatorio
                priceInput.setAttribute('required', 'required');
                priceLabel.textContent = 'Precio de Venta (‚Ç≤) *';
                priceInput.placeholder = 'Ej: 100.000';
            }
        }

        // Actualizar tipo de input de stock seg√∫n la unidad de medida
        function updateStockInputType() {
            const unitSelect = document.getElementById('productUnit');
            const stockInput = document.getElementById('productStock');
            const minStockInput = document.getElementById('productMinStock');
            const selectedUnit = unitSelect.value;

            // Unidades que permiten decimales
            const decimalUnits = ['metros', 'litros', 'kilos', 'gramos'];

            if (decimalUnits.includes(selectedUnit)) {
                // Permitir decimales (step 0.01 = hasta 2 decimales)
                stockInput.step = '0.01';
                minStockInput.step = '0.01';
                stockInput.placeholder = 'Ej: 2.5';
                // Cambiar stock m√≠nimo por defecto a 0.50 para unidades decimales
                if (minStockInput.value == '3' || minStockInput.value == '') {
                    minStockInput.value = '0.50';
                }
            } else {
                // Solo n√∫meros enteros
                stockInput.step = '1';
                minStockInput.step = '1';
                stockInput.placeholder = 'Cantidad';
                // Cambiar stock m√≠nimo por defecto a 3 para unidades enteras
                if (minStockInput.value == '0.50' || minStockInput.value == '') {
                    minStockInput.value = '3';
                }
            }
        }

        // Calcular y mostrar valor total en tiempo real
        function calcularValorTotal() {
            const stockInput = document.getElementById('productStock');
            const costInput = document.getElementById('productCost');
            const priceInput = document.getElementById('productPrice');
            const unitSelect = document.getElementById('productUnit');

            const mainContainer = document.getElementById('valoresTotalesContainer');
            const costoContainer = document.getElementById('valorCostoContainer');
            const ventaContainer = document.getElementById('valorVentaContainer');
            const gananciaContainer = document.getElementById('gananciaPotencialContainer');

            // Obtener valores
            const stock = parseFloat(stockInput.value) || 0;
            const costStr = costInput.value.replace(/\./g, ''); // Eliminar puntos
            const cost = parseFloat(costStr) || 0;
            const priceStr = priceInput.value.replace(/\./g, ''); // Eliminar puntos
            const price = parseFloat(priceStr) || 0;
            const unit = unitSelect.value;

            let hasVisibleCard = false;

            // Calcular y mostrar VALOR DE COMPRA (costo √ó stock)
            if (stock > 0 && cost > 0) {
                const totalCosto = stock * cost;
                const unitText = formatUnit(stock, unit);

                document.getElementById('valorCostoDisplay').textContent = formatGuaranies(totalCosto);
                document.getElementById('valorCostoFormula').textContent = `${unitText} √ó ${formatGuaranies(cost)}`;
                costoContainer.style.display = 'block';
                hasVisibleCard = true;
            } else {
                costoContainer.style.display = 'none';
            }

            // Calcular y mostrar VALOR DE VENTA (precio √ó stock)
            if (stock > 0 && price > 0) {
                const totalVenta = stock * price;
                const unitText = formatUnit(stock, unit);

                document.getElementById('valorVentaDisplay').textContent = formatGuaranies(totalVenta);
                document.getElementById('valorVentaFormula').textContent = `${unitText} √ó ${formatGuaranies(price)}`;
                ventaContainer.style.display = 'block';
                hasVisibleCard = true;
            } else {
                ventaContainer.style.display = 'none';
            }

            // Calcular y mostrar GANANCIA POTENCIAL (solo si hay ambos valores)
            if (stock > 0 && cost > 0 && price > 0) {
                const totalCosto = stock * cost;
                const totalVenta = stock * price;
                const ganancia = totalVenta - totalCosto;

                document.getElementById('gananciaPotencialDisplay').textContent = formatGuaranies(ganancia);
                gananciaContainer.style.display = 'block';
                hasVisibleCard = true;
            } else {
                gananciaContainer.style.display = 'none';
            }

            // Mostrar u ocultar el contenedor principal
            mainContainer.style.display = hasVisibleCard ? 'block' : 'none';
        }

        // Guardar producto
        async function saveProduct(event) {
            event.preventDefault();

            const productType = document.getElementById('productType').value;
            const priceValue = document.getElementById('productPrice').value;

            const productData = {
                code: document.getElementById('productCode').value,
                type: productType,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value || '',
                category: document.getElementById('productCategory').value,
                stock: parseFloat(document.getElementById('productStock').value),
                unit: document.getElementById('productUnit').value,
                cost: parseFormattedPrice(document.getElementById('productCost').value),
                price: priceValue ? parseFormattedPrice(priceValue) : 0,
                minStock: parseFloat(document.getElementById('productMinStock').value) || 3,
                description: document.getElementById('productDescription')?.value || ''
            };

            // Si hay imagen, subirla primero
            if (selectedImageFile && productData.code) {
                const imageUrl = await uploadProductImage(selectedImageFile, productData.code);
                if (imageUrl) {
                    productData.imageUrl = imageUrl;
                }
            }

            try {

                // Obtener el ID del producto del campo oculto o de la variable global

                const productId = document.getElementById('productId').value || editingProductId;

                if (productId) {

                    // Modo edici√≥n - actualizar producto existente
                    await updateProductInDB(parseInt(productId), productData);
                    alert('‚úÖ Producto actualizado correctamente');
                    closeProductModal();
                } else {

                    // Modo creaci√≥n - crear nuevo producto

                    await saveProductToDB(productData);
                    alert('‚úÖ Producto agregado correctamente');

                    // Limpiar formulario para agregar otro producto r√°pidamente
                    document.getElementById('productForm').reset();
                    document.getElementById('productCode').value = generateProductCode();
                    document.getElementById('productUnit').value = 'unidades';
                    document.getElementById('productMinStock').value = 3;
                    document.getElementById('productName').focus();
                    clearImage();
                }

                await loadProducts();
                await updateDashboard();
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al guardar producto: ' + error.message);
            }
        }

        // Formatear guaran√≠es con separador de miles (punto decimal)
        function formatGuaranies(amount) {
            if (amount === null || amount === undefined || amount === '') return 'Gs. 0';
            // Convertir a n√∫mero y redondear
            const num = Math.round(Number(amount));
            // Convertir a string
            let str = num.toString();
            // Aplicar separador de miles (punto)
            str = str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const result = `Gs. ${str}`;
            console.log(`formatGuaranies(${amount}) = ${result}`); // DEBUG
            return result;
        }

        // Capitalizar primera letra
        function capitalizeFirst(input) {
            if (input.value.length > 0) {
                input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
            }
        }



        // Formatear n√∫mero con puntos (auxiliar)
        function formatNumberWithDots(number) {
            if (!number) return '';
            const str = number.toString();
            return str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Formatear n√∫mero de documento con puntos
        function formatDocumentNumber(input) {
            // Obtener solo n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Aplicar formato con puntos cada 3 d√≠gitos
            if (value.length > 0) {
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            input.value = value;
            // Guardar valor sin formato en data attribute
            input.dataset.rawValue = value.replace(/\./g, '');
        }

        // ===== FUNCIONES PARA MANEJO DE FOTOS =====
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                return;
            }

            // Validar formato
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('‚ùå Formato no v√°lido. Usa JPG, PNG o WEBP.');
                return;
            }

            selectedImageFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            // Restaurar estilo
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.style.background = '#f9f9f9';
            }

            // Verificar que hay archivos
            if (!event.dataTransfer || !event.dataTransfer.files) {
                console.log('No se encontraron archivos en el evento');
                return;
            }

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Validar que sea imagen
                if (!file.type.match('image.*')) {
                    alert('‚ùå Por favor arrastra una imagen');
                    return;
                }

                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                    return;
                }

                selectedImageFile = file;

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        async function takePhoto() {
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo acceder a la c√°mara: ' + error.message);
            }
        }

        async function startCamera() {
            // Detener stream anterior si existe
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }

            // Constraints mejorados para mejor calidad
            const constraints = {
                video: {
                    facingMode: currentCameraMode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    aspectRatio: { ideal: 4/3 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Si ya existe el modal, solo actualizar el video
            if (window.cameraModal) {
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                window.currentStream = stream;
                return;
            }

            // Crear modal con video mejorado y controles profesionales
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
                    <div style="background:white;padding:20px;border-radius:15px;max-width:650px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);position:relative;">
                        <button onclick="closeCamera()" style="position:absolute;top:15px;right:15px;background:transparent;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">√ó</button>
                        <h3 style="margin:0 0 15px 0;text-align:center;color:#333;">üì∏ Tomar Fotograf√≠a</h3>

                        <!-- Vista previa de c√°mara -->
                        <div style="position:relative;background:#000;border-radius:10px;overflow:hidden;">
                            <video id="cameraVideo" autoplay playsinline style="width:100%;height:auto;display:block;touch-action:none;"></video>

                            <!-- Grilla de ayuda compositiva (regla de tercios) -->
                            <div id="gridOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;">
                                <svg width="100%" height="100%" style="position:absolute;top:0;left:0;">
                                    <line x1="33.33%" y1="0" x2="33.33%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="66.66%" y1="0" x2="66.66%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="33.33%" x2="100%" y2="33.33%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="66.66%" x2="100%" y2="66.66%" stroke="white" stroke-width="1" opacity="0.3"/>
                                </svg>
                            </div>

                            <!-- Marco de enfoque central -->
                            <div id="focusFrame" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70%;height:70%;border:2px solid rgba(255,255,255,0.5);border-radius:10px;pointer-events:none;"></div>

                            <!-- Efecto flash -->
                            <div id="captureFlash" style="position:absolute;top:0;left:0;width:100%;height:100%;background:white;opacity:0;pointer-events:none;transition:opacity 0.1s;"></div>

                            <!-- Indicador de c√°mara activa -->
                            <div style="position:absolute;top:10px;left:10px;background:rgba(255,0,0,0.8);color:white;padding:5px 10px;border-radius:15px;font-size:12px;font-weight:bold;">
                                ‚óè REC
                            </div>

                            <!-- Informaci√≥n de resoluci√≥n -->
                            <div id="resolutionInfo" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:5px 10px;border-radius:5px;font-size:11px;"></div>
                        </div>

                        <!-- Controles de c√°mara -->
                        <div style="margin-top:15px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="gridToggle" onchange="toggleGrid(this.checked)" style="cursor:pointer;">
                                Grilla
                            </label>
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="focusFrameToggle" checked onchange="toggleFocusFrame(this.checked)" style="cursor:pointer;">
                                Marco
                            </label>
                            <div style="flex:1;"></div>
                            <span style="font-size:12px;color:#666;">Zoom:</span>
                            <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1" onchange="adjustZoom(this.value)" style="width:100px;cursor:pointer;">
                            <span id="zoomValue" style="font-size:12px;color:#666;min-width:35px;">1.0x</span>
                        </div>

                        <!-- Botones principales -->
                        <div style="margin-top:20px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="capturePhoto()" style="flex:1;min-width:140px;font-size:16px;padding:12px;">üì∏ Capturar</button>
                            <button class="btn btn-secondary" onclick="flipCamera()" style="padding:12px 20px;">üîÑ C√°mara</button>
                            <button class="btn btn-danger" onclick="closeCamera()" style="padding:12px 20px;">‚ùå Cerrar</button>
                        </div>

                        <p style="margin:10px 0 0 0;text-align:center;font-size:11px;color:#999;">
                            üí° Centra el producto en el marco ‚Ä¢ Usa buena iluminaci√≥n ‚Ä¢ Mant√©n el dispositivo estable
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;

            // Mostrar informaci√≥n de resoluci√≥n cuando el video est√© listo
            video.addEventListener('loadedmetadata', () => {
                const resInfo = document.getElementById('resolutionInfo');
                if (resInfo) {
                    resInfo.textContent = `${video.videoWidth}x${video.videoHeight}`;
                }

                // Verificar si el dispositivo soporta zoom
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    const zoomSlider = document.getElementById('zoomSlider');
                    zoomSlider.min = capabilities.zoom.min || 1;
                    zoomSlider.max = capabilities.zoom.max || 3;
                    zoomSlider.step = capabilities.zoom.step || 0.1;
                }
            });

            window.currentStream = stream;
            window.cameraModal = modal;

            // Agregar Pinch-to-Zoom con gestos t√°ctiles
            let initialPinchDistance = 0;
            let initialZoomValue = 1;

            video.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialPinchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    const zoomSlider = document.getElementById('zoomSlider');
                    initialZoomValue = parseFloat(zoomSlider.value);
                }
            }, { passive: false });

            video.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );

                    const scale = currentDistance / initialPinchDistance;
                    const newZoom = Math.max(1, Math.min(3, initialZoomValue * scale));

                    const zoomSlider = document.getElementById('zoomSlider');
                    zoomSlider.value = newZoom;
                    adjustZoom(newZoom);
                }
            }, { passive: false });

            // Agregar atajo de teclado para capturar (Espacio)
            window.cameraKeyHandler = (e) => {
                if (e.code === 'Space' && window.cameraModal) {
                    e.preventDefault();
                    capturePhoto();
                } else if (e.code === 'Escape' && window.cameraModal) {
                    e.preventDefault();
                    closeCamera();
                }
            };
            document.addEventListener('keydown', window.cameraKeyHandler);
        }

        // Funci√≥n para alternar grilla de composici√≥n
        function toggleGrid(show) {
            const grid = document.getElementById('gridOverlay');
            if (grid) {
                grid.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para alternar marco de enfoque
        function toggleFocusFrame(show) {
            const frame = document.getElementById('focusFrame');
            if (frame) {
                frame.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para ajustar zoom
        function adjustZoom(value) {
            const zoomValueDisplay = document.getElementById('zoomValue');
            if (zoomValueDisplay) {
                zoomValueDisplay.textContent = parseFloat(value).toFixed(1) + 'x';
            }

            if (window.currentStream) {
                const track = window.currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    track.applyConstraints({
                        advanced: [{ zoom: parseFloat(value) }]
                    }).catch(err => {
                        console.log('Zoom no soportado:', err);
                    });
                } else {
                    // Fallback: zoom digital mediante CSS transform
                    const video = document.getElementById('cameraVideo');
                    if (video) {
                        video.style.transform = `scale(${value})`;
                        video.style.transformOrigin = 'center center';
                    }
                }
            }
        }

        async function flipCamera() {
            // Cambiar entre frontal y trasera
            currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo cambiar la c√°mara: ' + error.message);
                // Volver al modo anterior si falla
                currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');

            // Usar resoluci√≥n del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Efecto flash visual
            const flash = document.getElementById('captureFlash');
            if (flash) {
                flash.style.opacity = '0.7';
                setTimeout(() => flash.style.opacity = '0', 100);
            }

            // Comprimir imagen para tama√±o √≥ptimo
            // Si la imagen es muy grande, redimensionar
            let finalCanvas = canvas;
            const maxDimension = 1600; // M√°ximo ancho o alto

            if (canvas.width > maxDimension || canvas.height > maxDimension) {
                finalCanvas = document.createElement('canvas');
                const scale = Math.min(maxDimension / canvas.width, maxDimension / canvas.height);
                finalCanvas.width = canvas.width * scale;
                finalCanvas.height = canvas.height * scale;

                const finalCtx = finalCanvas.getContext('2d');
                finalCtx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
            }

            // Convertir a blob con calidad ajustada (0.85 = 85% calidad)
            finalCanvas.toBlob((blob) => {
                // Verificar tama√±o del archivo
                const sizeMB = blob.size / (1024 * 1024);
                console.log(`Tama√±o de imagen: ${sizeMB.toFixed(2)} MB`);

                if (sizeMB > 5) {
                    alert('‚ö†Ô∏è La imagen es muy grande. Intenta con mejor iluminaci√≥n o m√°s cerca del producto.');
                    return;
                }

                selectedImageFile = new File([blob], 'photo.jpg', { type: 'image/jpeg' });

                document.getElementById('previewImg').src = finalCanvas.toDataURL('image/jpeg', 0.85);
                document.getElementById('imagePreview').style.display = 'block';

                closeCamera();
            }, 'image/jpeg', 0.85);
        }

        function closeCamera() {
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
                window.currentStream = null;
            }
            if (window.cameraModal) {
                window.cameraModal.remove();
                window.cameraModal = null;
            }
            // Remover listener de teclado
            if (window.cameraKeyHandler) {
                document.removeEventListener('keydown', window.cameraKeyHandler);
                window.cameraKeyHandler = null;
            }
            // Resetear zoom
            currentCameraMode = 'environment';
        }

        function clearImage() {
            selectedImageFile = null;
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function showImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;" onclick="this.parentElement.remove()">
                    <div style="max-width:90%;max-height:90%;text-align:center;">
                        <img src="${imageUrl}" style="max-width:100%;max-height:90vh;border-radius:10px;">
                        <p style="color:white;margin-top:10px;">Click para cerrar</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Formatear input de precio con punto decimal
        function formatPriceInput(input) {
            // Remover todo excepto n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Si est√° vac√≠o, dejar vac√≠o
            if (value === '') {
                input.value = '';
                return;
            }

            // Convertir a n√∫mero
            let num = parseInt(value, 10);

            // Formatear con puntos
            input.value = num.toLocaleString('de-DE'); // Usa formato alem√°n que tiene punto como separador
        }

        // Convertir precio formateado a n√∫mero
        function parseFormattedPrice(formattedValue) {
            if (!formattedValue || formattedValue === '') return 0;
            // Remover puntos y convertir a n√∫mero
            return parseFloat(formattedValue.replace(/\./g, '')) || 0;
        }

        // Formatear unidad de medida
        function formatUnit(quantity, unit) {
            const formatted = parseFloat(quantity).toFixed(2).replace(/\.?0+$/, '');
            return `${formatted} ${unit}`;
        }

        // Cargar productos
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            try {
                products = await loadProductsFromDB();

                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <div>No hay productos registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openProductModal()">Agregar Primer Producto</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
                products.sort((a, b) => {
                    const dateA = new Date(a.created_at || 0);
                    const dateB = new Date(b.created_at || 0);
                    return dateB - dateA; // Descendente (m√°s nuevo primero)
                });

                products.forEach(product => {
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';

                    const brandCell = product.brand ? `<td>${product.brand}</td>` : '<td><em style="color: #999;">-</em></td>';

                    const brandCellWithClass = product.brand ? `<td class="col-brand">${product.brand}</td>` : '<td class="col-brand"><em style="color: #999;">-</em></td>';

                    tbody.innerHTML += `
                        <tr>
                            <td class="col-code"><strong>${product.code}</strong></td>
                            <td class="col-name">${product.name}</td>
                            ${brandCellWithClass}
                            <td class="col-category">${product.category}</td>
                            <td class="col-stock"><strong>${formatUnit(product.stock, product.unit)}</strong></td>
                            <td class="col-price"><strong>${formatGuaranies(product.price)}</strong></td>
                            <td class="col-image">${product.imageUrl ? `<img src="${product.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;cursor:pointer;" onclick='showImageModal("${product.imageUrl}")'>` : '‚ùå'}</td>
                            <td class="col-status">${stockStatus}</td>
                            <td class="col-actions action-btns">
                                <button class="action-btn btn-info" onclick="showProductDetails(${product.id})" style="background: #17a2b8;" data-label="Ver">üëÅÔ∏è</button>
                                <button class="action-btn btn-primary" onclick="openProductModal(${product.id})" data-label="Editar">‚úèÔ∏è</button>
                                <button class="action-btn btn-danger" onclick="deleteProduct(${product.id})" data-label="Borrar">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            }
        }

        // Eliminar producto
        async function deleteProduct(productId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
                try {
                    await deleteProductFromDB(productId);
                    await loadProducts();
                    await updateDashboard();
                    alert('‚úÖ Producto eliminado correctamente');
                } catch (error) {
                    alert('Error al eliminar producto: ' + error.message);
                }
            }
        }

        // Filtrar productos
        function filterProducts() {
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            const rows = document.querySelectorAll('#productsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                // Categor√≠a est√° en la columna 3 (√≠ndice 3): C√≥digo, Nombre, Marca, Categor√≠a
                const category = row.children[3]?.textContent || '';

                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;

                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }


        // ===== FUNCIONES PARA SELECTOR PERSONALIZADO DE PRODUCTOS =====
        
        function toggleProductDropdown() {
            const dropdown = document.getElementById('productDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeProductDropdown() {
            document.getElementById('productDropdown').style.display = 'none';
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.custom-select-container');
            if (container && !container.contains(event.target)) {
                closeProductDropdown();
            }
        });
        
        // Toggle de vista previa de imagen
        function toggleImagePreview() {
            const content = document.getElementById('imagePreviewContent');
            const icon = document.getElementById('imageToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Actualizar campo oculto
            document.getElementById('saleProduct').value = productId;

            // Actualizar texto del bot√≥n
            document.getElementById('selectedProductText').textContent = product.name + ' (' + formatUnit(product.stock, product.unit) + ')';

            // Mostrar imagen del producto si existe
            const imagePreview = document.getElementById('saleProductImagePreview');
            const imageElement = document.getElementById('saleProductImage');

            if (product.imageUrl) {
                imageElement.src = product.imageUrl;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // Cerrar dropdown
            closeProductDropdown();

            // Actualizar precio
            updateSalePrice();
        }
        
        function filterProductOptions() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const options = document.querySelectorAll('.product-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function loadProductOptions() {
            const optionsList = document.getElementById('productOptionsList');
            optionsList.innerHTML = '';
            
            // Filtrar solo productos con stock
            const availableProducts = products.filter(p => p.stock > 0);
            
            if (availableProducts.length === 0) {
                optionsList.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No hay productos disponibles</div>';
                return;
            }
            
            availableProducts.forEach(product => {
                const option = document.createElement('div');
                option.className = 'product-option';
                option.onclick = () => selectProduct(product.id);
                
                // Imagen o placeholder
                let imageHTML = '';
                if (product.imageUrl && product.imageUrl.trim() !== '') {
                    imageHTML = `<img src="${product.imageUrl}" class="product-option-image" alt="${product.name}">`;
                } else {
                    imageHTML = '<div class="product-option-no-image">üì¶</div>';
                }
                
                option.innerHTML = `
                    ${imageHTML}
                    <div class="product-option-info">
                        <div class="product-option-name">${product.name}</div>
                        <div class="product-option-details">
                            Stock: ${formatUnit(product.stock, product.unit)} | Precio: ${formatGuaranies(product.price)}
                        </div>
                    </div>
                `;
                
                optionsList.appendChild(option);
            });
        }

        // Cargar formulario de ventas
        async function loadSalesForm() {
            // Cargar productos en selector personalizado
            loadProductOptions();

            // Cargar clientes
            const selectCustomer = document.getElementById('saleCustomer');
            selectCustomer.innerHTML = '<option value="">-- Seleccionar Cliente --</option>';

            clients.forEach(client => {
                selectCustomer.innerHTML += `<option value="${client.id}">${client.name} - ${client.docType}: ${formatNumberWithDots(client.docNumber)}</option>`;
            });

            await loadSalesHistory();
        }

        // Actualizar precio de venta
        function updateSalePrice() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                document.getElementById('salePrice').value = formatGuaranies(product.price);
                document.getElementById('salePrice').dataset.rawValue = product.price; // Guardar valor num√©rico
                document.getElementById('saleUnitLabel').textContent = `(${product.unit})`;
                updateSaleTotal();
            } else {
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleUnitLabel').textContent = '';
            }
        }

        // Actualizar total de venta
        function updateSaleTotal() {
            const priceElement = document.getElementById('salePrice');
            const price = parseFloat(priceElement.dataset.rawValue) || 0;
            const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('saleTotal').value = formatGuaranies(total);
            document.getElementById('saleTotal').dataset.rawValue = total; // Guardar valor num√©rico
        }

        // ===== FUNCIONES DEL CARRITO DE COMPRAS =====

        // Agregar producto al carrito
        function addToCart() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseFloat(document.getElementById('saleQuantity').value);

            if (!productId || !quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            const product = products.find(p => p.id === productId);

            if (quantity > product.stock) {
                alert(`‚ö†Ô∏è No hay suficiente stock disponible. Stock actual: ${formatUnit(product.stock, product.unit)}`);
                return;
            }

            // Verificar si el producto ya est√° en el carrito
            const existingItem = cart.find(item => item.productId === productId);

            if (existingItem) {
                // Si ya existe, actualizar cantidad
                const newQuantity = existingItem.quantity + quantity;
                if (newQuantity > product.stock) {
                    alert(`‚ö†Ô∏è No hay suficiente stock. Stock disponible: ${formatUnit(product.stock, product.unit)}`);
                    return;
                }
                existingItem.quantity = newQuantity;
                existingItem.subtotal = existingItem.price * newQuantity;
            } else {
                // Agregar nuevo item al carrito
                cart.push({
                    productId: product.id,
                    productName: product.name,
                    productBrand: product.brand || '',
                    category: product.category,
                    quantity: quantity,
                    unit: product.unit,
                    price: product.price,
                    subtotal: product.price * quantity,
                    stock: product.stock
                });
            }

            // Limpiar selecci√≥n de producto
            document.getElementById('saleProduct').value = '';
            document.getElementById('selectedProductText').textContent = '-- Seleccionar Producto --';
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('salePrice').value = '';
            document.getElementById('saleTotal').value = '';
            document.getElementById('saleUnitLabel').textContent = '';
            // Ocultar y resetear imagen
            document.getElementById('saleProductImagePreview').style.display = 'none';
            document.getElementById('imagePreviewContent').style.display = 'none';
            document.getElementById('imageToggleIcon').textContent = '‚ñº';

            // Actualizar vista del carrito
            updateCartView();

            // Mostrar notificaci√≥n
            showToast('Producto agregado al carrito');
        }

        // Actualizar vista del carrito
        function updateCartView() {
            const cartItemsBody = document.getElementById('cartItems');
            const cartSection = document.getElementById('cartSection');
            const cartTotalSpan = document.getElementById('cartTotal');

            if (cart.length === 0) {
                cartSection.style.display = 'none';
                return;
            }

            cartSection.style.display = 'block';
            cartItemsBody.innerHTML = '';

            let total = 0;

            cart.forEach((item, index) => {
                total += item.subtotal;

                cartItemsBody.innerHTML += `
                    <tr>
                        <td><strong>${item.productName}</strong>${item.productBrand ? '<br><small>' + item.productBrand + '</small>' : ''}</td>
                        <td>${formatUnit(item.quantity, item.unit)}</td>
                        <td>${formatGuaranies(item.price)}</td>
                        <td><strong>${formatGuaranies(item.subtotal)}</strong></td>
                        <td class="action-btns">
                            <button class="action-btn btn-danger" onclick="removeFromCart(${index})" style="padding:5px 10px;font-size:12px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            cartTotalSpan.textContent = formatGuaranies(total);
        }

        // Remover item del carrito
        function removeFromCart(index) {
            const item = cart[index];
            if (confirm(`¬øEliminar ${item.productName} del carrito?`)) {
                cart.splice(index, 1);
                updateCartView();
            }
        }

        // Vaciar carrito
        function clearCart() {
            if (cart.length === 0) return;

            if (confirm('¬øEst√°s seguro de vaciar el carrito?')) {
                cart = [];
                updateCartView();
            }
        }

        // Completar venta con m√∫ltiples productos
        async function completeSale() {
            const customerId = parseInt(document.getElementById('saleCustomer').value);

            if (cart.length === 0) {
                alert('‚ö†Ô∏è El carrito est√° vac√≠o. Agrega productos antes de completar la venta.');
                return;
            }

            if (!customerId) {
                alert('‚ö†Ô∏è Por favor selecciona un cliente');
                return;
            }

            const client = clients.find(c => c.id == customerId);

            try {
                // Registrar cada producto del carrito como una venta individual
                for (const item of cart) {
                    const saleData = {
                        productId: item.productId,
                        productName: item.productName,
                        productBrand: item.productBrand,
                        category: item.category,
                        quantity: item.quantity,
                        unit: item.unit,
                        price: item.price,
                        total: item.subtotal,
                        customerId: client.id,
                        customer: client.name,
                        customerDoc: `${client.docType}: ${formatNumberWithDots(client.docNumber)}`
                    };

                    // Guardar venta
                    await saveSaleToDB(saleData);

                    // Actualizar stock del producto
                    const newStock = item.stock - item.quantity;
                    await updateProductInDB(item.productId, { stock: newStock });
                }

                const totalVenta = cart.reduce((sum, item) => sum + item.subtotal, 0);
                alert(`‚úÖ Venta completada exitosamente!\n\nTotal: ${formatGuaranies(totalVenta)}\nProductos: ${cart.length}\nCliente: ${client.name}`);

                // Limpiar carrito y formulario
                cart = [];
                updateCartView();
                document.getElementById('saleCustomer').value = '';

                // Recargar datos
                await loadProducts();
                await loadSales();
                await loadSalesForm();
                await updateDashboard();
            } catch (error) {
                alert('Error al completar la venta: ' + error.message);
            }
        }

        // Registrar venta (mantener para compatibilidad, pero ya no se usa)
        async function registerSale() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseFloat(document.getElementById('saleQuantity').value);
            const customerId = parseInt(document.getElementById('saleCustomer').value);

            if (!productId || !quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            if (!customerId) {
                alert('‚ö†Ô∏è Por favor selecciona un cliente');
                return;
            }

            const product = products.find(p => p.id === productId);
            const client = clients.find(c => c.id == customerId);

            if (quantity > product.stock) {
                alert(`‚ö†Ô∏è No hay suficiente stock disponible. Stock actual: ${formatUnit(product.stock, product.unit)}`);
                return;
            }

            const saleData = {
                productId: productId,
                productName: product.name,
                productBrand: product.brand || '',
                category: product.category,
                quantity: quantity,
                unit: product.unit,
                price: product.price,
                total: product.price * quantity,
                customerId: client.id,
                customer: client.name,
                customerDoc: `${client.docType}: ${client.docNumber}`
            };

            try {
                // Guardar venta
                await saveSaleToDB(saleData);

                // Actualizar stock del producto
                const newStock = product.stock - quantity;
                await updateProductInDB(productId, { stock: newStock });

                alert('‚úÖ Venta registrada exitosamente');

                // Limpiar formulario
                document.getElementById('saleProduct').value = '';
                document.getElementById('selectedProductText').textContent = '-- Seleccionar Producto --';
                document.getElementById('saleQuantity').value = 1;
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleCustomer').value = '';
                document.getElementById('saleUnitLabel').textContent = '';
                document.getElementById('saleProductImagePreview').style.display = 'none';
                document.getElementById('imagePreviewContent').style.display = 'none';
                document.getElementById('imageToggleIcon').textContent = '‚ñº';

                await loadProducts();
                await loadSalesForm();
                await updateDashboard();
            } catch (error) {
                alert('Error al registrar venta: ' + error.message);
            }
        }

        // Cargar historial de ventas
        async function loadSalesHistory() {
            const tbody = document.getElementById('salesHistoryBody');
            tbody.innerHTML = '';

            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <div>No hay ventas registradas</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Filtrar ventas seg√∫n el filtro activo
            let filteredSales = [...sales];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (currentSalesFilter === 'today') {
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.created_at);
                    const saleDateOnly = new Date(saleDate.getFullYear(), saleDate.getMonth(), saleDate.getDate());
                    return saleDateOnly.getTime() === today.getTime();
                });
            } else if (currentSalesFilter === 'week') {
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(today.getDate() - 7);
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.created_at);
                    return saleDate >= oneWeekAgo;
                });
            } else if (currentSalesFilter === 'month') {
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(today.getMonth() - 1);
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.created_at);
                    return saleDate >= oneMonthAgo;
                });
            }
            // Si es 'all', no filtramos

            if (filteredSales.length === 0) {
                let message = 'No hay ventas ';
                if (currentSalesFilter === 'today') message += 'hoy';
                else if (currentSalesFilter === 'week') message += 'esta semana';
                else if (currentSalesFilter === 'month') message += 'este mes';
                else message += 'registradas';

                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <div>${message}</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Mostrar ventas filtradas (m√°s recientes primero)
            const recentSales = [...filteredSales].reverse();

            recentSales.forEach(sale => {
                const date = new Date(sale.created_at);
                const formattedDate = date.toLocaleString('es-PY', {
                    timeZone: 'America/Asuncion',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const brandCell = sale.productBrand ? `<td class="col-sale-brand">${sale.productBrand}</td>` : '<td class="col-sale-brand"><em style="color: #999;">Sin marca</em></td>';
                tbody.innerHTML += `
                    <tr>
                        <td class="col-sale-date">${formattedDate}</td>
                        <td class="col-sale-product">${sale.productName}</td>
                        ${brandCell}
                        <td class="col-sale-quantity">${formatUnit(sale.quantity, sale.unit)}</td>
                        <td class="col-sale-total"><strong>${formatGuaranies(sale.total)}</strong></td>
                        <td class="col-sale-customer">${sale.customer}</td>
                    </tr>
                `;
            });
        }

        // Filtrar ventas por per√≠odo
        function filterSales(filter) {
            currentSalesFilter = filter;

            // Actualizar botones activos
            document.querySelectorAll('.sales-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            // Recargar historial con el nuevo filtro
            loadSalesHistory();
        }

        // Cargar ventas
        async function loadSales() {
            try {
                sales = await loadSalesFromDB();
                await loadSalesHistory();
            } catch (error) {
                alert('Error al cargar ventas: ' + error.message);
            }
        }

        // Actualizar dashboard
        async function updateDashboard() {
            // Total productos
            document.getElementById('totalProducts').textContent = products.length;

            // Valor total inventario (basado en precio de costo)
            const totalValue = products.reduce((sum, p) => sum + (p.stock * (p.cost || 0)), 0);
            document.getElementById('totalValue').textContent = formatGuaranies(totalValue);

            // Ventas de hoy - usar formato de fecha simple para comparaci√≥n
            const today = new Date();
            const todayStr = today.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' });

            const todaySales = sales.filter(s => {
                const saleDate = new Date(s.created_at || s.date);
                const saleDateStr = saleDate.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' });
                return saleDateStr === todayStr;
            });
            const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('todaySales').textContent = formatGuaranies(todayTotal);

            // Debug: mostrar en consola
            console.log('Fecha de hoy:', todayStr);
            console.log('Ventas totales:', sales.length);
            console.log('Ventas de hoy:', todaySales.length, 'Total:', todayTotal);
            if (sales.length > 0) {
                const ultimaVenta = sales[sales.length - 1];
                const ultimaFecha = new Date(ultimaVenta.created_at || ultimaVenta.date);
                console.log('√öltima venta fecha:', ultimaFecha.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' }));
            }

            // Stock bajo
            const lowStock = products.filter(p => p.stock <= p.minStock);
            document.getElementById('lowStockCount').textContent = lowStock.length;

            // Alertas de stock bajo
            const alertsDiv = document.getElementById('lowStockAlerts');
            alertsDiv.innerHTML = '';

            if (lowStock.length > 0) {
                alertsDiv.innerHTML = `
                    <div class="low-stock-alert">
                        <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Alertas de Stock Bajo</h3>
                        ${lowStock.map(p => `
                            <div style="margin: 5px 0;">
                                <strong>${p.name}</strong> - Solo quedan ${formatUnit(p.stock, p.unit)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Productos m√°s vendidos
            const productSales = {};
            sales.forEach(sale => {
                if (!productSales[sale.productId]) {
                    productSales[sale.productId] = {
                        name: sale.productName,
                        category: sale.category,
                        units: 0,
                        unit: sale.unit,
                        revenue: 0
                    };
                }
                productSales[sale.productId].units += sale.quantity;
                productSales[sale.productId].revenue += sale.total;
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';

            if (topProducts.length > 0) {
                topProducts.forEach(p => {
                    topBody.innerHTML += `
                        <tr>
                            <td><strong>${p.name}</strong></td>
                            <td>${p.category}</td>
                            <td>${formatUnit(p.units, p.unit)}</td>
                            <td><strong>${formatGuaranies(p.revenue)}</strong></td>
                        </tr>
                    `;
                });
            } else {
                topBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div>No hay datos de ventas a√∫n</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Actualizar reportes
        async function updateReports() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Ventas del mes
            const monthSales = sales.filter(s => {
                const saleDate = new Date(s.created_at);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthTotal = monthSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('monthSales').textContent = formatGuaranies(monthTotal);

            // Ventas del a√±o
            const yearSales = sales.filter(s => new Date(s.created_at).getFullYear() === currentYear);
            const yearTotal = yearSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('yearSales').textContent = formatGuaranies(yearTotal);

            // Total transacciones
            document.getElementById('totalSoldUnits').textContent = sales.length;

            // Categor√≠a m√°s vendida
            const categorySales = {};
            sales.forEach(s => {
                if (!categorySales[s.category]) categorySales[s.category] = 0;
                categorySales[s.category] += s.total;
            });

            const topCategory = Object.entries(categorySales)
                .sort((a, b) => b[1] - a[1])[0];

            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';

            // Reporte por categor√≠a
            const categoryReport = document.getElementById('categoryReport');
            categoryReport.innerHTML = '';

            if (Object.keys(categorySales).length > 0) {
                Object.entries(categorySales)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, total]) => {
                        const percentage = (total / yearTotal * 100).toFixed(1);
                        categoryReport.innerHTML += `
                            <div style="margin: 10px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${category}</strong>
                                    <span>${formatGuaranies(total)} (${percentage}%)</span>
                                </div>
                                <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div style="background: #667eea; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    });
            } else {
                categoryReport.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No hay datos de ventas para mostrar</div></div>';
            }
        }

        // Exportar datos
        function exportData() {
            const data = {
                products: products,
                sales: sales,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `turista_paraguay_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            alert('‚úÖ Datos exportados correctamente');
        }

        // Generar reporte CSV
        function generateCSVReport() {
            let csv = 'Producto,Categor√≠a,Stock,Unidad,Precio,Valor Total\n';

            products.forEach(p => {
                csv += `"${p.name}","${p.category}",${p.stock},"${p.unit}",${p.price},${p.stock * p.price}\n`;
            });

            csv += '\n\nHistorial de Ventas\n';
            csv += 'Fecha,Producto,Cantidad,Unidad,Total,Cliente\n';

            sales.forEach(s => {
                const date = new Date(s.created_at).toLocaleString('es-PY');
                csv += `"${date}","${s.productName}",${s.quantity},"${s.unit}",${s.total},"${s.customer}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_turista_paraguay_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('‚úÖ Reporte CSV generado correctamente');
        }

        // ========================
        // GESTI√ìN DE CLIENTES
        // ========================

        // Generar c√≥digo autom√°tico de cliente
        function generateClientCode() {
            const prefix = 'CL';
            const existingCodes = clients.map(c => c.code);
            let number = 1;
            let code = '';

            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Abrir modal de cliente
        function openClientModal(clientId = null) {
            document.getElementById('clientModal').classList.add('active');
            document.getElementById('clientForm').reset();

            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                    document.getElementById('clientCode').value = client.code;
                    document.getElementById('clientDocType').value = client.docType;
                    const docInput = document.getElementById('clientDocNumber');
                    docInput.value = formatNumberWithDots(client.docNumber);
                    docInput.dataset.rawValue = client.docNumber;
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientCity').value = client.city;
                    document.getElementById('clientAddress').value = client.address || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    editingClientId = clientId;
                }
            } else {
                document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
                editingClientId = null;
                document.getElementById('clientCode').value = generateClientCode();
            }
        }

        // Cerrar modal de cliente
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingClientId = null;
        }

        // Abrir modal de detalles del producto
        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const stockStatus = product.stock <= product.minStock ?
                '<span class="badge badge-danger">‚ö†Ô∏è Stock Bajo</span>' :
                product.stock <= product.minStock * 2 ?
                '<span class="badge badge-warning">‚ö° Stock Medio</span>' :
                '<span class="badge badge-success">‚úÖ Stock OK</span>';

            const productTypeLabel =
                product.type === 'insumo' ? '<span class="badge badge-warning">üì¶ Insumo</span>' :
                product.type === 'material' ? '<span class="badge badge-secondary">üî® Material</span>' :
                '<span class="badge badge-info">üõçÔ∏è Producto Final</span>';

            const content = `
                <!-- Fila especial con C√≥digo, Imagen y Nombre -->
                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="product-detail-item">
                        <div class="product-detail-label">üìù C√≥digo</div>
                        <div class="product-detail-value">${product.code}</div>
                    </div>

                    ${product.imageUrl ? `
                        <div class="product-detail-item" style="display: flex; align-items: center; justify-content: center; background: #fff; border: 2px dashed #dee2e6; min-width: 150px;">
                            <img src="${product.imageUrl}" alt="${product.name}" onclick='showImageModal("${product.imageUrl}")' style="max-width: 100%; max-height: 150px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        </div>
                    ` : '<div class="product-detail-item" style="display: flex; align-items: center; justify-content: center; background: #f8f9fa; min-width: 150px;"><span style="font-size: 40px; color: #ccc;">üì∑</span></div>'}

                    <div class="product-detail-item">
                        <div class="product-detail-label">üè∑Ô∏è Nombre</div>
                        <div class="product-detail-value">${product.name}</div>
                    </div>
                </div>

                <!-- Tipo de Producto -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <div class="product-detail-label" style="margin-bottom: 8px;">Tipo de Producto</div>
                    <div>${productTypeLabel}</div>
                </div>

                <div class="product-details-grid">

                    ${product.brand ? `
                        <div class="product-detail-item">
                            <div class="product-detail-label">üé® Marca</div>
                            <div class="product-detail-value">${product.brand}</div>
                        </div>
                    ` : ''}

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìÇ Categor√≠a</div>
                        <div class="product-detail-value">${product.category}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üì¶ Stock Actual</div>
                        <div class="product-detail-value">${formatUnit(product.stock, product.unit)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">‚ö†Ô∏è Stock M√≠nimo</div>
                        <div class="product-detail-value">${formatUnit(product.minStock, product.unit)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üí∞ Precio de Costo</div>
                        <div class="product-detail-value">${formatGuaranies(product.cost)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üíµ Precio de Venta</div>
                        <div class="product-detail-value" style="color: #28a745; font-size: 18px; font-weight: 700;">${formatGuaranies(product.price)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìä Estado de Stock</div>
                        <div class="product-detail-value">${stockStatus}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìà Margen de Ganancia</div>
                        <div class="product-detail-value" style="color: #667eea;">
                            ${formatGuaranies(product.price - product.cost)}
                            <small style="color: #6c757d;">(${(((product.price - product.cost) / product.cost) * 100).toFixed(1)}%)</small>
                        </div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üí∞ Valor Total de Compra</div>
                        <div class="product-detail-value" style="color: #ff6b6b; font-size: 18px; font-weight: 700;">
                            ${formatGuaranies(product.stock * (product.cost || 0))}
                            <small style="color: #6c757d; display: block; font-size: 12px; margin-top: 4px;">
                                ${formatUnit(product.stock, product.unit)} √ó ${formatGuaranies(product.cost || 0)}
                            </small>
                        </div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üíé Valor Total de Venta</div>
                        <div class="product-detail-value" style="color: #28a745; font-size: 18px; font-weight: 700;">
                            ${formatGuaranies(product.stock * product.price)}
                            <small style="color: #6c757d; display: block; font-size: 12px; margin-top: 4px;">
                                ${formatUnit(product.stock, product.unit)} √ó ${formatGuaranies(product.price)}
                            </small>
                        </div>
                    </div>

                    ${product.description ? `
                        <div class="product-description-box">
                            <div class="product-detail-label">üìÑ Descripci√≥n</div>
                            <div class="product-detail-value" style="font-size: 14px; line-height: 1.6; margin-top: 8px;">
                                ${product.description}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                    <button class="btn btn-primary" onclick="closeProductDetailsModal(); setTimeout(() => openProductModal(${product.id}), 100);" style="flex: 1;">
                        ‚úèÔ∏è Editar Producto
                    </button>
                    <button class="btn btn-secondary" onclick="closeProductDetailsModal()">
                        ‚ùå Cerrar
                    </button>
                </div>
            `;

            document.getElementById('productDetailsContent').innerHTML = content;
            document.getElementById('productDetailsModal').classList.add('active');
        }

        function closeProductDetailsModal() {
            document.getElementById('productDetailsModal').classList.remove('active');
        }

        // Guardar cliente
        async function saveClient(event) {
            event.preventDefault();

            const docInput = document.getElementById('clientDocNumber');
            const clientData = {
                code: document.getElementById('clientCode').value,
                docType: document.getElementById('clientDocType').value,
                docNumber: docInput.dataset.rawValue || docInput.value.replace(/./g, ''),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                city: document.getElementById('clientCity').value,
                address: document.getElementById('clientAddress').value,
                notes: document.getElementById('clientNotes').value
            };

            try {
                if (editingClientId) {
                    await updateClientInDB(editingClientId, clientData);
                    alert('‚úÖ Cliente actualizado correctamente');
                } else {
                    await saveClientToDB(clientData);
                    alert('‚úÖ Cliente registrado correctamente');
                }

                closeClientModal();
                await loadClients();
                await loadSalesForm();
            } catch (error) {
                alert('Error al guardar cliente: ' + error.message);
            }
        }

        // Cargar clientes
        async function loadClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            try {
                clients = await loadClientsFromDB();

                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div>No hay clientes registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openClientModal()">Agregar Primer Cliente</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                clients.forEach(client => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="col-client-code"><strong>${client.code}</strong></td>
                            <td class="col-client-name">${client.name}</td>
                            <td class="col-client-doc">${client.docType}: ${formatNumberWithDots(client.docNumber)}</td>
                            <td class="col-client-phone">${client.phone}</td>
                            <td class="col-client-email">${client.email || '-'}</td>
                            <td class="col-client-city">${client.city}</td>
                            <td class="col-client-actions">
                                <button class="action-btn btn-warning" onclick="openClientModal(${client.id})">‚úèÔ∏è Editar</button>
                                <button class="action-btn btn-danger" onclick="deleteClient(${client.id})">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar clientes: ' + error.message);
            }
        }

        // Filtrar clientes
        function filterClients() {
            const search = document.getElementById('searchClients').value.toLowerCase().trim();
            const searchNumbers = search.replace(/\D/g, ''); // B√∫squeda sin puntos ni caracteres especiales
            const rows = document.querySelectorAll('#clientsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const textNumbers = text.replace(/\D/g, ''); // Texto sin puntos ni caracteres especiales

                // Buscar tanto en texto normal como en n√∫meros sin formato
                const matchesText = text.includes(search);
                const matchesNumbers = searchNumbers.length > 0 && textNumbers.includes(searchNumbers);

                row.style.display = (matchesText || matchesNumbers) ? '' : 'none';
            });
        }

        // Eliminar cliente
        async function deleteClient(clientId) {
            if (!confirm('¬øEst√°s seguro de eliminar este cliente?')) return;

            try {
                await deleteClientFromDB(clientId);
                await loadClients();
                await loadSalesForm();
                alert('‚úÖ Cliente eliminado correctamente');
            } catch (error) {
                alert('Error al eliminar cliente: ' + error.message);
            }
        }

        // ==================== M√ìDULO DE TRANSFORMACI√ìN / PRODUCCI√ìN ====================

        // Cargar productos en los selectores de transformaci√≥n (ya no se usa, pero lo dejamos por compatibilidad)
        async function loadProductionForm() {
            // Funci√≥n vac√≠a, los buscadores cargan din√°micamente
        }

        // Buscar insumos origen
        function searchSourceProducts() {
            const searchInput = document.getElementById('sourceProductSearch');
            const dropdown = document.getElementById('sourceProductsDropdown');
            const searchTerm = searchInput.value.toLowerCase();

            // Filtrar solo insumos
            const insumos = products.filter(p => p.type === 'insumo');

            if (searchTerm.length === 0) {
                // Mostrar todos los insumos
                const filtered = insumos;
                displaySourceDropdown(filtered);
            } else {
                // Filtrar por b√∫squeda
                const filtered = insumos.filter(p =>
                    p.code.toLowerCase().includes(searchTerm) ||
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.brand && p.brand.toLowerCase().includes(searchTerm))
                );
                displaySourceDropdown(filtered);
            }
        }

        function displaySourceDropdown(filteredProducts) {
            const dropdown = document.getElementById('sourceProductsDropdown');

            if (filteredProducts.length === 0) {
                dropdown.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No se encontraron insumos</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = filteredProducts.map(product => {
                const stockBadge = product.stock <= product.minStock ? 'badge-danger' :
                                  product.stock <= product.minStock * 2 ? 'badge-warning' : 'badge-success';
                return `
                    <div onclick="selectSourceProduct(${product.id})" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 12px;"
                         onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                        ${product.imageUrl ?
                            `<img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">` :
                            `<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 24px;">üì¶</span>
                            </div>`
                        }
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">${product.code} - ${product.name}</div>
                            <div style="font-size: 12px; color: #666;">${product.brand || ''} ${product.brand ? '‚Ä¢' : ''} <span class="badge ${stockBadge}" style="font-size: 11px;">Stock: ${product.stock} ${product.unit}</span></div>
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        }

        function selectSourceProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('sourceProductSearch').value = `${product.code} - ${product.name}`;
            document.getElementById('sourceProduct').value = productId;
            document.getElementById('sourceProductsDropdown').style.display = 'none';

            updateSourceStock();
        }

        // Buscar productos destino
        function searchTargetProducts() {
            const searchInput = document.getElementById('targetProductSearch');
            const dropdown = document.getElementById('targetProductsDropdown');
            const searchTerm = searchInput.value.toLowerCase();

            // Filtrar solo productos finales
            const productosFinales = products.filter(p => p.type === 'producto');

            if (searchTerm.length === 0) {
                // Mostrar todos los productos
                const filtered = productosFinales;
                displayTargetDropdown(filtered);
            } else {
                // Filtrar por b√∫squeda
                const filtered = productosFinales.filter(p =>
                    p.code.toLowerCase().includes(searchTerm) ||
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.brand && p.brand.toLowerCase().includes(searchTerm))
                );
                displayTargetDropdown(filtered);
            }
        }

        function displayTargetDropdown(filteredProducts) {
            const dropdown = document.getElementById('targetProductsDropdown');

            if (filteredProducts.length === 0) {
                dropdown.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No se encontraron productos</div>';
                dropdown.style.display = 'block';
                return;
            }

            dropdown.innerHTML = filteredProducts.map(product => {
                const stockBadge = product.stock <= product.minStock ? 'badge-danger' :
                                  product.stock <= product.minStock * 2 ? 'badge-warning' : 'badge-success';
                return `
                    <div onclick="selectTargetProduct(${product.id})" style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 12px;"
                         onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
                        ${product.imageUrl ?
                            `<img src="${product.imageUrl}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">` :
                            `<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                <span style="font-size: 24px;">üõçÔ∏è</span>
                            </div>`
                        }
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 14px;">${product.code} - ${product.name}</div>
                            <div style="font-size: 12px; color: #666;">${product.brand || ''} ${product.brand ? '‚Ä¢' : ''} <span class="badge ${stockBadge}" style="font-size: 11px;">Stock: ${product.stock} ${product.unit}</span></div>
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
        }

        function selectTargetProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('targetProductSearch').value = `${product.code} - ${product.name}`;
            document.getElementById('targetProduct').value = productId;
            document.getElementById('targetProductsDropdown').style.display = 'none';

            updateTargetStock();
        }

        // Cerrar dropdowns al hacer click fuera
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#sourceProductSearch') && !event.target.closest('#sourceProductsDropdown')) {
                document.getElementById('sourceProductsDropdown').style.display = 'none';
            }
            if (!event.target.closest('#targetProductSearch') && !event.target.closest('#targetProductsDropdown')) {
                document.getElementById('targetProductsDropdown').style.display = 'none';
            }
        });

        // Actualizar informaci√≥n de stock del producto origen
        function updateSourceStock() {
            const sourceId = document.getElementById('sourceProduct').value;
            const infoDiv = document.getElementById('sourceStockInfo');

            if (!sourceId) {
                infoDiv.textContent = '';
                return;
            }

            const product = products.find(p => p.id == sourceId);
            if (product) {
                infoDiv.innerHTML = `üì¶ <strong>Stock disponible:</strong> ${product.stock} ${product.unit}`;
                infoDiv.style.color = product.stock > 0 ? '#28a745' : '#dc3545';
            }

            calculateTransformation();
        }

        // Actualizar informaci√≥n de stock del producto destino
        function updateTargetStock() {
            const targetId = document.getElementById('targetProduct').value;
            const infoDiv = document.getElementById('targetStockInfo');

            if (!targetId) {
                infoDiv.textContent = '';
                return;
            }

            const product = products.find(p => p.id == targetId);
            if (product) {
                infoDiv.innerHTML = `üì¶ <strong>Stock actual:</strong> ${product.stock} ${product.unit}`;
                infoDiv.style.color = '#666';
            }

            calculateTransformation();
        }

        // Calcular y mostrar vista previa de la transformaci√≥n
        function calculateTransformation() {
            const sourceId = document.getElementById('sourceProduct').value;
            const targetId = document.getElementById('targetProduct').value;
            const quantity = parseInt(document.getElementById('transformQuantity').value) || 0;

            const previewDiv = document.getElementById('transformationPreview');

            if (!sourceId || !targetId || quantity <= 0) {
                previewDiv.style.display = 'none';
                return;
            }

            const sourceProduct = products.find(p => p.id == sourceId);
            const targetProduct = products.find(p => p.id == targetId);

            if (!sourceProduct || !targetProduct) {
                previewDiv.style.display = 'none';
                return;
            }

            // Calcular stocks resultantes
            const newSourceStock = sourceProduct.stock - quantity;
            const newTargetStock = targetProduct.stock + quantity;

            // Actualizar vista previa
            document.getElementById('previewSourceName').textContent = sourceProduct.name;
            document.getElementById('previewSourceStock').innerHTML = `
                Stock actual: <strong>${sourceProduct.stock}</strong> ${sourceProduct.unit}<br>
                Despu√©s: <strong style="color: ${newSourceStock < 0 ? '#dc3545' : '#856404'}">${newSourceStock}</strong> ${sourceProduct.unit}
            `;

            document.getElementById('previewTargetName').textContent = targetProduct.name;
            document.getElementById('previewTargetStock').innerHTML = `
                Stock actual: <strong>${targetProduct.stock}</strong> ${targetProduct.unit}<br>
                Despu√©s: <strong style="color: #155724">${newTargetStock}</strong> ${targetProduct.unit}
            `;

            previewDiv.style.display = 'block';
        }

        // Ejecutar transformaci√≥n
        async function executeTransformation(event) {
            event.preventDefault();

            const sourceId = parseInt(document.getElementById('sourceProduct').value);
            const targetId = parseInt(document.getElementById('targetProduct').value);
            const quantity = parseInt(document.getElementById('transformQuantity').value);
            const notes = document.getElementById('transformNotes').value;

            // Buscar productos
            const sourceProduct = products.find(p => p.id === sourceId);
            const targetProduct = products.find(p => p.id === targetId);

            if (!sourceProduct || !targetProduct) {
                alert('‚ùå Error: Productos no encontrados');
                return;
            }

            // Validar stock suficiente
            if (sourceProduct.stock < quantity) {
                alert(`‚ùå Stock insuficiente de "${sourceProduct.name}"\nDisponible: ${sourceProduct.stock} ${sourceProduct.unit}\nRequerido: ${quantity} ${sourceProduct.unit}`);
                return;
            }

            // Validar que sean de tipos diferentes
            if (sourceProduct.type === targetProduct.type) {
                alert('‚ö†Ô∏è Advertencia: Est√°s transformando entre productos del mismo tipo.\n¬øEst√°s seguro de continuar?');
            }

            // Confirmar transformaci√≥n
            if (!confirm(`¬øConfirmar transformaci√≥n?\n\n` +
                `De: ${sourceProduct.name} (-${quantity} ${sourceProduct.unit})\n` +
                `A: ${targetProduct.name} (+${quantity} ${targetProduct.unit})`)) {
                return;
            }

            try {
                // Guardar stocks anteriores
                const sourceStockBefore = sourceProduct.stock;
                const targetStockBefore = targetProduct.stock;

                // Actualizar stocks
                sourceProduct.stock -= quantity;
                targetProduct.stock += quantity;

                // Actualizar en la base de datos
                await updateProductInDB(sourceId, { stock: sourceProduct.stock });
                await updateProductInDB(targetId, { stock: targetProduct.stock });

                // Registrar transformaci√≥n con stocks antes y despu√©s
                const transformation = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    sourceId: sourceId,
                    sourceName: sourceProduct.name,
                    sourceCode: sourceProduct.code,
                    sourceStockBefore: sourceStockBefore,
                    sourceStockAfter: sourceProduct.stock,
                    targetId: targetId,
                    targetName: targetProduct.name,
                    targetCode: targetProduct.code,
                    targetStockBefore: targetStockBefore,
                    targetStockAfter: targetProduct.stock,
                    quantity: quantity,
                    unit: sourceProduct.unit,
                    notes: notes
                };

                // Guardar en Supabase
                await saveTransformationToDB(transformation);
                transformations.push(transformation);

                // Actualizar vistas
                await loadProducts();
                await loadProductionForm();
                loadTransformationsHistory();
                resetTransformationForm();

                showToast(`‚úÖ Transformaci√≥n exitosa: ${quantity} ${sourceProduct.unit}`);

            } catch (error) {
                console.error('Error en transformaci√≥n:', error);
                alert('‚ùå Error al ejecutar la transformaci√≥n: ' + error.message);
            }
        }

        // Limpiar formulario de transformaci√≥n
        function resetTransformationForm() {
            document.getElementById('transformationForm').reset();
            document.getElementById('sourceStockInfo').textContent = '';
            document.getElementById('targetStockInfo').textContent = '';
            document.getElementById('transformationPreview').style.display = 'none';
            document.getElementById('sourceProductsDropdown').style.display = 'none';
            document.getElementById('targetProductsDropdown').style.display = 'none';
        }

        // Cargar historial de transformaciones
        function loadTransformationsHistory() {
            const container = document.getElementById('transformationsHistoryContainer');

            if (transformations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîÑ</div>
                        <div>No hay transformaciones registradas a√∫n</div>
                    </div>
                `;
                return;
            }

            // Filtrar transformaciones seg√∫n el filtro activo
            let filteredTransformations = [...transformations];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (currentTransformationsFilter === 'today') {
                filteredTransformations = transformations.filter(t => {
                    const transformDate = new Date(t.date);
                    const transformDateOnly = new Date(transformDate.getFullYear(), transformDate.getMonth(), transformDate.getDate());
                    return transformDateOnly.getTime() === today.getTime();
                });
            } else if (currentTransformationsFilter === 'week') {
                const oneWeekAgo = new Date(today);
                oneWeekAgo.setDate(today.getDate() - 7);
                filteredTransformations = transformations.filter(t => {
                    const transformDate = new Date(t.date);
                    return transformDate >= oneWeekAgo;
                });
            } else if (currentTransformationsFilter === 'month') {
                const oneMonthAgo = new Date(today);
                oneMonthAgo.setMonth(today.getMonth() - 1);
                filteredTransformations = transformations.filter(t => {
                    const transformDate = new Date(t.date);
                    return transformDate >= oneMonthAgo;
                });
            }
            // Si es 'all', no filtramos

            if (filteredTransformations.length === 0) {
                let message = 'No hay transformaciones ';
                if (currentTransformationsFilter === 'today') message += 'hoy';
                else if (currentTransformationsFilter === 'week') message += 'esta semana';
                else if (currentTransformationsFilter === 'month') message += 'este mes';
                else message += 'registradas';

                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999; background: white; border-radius: 12px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üîÑ</div>
                        <div>${message}</div>
                    </div>
                `;
                return;
            }

            // Ordenar por fecha m√°s reciente
            const sortedTransformations = [...filteredTransformations].sort((a, b) =>
                new Date(b.date) - new Date(a.date)
            );

            container.innerHTML = sortedTransformations.map(t => `
                <div class="transformation-card">
                    <div class="transformation-card-header">
                        <div class="transformation-card-date">
                            üìÖ ${new Date(t.date).toLocaleString('es-PY', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                        <div class="transformation-card-quantity">
                            ${t.quantity} ${t.unit}
                        </div>
                    </div>

                    <div class="transformation-card-body">
                        <!-- Producto Origen -->
                        <div class="transformation-card-product">
                            <div class="transformation-card-product-code">${t.sourceCode}</div>
                            <div class="transformation-card-product-name">${t.sourceName}</div>
                            <div class="transformation-card-stocks" style="background: #fff3cd;">
                                <div class="transformation-card-stock-item">
                                    <span class="transformation-card-stock-label" style="color: #856404;">Cantidad:</span>
                                    <span class="transformation-card-stock-value" style="color: #856404;">${t.quantity} ${t.unit}</span>
                                </div>
                                <div style="text-align: center; font-size: 16px; color: #ff6b6b; margin: 5px 0;">‚Üì</div>
                            </div>
                        </div>

                        <!-- Flecha -->
                        <div class="transformation-card-arrow">‚Üí</div>

                        <!-- Producto Destino -->
                        <div class="transformation-card-product">
                            <div class="transformation-card-product-code">${t.targetCode}</div>
                            <div class="transformation-card-product-name">${t.targetName}</div>
                            <div class="transformation-card-stocks" style="background: #d4edda;">
                                <div style="text-align: center; font-size: 16px; color: #28a745; margin: 5px 0;">‚Üë</div>
                                <div class="transformation-card-stock-item">
                                    <span class="transformation-card-stock-label" style="color: #155724;">Cantidad:</span>
                                    <span class="transformation-card-stock-value" style="color: #155724;">${t.quantity} ${t.unit}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${t.notes ? `<div class="transformation-card-notes">üìù ${t.notes}</div>` : ''}
                </div>
            `).join('');
        }

        // Filtrar transformaciones por per√≠odo
        function filterTransformations(filter) {
            currentTransformationsFilter = filter;

            // Actualizar botones activos
            document.querySelectorAll('.transformations-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.transformations-filter-btn[data-filter="${filter}"]`).classList.add('active');

            // Recargar historial con el nuevo filtro
            loadTransformationsHistory();
        }

        // Cargar transformaciones desde Supabase
        async function loadTransformations() {
            try {
                transformations = await loadTransformationsFromDB();
                loadTransformationsHistory();
            } catch (error) {
                console.error('Error al cargar transformaciones:', error);
                transformations = [];
            }
        }


        // ============================================
        // M√ìDULO DE PEDIDOS
        // ============================================

        let allPedidos = [];
        let filteredPedidos = [];
        let currentEstadoFilter = 'todos';

        // Abrir modal de nuevo pedido

        // Cargar productos en el selector de pedidos
        async function loadProductosInPedidoSelect() {
            try {
                const list = document.getElementById('productosBaseList');

                // Opci√≥n de producto personalizado
                const customOption = `
                    <div class="producto-base-item" onclick="seleccionarProductoPersonalizado()" style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;">
                        <div style="width: 50px; height: 50px; background: #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; margin-right: 12px;">‚ûï</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #667eea; font-size: 14px;">Producto Personalizado</div>
                            <div style="font-size: 11px; color: #999;">Crear producto nuevo</div>
                        </div>
                    </div>
                `;

                // Crear items de productos con foto
                const productItems = products.map(product => {
                    const hasImage = product.imageUrl;
                    const imageHtml = hasImage
                        ? `<img src="${product.imageUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; margin-right: 12px;">`
                        : `<div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-right: 12px;">üì¶</div>`;

                    return `
                        <div class="producto-base-item" data-id="${product.id}" data-search="${product.name.toLowerCase()} ${(product.brand || '').toLowerCase()}" onclick="seleccionarProductoBase(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${product.imageUrl || ''}')" style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;">
                            ${imageHtml}
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: #333; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.name}</div>
                                <div style="font-size: 12px; color: #667eea; margin-top: 2px;">${formatGuaranies(product.price)} ‚Ä¢ Stock: ${formatUnit(product.stock, product.unit)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                list.innerHTML = customOption + productItems;

                // Agregar efecto hover con CSS
                const style = document.createElement('style');
                style.textContent = `
                    .producto-base-item:hover {
                        background: #f8f9fa !important;
                    }
                `;
                if (!document.getElementById('producto-base-style')) {
                    style.id = 'producto-base-style';
                    document.head.appendChild(style);
                }
            } catch (error) {
                console.error('Error al cargar productos:', error);
            }
        }

        // Toggle dropdown de productos
        function toggleProductosDropdown() {
            const dropdown = document.getElementById('productosBaseDropdown');
            const isVisible = dropdown.style.display === 'block';

            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
                // Focus en el buscador
                setTimeout(() => {
                    document.getElementById('searchProductoBase').focus();
                }, 100);
            }
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('productosBaseDropdown');
            const selector = document.getElementById('productoBaseSelector');

            if (dropdown && selector && !dropdown.contains(e.target) && !selector.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Seleccionar producto del listado
        function seleccionarProductoBase(id, nombre, precio, foto) {
            // Guardar datos
            document.getElementById('pedidoProductoBase').value = id;
            document.getElementById('pedidoPrecioBase').value = precio;
            document.getElementById('pedidoProductoFoto').value = foto;

            // Actualizar texto del selector
            document.getElementById('productoBaseSelectorText').textContent = nombre;
            document.getElementById('productoBaseSelectorText').style.color = '#333';

            // Ocultar input personalizado
            document.getElementById('pedidoProductoBaseCustom').style.display = 'none';
            document.getElementById('materialProductoGroup').style.display = 'none';

            // Cerrar dropdown
            document.getElementById('productosBaseDropdown').style.display = 'none';

            // Recalcular total
            calcularTotal();
        }

        // Seleccionar producto personalizado
        function seleccionarProductoPersonalizado() {
            // Guardar valores
            document.getElementById('pedidoProductoBase').value = '__custom__';
            document.getElementById('pedidoPrecioBase').value = 0;
            document.getElementById('pedidoProductoFoto').value = '';

            // Actualizar texto del selector
            document.getElementById('productoBaseSelectorText').textContent = 'Producto Personalizado';
            document.getElementById('productoBaseSelectorText').style.color = '#667eea';

            // Mostrar input personalizado
            document.getElementById('pedidoProductoBaseCustom').style.display = 'block';
            document.getElementById('materialProductoGroup').style.display = 'block';

            // Cerrar dropdown
            document.getElementById('productosBaseDropdown').style.display = 'none';

            // Focus en el input
            setTimeout(() => {
                document.getElementById('pedidoProductoBaseCustom').focus();
            }, 100);
        }

        // Filtrar productos en el listado
        function filterProductosBase() {
            const searchTerm = document.getElementById('searchProductoBase').value.toLowerCase();
            const items = document.querySelectorAll('.producto-base-item');

            items.forEach(item => {
                const searchData = item.dataset.search || '';
                // Primera opci√≥n siempre visible (producto personalizado)
                if (!item.dataset.search || searchData.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // === FUNCIONES DE CARGA DE FOTO PARA PEDIDOS ===

        let selectedPedidoImageFile = null;

        // Manejar selecci√≥n de archivo
        function handlePedidoImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                return;
            }

            // Validar formato
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('‚ùå Formato no v√°lido. Usa JPG, PNG o WEBP.');
                return;
            }

            selectedPedidoImageFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('pedidoPreviewImg').src = e.target.result;
                document.getElementById('pedidoImagePreview').style.display = 'block';
                document.getElementById('pedidoProductoFoto').value = e.target.result; // Guardar base64
            };
            reader.readAsDataURL(file);
        }

        // Manejar drop de archivo
        function handlePedidoDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            // Restaurar estilo
            event.target.style.background = '#f9f9f9';
            event.target.style.borderColor = '#667eea';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Validar que sea imagen
                if (!file.type.match('image.*')) {
                    alert('‚ùå Por favor arrastra una imagen');
                    return;
                }

                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                    return;
                }

                selectedPedidoImageFile = file;

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('pedidoPreviewImg').src = e.target.result;
                    document.getElementById('pedidoImagePreview').style.display = 'block';
                    document.getElementById('pedidoProductoFoto').value = e.target.result; // Guardar base64
                };
                reader.readAsDataURL(file);
            }
        }

        // Tomar foto con c√°mara (versi√≥n completa)
        let currentPedidoCameraMode = 'environment';

        async function takePedidoPhoto() {
            try {
                await startPedidoCamera();
            } catch (error) {
                alert('‚ùå No se pudo acceder a la c√°mara: ' + error.message);
            }
        }

        async function startPedidoCamera() {
            // Detener stream anterior si existe
            if (window.currentPedidoStream) {
                window.currentPedidoStream.getTracks().forEach(track => track.stop());
            }

            // Constraints mejorados para mejor calidad
            const constraints = {
                video: {
                    facingMode: currentPedidoCameraMode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    aspectRatio: { ideal: 4/3 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Si ya existe el modal, solo actualizar el video
            if (window.pedidoCameraModal) {
                const video = document.getElementById('pedidoCameraVideo');
                video.srcObject = stream;
                window.currentPedidoStream = stream;
                return;
            }

            // Crear modal con video mejorado y controles profesionales
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
                    <div style="background:white;padding:20px;border-radius:15px;max-width:650px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);position:relative;">
                        <button onclick="closePedidoCamera()" style="position:absolute;top:15px;right:15px;background:transparent;border:none;font-size:28px;cursor:pointer;color:#999;line-height:1;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;transition:color 0.2s;" onmouseover="this.style.color='#333'" onmouseout="this.style.color='#999'">√ó</button>
                        <h3 style="margin:0 0 15px 0;text-align:center;color:#333;">üì∏ Tomar Fotograf√≠a</h3>

                        <!-- Vista previa de c√°mara -->
                        <div style="position:relative;background:#000;border-radius:10px;overflow:hidden;">
                            <video id="pedidoCameraVideo" autoplay playsinline style="width:100%;height:auto;display:block;touch-action:none;"></video>

                            <!-- Grilla de ayuda compositiva (regla de tercios) -->
                            <div id="pedidoGridOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;">
                                <svg width="100%" height="100%" style="position:absolute;top:0;left:0;">
                                    <line x1="33.33%" y1="0" x2="33.33%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="66.66%" y1="0" x2="66.66%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="33.33%" x2="100%" y2="33.33%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="66.66%" x2="100%" y2="66.66%" stroke="white" stroke-width="1" opacity="0.3"/>
                                </svg>
                            </div>

                            <!-- Marco de enfoque central -->
                            <div id="pedidoFocusFrame" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70%;height:70%;border:2px solid rgba(255,255,255,0.5);border-radius:10px;pointer-events:none;"></div>

                            <!-- Efecto flash -->
                            <div id="pedidoCaptureFlash" style="position:absolute;top:0;left:0;width:100%;height:100%;background:white;opacity:0;pointer-events:none;transition:opacity 0.1s;"></div>

                            <!-- Indicador de c√°mara activa -->
                            <div style="position:absolute;top:10px;left:10px;background:rgba(255,0,0,0.8);color:white;padding:5px 10px;border-radius:15px;font-size:12px;font-weight:bold;">
                                ‚óè REC
                            </div>

                            <!-- Informaci√≥n de resoluci√≥n -->
                            <div id="pedidoResolutionInfo" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:5px 10px;border-radius:5px;font-size:11px;"></div>
                        </div>

                        <!-- Controles de c√°mara -->
                        <div style="margin-top:15px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="pedidoGridToggle" onchange="togglePedidoGrid(this.checked)" style="cursor:pointer;">
                                Grilla
                            </label>
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="pedidoFocusFrameToggle" checked onchange="togglePedidoFocusFrame(this.checked)" style="cursor:pointer;">
                                Marco
                            </label>
                            <div style="flex:1;"></div>
                            <span style="font-size:12px;color:#666;">Zoom:</span>
                            <input type="range" id="pedidoZoomSlider" min="1" max="3" step="0.1" value="1" onchange="adjustPedidoZoom(this.value)" style="width:100px;cursor:pointer;">
                            <span id="pedidoZoomValue" style="font-size:12px;color:#666;min-width:35px;">1.0x</span>
                        </div>

                        <!-- Botones principales -->
                        <div style="margin-top:20px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="capturePedidoPhoto()" style="flex:1;min-width:140px;font-size:16px;padding:12px;">üì∏ Capturar</button>
                            <button class="btn btn-secondary" onclick="flipPedidoCamera()" style="padding:12px 20px;">üîÑ C√°mara</button>
                            <button class="btn btn-danger" onclick="closePedidoCamera()" style="padding:12px 20px;">‚ùå Cerrar</button>
                        </div>

                        <p style="margin:10px 0 0 0;text-align:center;font-size:11px;color:#999;">
                            üí° Centra el producto en el marco ‚Ä¢ Usa buena iluminaci√≥n ‚Ä¢ Mant√©n el dispositivo estable
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const video = document.getElementById('pedidoCameraVideo');
            video.srcObject = stream;

            // Mostrar informaci√≥n de resoluci√≥n cuando el video est√© listo
            video.addEventListener('loadedmetadata', () => {
                const resInfo = document.getElementById('pedidoResolutionInfo');
                if (resInfo) {
                    resInfo.textContent = `${video.videoWidth}x${video.videoHeight}`;
                }

                // Verificar si el dispositivo soporta zoom
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    const zoomSlider = document.getElementById('pedidoZoomSlider');
                    zoomSlider.min = capabilities.zoom.min || 1;
                    zoomSlider.max = capabilities.zoom.max || 3;
                    zoomSlider.step = capabilities.zoom.step || 0.1;
                }
            });

            window.currentPedidoStream = stream;
            window.pedidoCameraModal = modal;

            // Agregar Pinch-to-Zoom con gestos t√°ctiles
            let initialPinchDistance = 0;
            let initialZoomValue = 1;

            video.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialPinchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    const zoomSlider = document.getElementById('pedidoZoomSlider');
                    initialZoomValue = parseFloat(zoomSlider.value);
                }
            }, { passive: false });

            video.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );

                    const scale = currentDistance / initialPinchDistance;
                    const newZoom = Math.max(1, Math.min(3, initialZoomValue * scale));

                    const zoomSlider = document.getElementById('pedidoZoomSlider');
                    zoomSlider.value = newZoom;
                    adjustPedidoZoom(newZoom);
                }
            }, { passive: false });

            // Agregar atajo de teclado para capturar (Espacio)
            window.pedidoCameraKeyHandler = (e) => {
                if (e.code === 'Space' && window.pedidoCameraModal) {
                    e.preventDefault();
                    capturePedidoPhoto();
                } else if (e.code === 'Escape' && window.pedidoCameraModal) {
                    e.preventDefault();
                    closePedidoCamera();
                }
            };
            document.addEventListener('keydown', window.pedidoCameraKeyHandler);
        }

        // Funci√≥n para alternar grilla de composici√≥n
        function togglePedidoGrid(show) {
            const grid = document.getElementById('pedidoGridOverlay');
            if (grid) {
                grid.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para alternar marco de enfoque
        function togglePedidoFocusFrame(show) {
            const frame = document.getElementById('pedidoFocusFrame');
            if (frame) {
                frame.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para ajustar zoom
        function adjustPedidoZoom(value) {
            const zoomValueDisplay = document.getElementById('pedidoZoomValue');
            if (zoomValueDisplay) {
                zoomValueDisplay.textContent = parseFloat(value).toFixed(1) + 'x';
            }

            if (window.currentPedidoStream) {
                const track = window.currentPedidoStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    track.applyConstraints({
                        advanced: [{ zoom: parseFloat(value) }]
                    }).catch(err => {
                        console.log('Zoom no soportado:', err);
                    });
                } else {
                    // Fallback: zoom digital mediante CSS transform
                    const video = document.getElementById('pedidoCameraVideo');
                    if (video) {
                        video.style.transform = `scale(${value})`;
                        video.style.transformOrigin = 'center center';
                    }
                }
            }
        }

        async function flipPedidoCamera() {
            // Cambiar entre frontal y trasera
            currentPedidoCameraMode = currentPedidoCameraMode === 'user' ? 'environment' : 'user';
            try {
                await startPedidoCamera();
            } catch (error) {
                alert('‚ùå No se pudo cambiar la c√°mara: ' + error.message);
                // Volver al modo anterior si falla
                currentPedidoCameraMode = currentPedidoCameraMode === 'user' ? 'environment' : 'user';
            }
        }

        // Capturar foto
        function capturePedidoPhoto() {
            const video = document.getElementById('pedidoCameraVideo');
            const canvas = document.createElement('canvas');

            // Usar resoluci√≥n del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Efecto flash visual
            const flash = document.getElementById('pedidoCaptureFlash');
            if (flash) {
                flash.style.opacity = '0.7';
                setTimeout(() => flash.style.opacity = '0', 100);
            }

            // Comprimir imagen para tama√±o √≥ptimo
            let finalCanvas = canvas;
            const maxDimension = 1600;

            if (canvas.width > maxDimension || canvas.height > maxDimension) {
                finalCanvas = document.createElement('canvas');
                const scale = Math.min(maxDimension / canvas.width, maxDimension / canvas.height);
                finalCanvas.width = canvas.width * scale;
                finalCanvas.height = canvas.height * scale;

                const finalCtx = finalCanvas.getContext('2d');
                finalCtx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
            }

            // Convertir a blob con calidad ajustada
            finalCanvas.toBlob((blob) => {
                const sizeMB = blob.size / (1024 * 1024);
                console.log(`Tama√±o de imagen: ${sizeMB.toFixed(2)} MB`);

                if (sizeMB > 5) {
                    alert('‚ö†Ô∏è La imagen es muy grande. Intenta con mejor iluminaci√≥n o m√°s cerca del producto.');
                    return;
                }

                selectedPedidoImageFile = new File([blob], 'photo.jpg', { type: 'image/jpeg' });

                const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.85);
                document.getElementById('pedidoPreviewImg').src = dataUrl;
                document.getElementById('pedidoImagePreview').style.display = 'block';
                document.getElementById('pedidoProductoFoto').value = dataUrl;

                closePedidoCamera();
            }, 'image/jpeg', 0.85);
        }

        // Cerrar c√°mara
        function closePedidoCamera() {
            if (window.currentPedidoStream) {
                window.currentPedidoStream.getTracks().forEach(track => track.stop());
                window.currentPedidoStream = null;
            }
            if (window.pedidoCameraModal) {
                window.pedidoCameraModal.remove();
                window.pedidoCameraModal = null;
            }
            // Remover listener de teclado
            if (window.pedidoCameraKeyHandler) {
                document.removeEventListener('keydown', window.pedidoCameraKeyHandler);
                window.pedidoCameraKeyHandler = null;
            }
        }

        // Limpiar imagen
        function clearPedidoImage() {
            selectedPedidoImageFile = null;
            document.getElementById('pedidoPreviewImg').src = '';
            document.getElementById('pedidoImagePreview').style.display = 'none';
            document.getElementById('pedidoProductoFoto').value = '';
            document.getElementById('pedidoImageInput').value = '';
        }

        // Obtener nombre del producto base (para guardar)
        function getPedidoProductoBaseNombre() {
            const hiddenInput = document.getElementById('pedidoProductoBase');
            const customInput = document.getElementById('pedidoProductoBaseCustom');
            const selectedValue = hiddenInput.value;

            if (selectedValue === '__custom__') {
                return customInput.value;
            } else if (selectedValue === '') {
                return '';
            } else {
                // Buscar el producto seleccionado en la lista
                const selectedItem = document.querySelector(`.producto-base-item[data-id="${selectedValue}"]`);
                if (selectedItem) {
                    return selectedItem.querySelector('div > div').textContent;
                }
                // Fallback: buscar en el array de productos
                const product = products.find(p => p.id == selectedValue);
                return product ? product.name : '';
            }
        }

        // Manejar cambio de material
        document.addEventListener('change', function(e) {
            if (e.target.id === 'pedidoMaterial') {
                const materialOtro = document.getElementById('pedidoMaterialOtro');
                if (e.target.value === 'otro') {
                    materialOtro.style.display = 'block';
                } else {
                    materialOtro.style.display = 'none';
                    materialOtro.value = '';
                }
            }
        });

        // Obtener valor del material (para guardar)
        function getPedidoMaterial() {
            const select = document.getElementById('pedidoMaterial');
            const otroInput = document.getElementById('pedidoMaterialOtro');



            if (select.value === 'otro' && otroInput.value) {
                return otroInput.value;
            }
            return select.value;
        }


        async function openNuevoPedidoModal() {
            document.getElementById('nuevoPedidoModal').style.display = 'flex';
            document.getElementById('pedidoModalTitle').textContent = 'üìù Nuevo Pedido';
            document.getElementById('pedidoForm').reset();
            document.getElementById('pedidoId').value = '';

            // Establecer fecha de hoy
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pedidoFechaPedido').value = today;

            // Cargar clientes en el select
            await loadClientesInSelect();
            await loadProductosInPedidoSelect();
            await loadServiciosInSelect();
            await loadPaquetesRegaloInSelect();
            loadMaterialesInSelect();

            // Reset calculadora
            calcularTotal();
        }

        // Cerrar modal de nuevo pedido
        function closeNuevoPedidoModal() {
            document.getElementById('nuevoPedidoModal').style.display = 'none';
        }

        // Cargar clientes en el select
        async function loadClientesInSelect() {
            try {
                const clientes = await loadClientsFromDB();
                const select = document.getElementById('pedidoClienteId');
                select.innerHTML = '<option value="">Seleccionar cliente...</option>';

                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    // Mostrar nombre del cliente con documento solo si existe
                    let textoCliente = cliente.name;
                    if (cliente.doc_type && cliente.doc_number) {
                        textoCliente += ` - ${cliente.doc_type}: ${cliente.doc_number}`;
                    } else if (cliente.phone) {
                        textoCliente += ` - Tel: ${cliente.phone}`;
                    }
                    option.textContent = textoCliente;
                    option.dataset.telefono = cliente.phone || '';
                    option.dataset.email = cliente.email || '';
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar clientes:', error);
            }
        }

        // Cargar datos del cliente seleccionado
        function loadClienteData(clienteId) {
            const select = document.getElementById('pedidoClienteId');
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption && selectedOption.value) {
                document.getElementById('pedidoClienteTelefono').value = selectedOption.dataset.telefono || '';
                document.getElementById('pedidoClienteEmail').value = selectedOption.dataset.email || '';
            } else {
                document.getElementById('pedidoClienteTelefono').value = '';
                document.getElementById('pedidoClienteEmail').value = '';
            }
        }

        // Cargar servicios desde la base de datos
        async function loadServiciosInSelect() {
            try {
                const { data: servicios, error } = await supabase
                    .from('servicios')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('pedidoTipoServicio');
                select.innerHTML = '<option value="">Seleccionar servicio...</option>';

                servicios.forEach(servicio => {
                    const option = document.createElement('option');
                    option.value = servicio.valor;
                    option.textContent = servicio.nombre;
                    option.dataset.servicioId = servicio.id;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar servicios:', error);
                // Si hay error, cargar servicios por defecto
                const select = document.getElementById('pedidoTipoServicio');
                select.innerHTML = `
                    <option value="">Seleccionar servicio...</option>
                    <option value="sublimacion">Sublimaci√≥n</option>
                    <option value="grabado_laser">Grabado L√°ser</option>
                    <option value="bordado">Bordado</option>
                    <option value="otro">Otro</option>
                `;
            }
        }

        // Abrir modal para crear nuevo servicio
        function openNuevoServicioModal() {
            document.getElementById('nuevoServicioModal').style.display = 'flex';
        }

        // Cerrar modal de nuevo servicio
        function closeNuevoServicioModal() {
            document.getElementById('nuevoServicioModal').style.display = 'none';
            document.getElementById('formNuevoServicio').reset();
        }

        // Guardar nuevo servicio
        async function guardarNuevoServicio() {
            const nombre = document.getElementById('servicioNombre').value.trim();
            const descripcion = document.getElementById('servicioDescripcion').value.trim();

            if (!nombre) {
                alert('Por favor ingresa el nombre del servicio');
                return;
            }

            try {
                // Generar valor √∫nico a partir del nombre
                const valor = nombre.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                    .replace(/[^a-z0-9]+/g, '_') // Reemplazar espacios y caracteres especiales con _
                    .replace(/^_+|_+$/g, ''); // Quitar _ al inicio y final

                const { data, error } = await supabase
                    .from('servicios')
                    .insert([{
                        nombre: nombre,
                        valor: valor,
                        descripcion: descripcion,
                        activo: true
                    }])
                    .select();

                if (error) throw error;

                alert('‚úÖ Servicio creado exitosamente');
                closeNuevoServicioModal();
                await loadServiciosInSelect();
            } catch (error) {
                console.error('Error al guardar servicio:', error);
                if (error.code === '23505') {
                    alert('Ya existe un servicio con ese nombre');
                } else {
                    alert('Error al guardar el servicio: ' + error.message);
                }
            }
        }

        // Eliminar servicio
        async function eliminarServicio(servicioId, servicioNombre) {
            if (!confirm(`¬øEst√°s seguro de eliminar el servicio "${servicioNombre}"?\n\nEsto solo lo desactivar√°, no se eliminar√° permanentemente.`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('servicios')
                    .update({ activo: false })
                    .eq('id', servicioId);

                if (error) throw error;

                alert('‚úÖ Servicio eliminado exitosamente');
                await loadServiciosInSelect();
                await loadServiciosList(); // Recargar lista en modal de gesti√≥n
            } catch (error) {
                console.error('Error al eliminar servicio:', error);
                alert('Error al eliminar el servicio: ' + error.message);
            }
        }

        // Abrir modal de gesti√≥n de servicios
        async function openGestionServiciosModal() {
            document.getElementById('gestionServiciosModal').style.display = 'flex';
            await loadServiciosList();
        }

        // Cerrar modal de gesti√≥n de servicios
        function closeGestionServiciosModal() {
            document.getElementById('gestionServiciosModal').style.display = 'none';
            document.getElementById('nuevoServicioNombre').value = '';
        }

        // Cargar lista de servicios en el modal de gesti√≥n
        async function loadServiciosList() {
            try {
                const { data: servicios, error } = await supabase
                    .from('servicios')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('serviciosListContainer');

                if (servicios.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay servicios registrados</p>';
                    return;
                }

                container.innerHTML = servicios.map(servicio => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                        <div>
                            <div style="font-weight: bold; color: #333;">${servicio.nombre}</div>
                            ${servicio.descripcion ? `<div style="font-size: 12px; color: #666; margin-top: 4px;">${servicio.descripcion}</div>` : ''}
                        </div>
                        <button type="button" class="btn btn-danger" onclick="eliminarServicio(${servicio.id}, '${servicio.nombre.replace(/'/g, "\\'")}')" style="font-size: 12px; padding: 6px 12px;">üóëÔ∏è Eliminar</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error al cargar servicios:', error);
                document.getElementById('serviciosListContainer').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Error al cargar servicios</p>';
            }
        }

        // Agregar nuevo servicio
        async function agregarNuevoServicio() {
            const nombre = document.getElementById('nuevoServicioNombre').value.trim();

            if (!nombre) {
                alert('Por favor ingresa el nombre del servicio');
                return;
            }

            try {
                // Generar valor √∫nico a partir del nombre
                const valor = nombre.toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Quitar acentos
                    .replace(/[^a-z0-9]+/g, '_') // Reemplazar espacios y caracteres especiales con _
                    .replace(/^_+|_+$/g, ''); // Quitar _ al inicio y final

                const { data, error } = await supabase
                    .from('servicios')
                    .insert([{
                        nombre: nombre,
                        valor: valor,
                        descripcion: '',
                        activo: true
                    }])
                    .select();

                if (error) throw error;

                alert('‚úÖ Servicio creado exitosamente');
                document.getElementById('nuevoServicioNombre').value = '';
                await loadServiciosInSelect();
                await loadServiciosList();
            } catch (error) {
                console.error('Error al guardar servicio:', error);
                if (error.code === '23505') {
                    alert('Ya existe un servicio con ese nombre');
                } else {
                    alert('Error al guardar el servicio: ' + error.message);
                }
            }
        }

        // === GESTI√ìN DE MATERIALES ===

        // Cargar materiales en el select
        function loadMaterialesInSelect() {
            const select = document.getElementById('pedidoMaterial');
            const materiales = JSON.parse(localStorage.getItem('materiales') || '["Algod√≥n","Poli√©ster","Algod√≥n/Poli√©ster","Sublimable","Cer√°mica","Vidrio","Metal","Madera","Pl√°stico","Otro"]');

            select.innerHTML = '<option value="">Seleccionar...</option>';
            materiales.forEach(material => {
                const option = document.createElement('option');
                option.value = material.toLowerCase();
                option.textContent = material;
                select.appendChild(option);
            });
        }

        // Abrir modal de gesti√≥n de materiales
        function openGestionMaterialesModal() {
            document.getElementById('gestionMaterialesModal').style.display = 'flex';
            loadMaterialesList();
        }

        // Cerrar modal de gesti√≥n de materiales
        function closeGestionMaterialesModal() {
            document.getElementById('gestionMaterialesModal').style.display = 'none';
            document.getElementById('nuevoMaterialNombre').value = '';
        }

        // Cargar lista de materiales en el modal
        function loadMaterialesList() {
            const materiales = JSON.parse(localStorage.getItem('materiales') || '["Algod√≥n","Poli√©ster","Algod√≥n/Poli√©ster","Sublimable","Cer√°mica","Vidrio","Metal","Madera","Pl√°stico","Otro"]');
            const container = document.getElementById('materialesListContainer');

            if (materiales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay materiales registrados</p>';
                return;
            }

            container.innerHTML = materiales.map((material, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                    <div>
                        <div style="font-weight: bold; color: #333;">${material}</div>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="eliminarMaterial('${material.replace(/'/g, "\\'")}', ${index})" style="font-size: 12px; padding: 6px 12px;">üóëÔ∏è Eliminar</button>
                </div>
            `).join('');
        }

        // Agregar nuevo material
        function agregarNuevoMaterial() {
            const nombre = document.getElementById('nuevoMaterialNombre').value.trim();

            if (!nombre) {
                alert('Por favor ingresa el nombre del material');
                return;
            }

            const materiales = JSON.parse(localStorage.getItem('materiales') || '["Algod√≥n","Poli√©ster","Algod√≥n/Poli√©ster","Sublimable","Cer√°mica","Vidrio","Metal","Madera","Pl√°stico","Otro"]');

            if (materiales.includes(nombre)) {
                alert('Ya existe un material con ese nombre');
                return;
            }

            materiales.push(nombre);
            localStorage.setItem('materiales', JSON.stringify(materiales));

            alert('‚úÖ Material creado exitosamente');
            document.getElementById('nuevoMaterialNombre').value = '';
            loadMaterialesInSelect();
            loadMaterialesList();
        }

        // Eliminar material
        function eliminarMaterial(nombre, index) {
            if (!confirm(`¬øEst√°s seguro de eliminar el material "${nombre}"?`)) {
                return;
            }

            const materiales = JSON.parse(localStorage.getItem('materiales') || '[]');
            materiales.splice(index, 1);
            localStorage.setItem('materiales', JSON.stringify(materiales));

            alert('‚úÖ Material eliminado exitosamente');
            loadMaterialesInSelect();
            loadMaterialesList();
        }

        // === GESTI√ìN DE PRECIOS DE GRABADO L√ÅSER ===

        // Obtener precios configurados
        function getPreciosGrabadoLaser() {
            const preciosDefault = { minorista: 15000, mayorista: 10000 };
            const preciosGuardados = localStorage.getItem('preciosGrabadoLaser');
            return preciosGuardados ? JSON.parse(preciosGuardados) : preciosDefault;
        }

        // Abrir modal de gesti√≥n de precios
        function openGestionPreciosGrabadoModal() {
            const modal = document.getElementById('gestionPreciosGrabadoModal');
            const precios = getPreciosGrabadoLaser();

            // Cargar precios actuales en el formulario
            document.getElementById('configPrecioMinorista').value = precios.minorista;
            document.getElementById('configPrecioMayorista').value = precios.mayorista;

            // Actualizar vista previa
            updatePreciosPreview();

            modal.style.display = 'flex';
        }

        // Cerrar modal de gesti√≥n de precios
        function closeGestionPreciosGrabadoModal() {
            document.getElementById('gestionPreciosGrabadoModal').style.display = 'none';
        }

        // Actualizar vista previa de precios
        function updatePreciosPreview() {
            const minorista = document.getElementById('configPrecioMinorista').value || 0;
            const mayorista = document.getElementById('configPrecioMayorista').value || 0;

            document.getElementById('previewMinorista').textContent = formatGuaranies(parseInt(minorista));
            document.getElementById('previewMayorista').textContent = formatGuaranies(parseInt(mayorista));
        }

        // Guardar precios de Grabado L√°ser
        function guardarPreciosGrabado() {
            const minorista = parseInt(document.getElementById('configPrecioMinorista').value);
            const mayorista = parseInt(document.getElementById('configPrecioMayorista').value);

            if (isNaN(minorista) || minorista < 0) {
                alert('Por favor ingresa un precio minorista v√°lido');
                return;
            }

            if (isNaN(mayorista) || mayorista < 0) {
                alert('Por favor ingresa un precio mayorista v√°lido');
                return;
            }

            const precios = {
                minorista: minorista,
                mayorista: mayorista
            };

            localStorage.setItem('preciosGrabadoLaser', JSON.stringify(precios));

            alert('‚úÖ Precios guardados exitosamente');
            closeGestionPreciosGrabadoModal();
        }

        // === GESTI√ìN DE TIPOS DE GRABADO ===

        // Obtener tipos de grabado configurados
        function getTiposGrabado() {
            const tiposDefault = [
                { nombre: 'Nombre', precioMinorista: 20000, precioMayorista: 15000 },
                { nombre: 'Nombre y Apellido', precioMinorista: 35000, precioMayorista: 25000 }
            ];
            const tiposGuardados = localStorage.getItem('tiposGrabado');
            return tiposGuardados ? JSON.parse(tiposGuardados) : tiposDefault;
        }

        // Cargar tipos de grabado en el select
        function loadTiposGrabadoInSelect() {
            const select = document.getElementById('pedidoTipoGrabado');
            const tipos = getTiposGrabado();

            select.innerHTML = '<option value="">Seleccionar tipo...</option>';
            tipos.forEach((tipo, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${tipo.nombre} - Min: ${formatGuaranies(tipo.precioMinorista)} / May: ${formatGuaranies(tipo.precioMayorista)}`;
                select.appendChild(option);
            });
        }

        // Actualizar precios cuando se selecciona un tipo de grabado
        function updatePreciosPorTipoGrabado() {
            const select = document.getElementById('pedidoTipoGrabado');
            const index = select.value;

            if (index === '') {
                return;
            }

            const tipos = getTiposGrabado();
            const tipo = tipos[index];

            if (tipo) {
                document.getElementById('pedidoPrecioMinorista').value = tipo.precioMinorista;
                document.getElementById('pedidoPrecioMayorista').value = tipo.precioMayorista;

                // Actualizar autom√°ticamente el Precio Servicio
                document.getElementById('pedidoPrecioServicio').value = tipo.precioMinorista;

                calcularTotal();
            }
        }

        // Abrir modal de gesti√≥n de tipos de grabado
        function openGestionTiposGrabadoModal() {
            document.getElementById('gestionTiposGrabadoModal').style.display = 'flex';
            loadTiposGrabadoList();
        }

        // Cerrar modal de gesti√≥n de tipos de grabado
        function closeGestionTiposGrabadoModal() {
            document.getElementById('gestionTiposGrabadoModal').style.display = 'none';
            document.getElementById('nuevoTipoGrabadoNombre').value = '';
            document.getElementById('nuevoTipoGrabadoPrecioMinorista').value = 0;
            document.getElementById('nuevoTipoGrabadoPrecioMayorista').value = 0;
        }

        // Cargar lista de tipos de grabado en el modal
        function loadTiposGrabadoList() {
            const tipos = getTiposGrabado();
            const container = document.getElementById('tiposGrabadoListContainer');

            if (tipos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay tipos de grabado registrados</p>';
                return;
            }

            container.innerHTML = tipos.map((tipo, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #333; font-size: 15px; margin-bottom: 5px;">‚ö° ${tipo.nombre}</div>
                        <div style="display: flex; gap: 20px; font-size: 13px; color: #666;">
                            <span>üíµ Minorista: <strong style="color: #28a745;">${formatGuaranies(tipo.precioMinorista)}</strong></span>
                            <span>üì¶ Mayorista: <strong style="color: #667eea;">${formatGuaranies(tipo.precioMayorista)}</strong></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="editarTipoGrabado(${index})" style="font-size: 12px; padding: 6px 12px;">‚úèÔ∏è Editar</button>
                        <button type="button" class="btn btn-danger" onclick="eliminarTipoGrabado(${index})" style="font-size: 12px; padding: 6px 12px;">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        // Agregar nuevo tipo de grabado
        function agregarNuevoTipoGrabado() {
            const nombre = document.getElementById('nuevoTipoGrabadoNombre').value.trim();
            const precioMinorista = parseInt(document.getElementById('nuevoTipoGrabadoPrecioMinorista').value);
            const precioMayorista = parseInt(document.getElementById('nuevoTipoGrabadoPrecioMayorista').value);
            const editIndex = document.getElementById('editTipoGrabadoIndex').value;

            if (!nombre) {
                alert('Por favor ingresa el nombre del tipo de grabado');
                return;
            }

            if (isNaN(precioMinorista) || precioMinorista < 0) {
                alert('Por favor ingresa un precio minorista v√°lido');
                return;
            }

            if (isNaN(precioMayorista) || precioMayorista < 0) {
                alert('Por favor ingresa un precio mayorista v√°lido');
                return;
            }

            const tipos = getTiposGrabado();

            // Si estamos editando
            if (editIndex !== '') {
                const index = parseInt(editIndex);
                // Verificar si ya existe otro tipo con ese nombre
                if (tipos.some((t, i) => i !== index && t.nombre.toLowerCase() === nombre.toLowerCase())) {
                    alert('Ya existe un tipo de grabado con ese nombre');
                    return;
                }

                tipos[index] = {
                    nombre: nombre,
                    precioMinorista: precioMinorista,
                    precioMayorista: precioMayorista
                };

                localStorage.setItem('tiposGrabado', JSON.stringify(tipos));
                alert('‚úÖ Tipo de grabado actualizado exitosamente');
            } else {
                // Si estamos agregando nuevo
                // Verificar si ya existe
                if (tipos.some(t => t.nombre.toLowerCase() === nombre.toLowerCase())) {
                    alert('Ya existe un tipo de grabado con ese nombre');
                    return;
                }

                tipos.push({
                    nombre: nombre,
                    precioMinorista: precioMinorista,
                    precioMayorista: precioMayorista
                });

                localStorage.setItem('tiposGrabado', JSON.stringify(tipos));
                alert('‚úÖ Tipo de grabado creado exitosamente');
            }

            // Limpiar formulario
            document.getElementById('nuevoTipoGrabadoNombre').value = '';
            document.getElementById('nuevoTipoGrabadoPrecioMinorista').value = 0;
            document.getElementById('nuevoTipoGrabadoPrecioMayorista').value = 0;
            document.getElementById('editTipoGrabadoIndex').value = '';
            document.getElementById('btnAgregarTipoGrabado').textContent = '‚ûï Agregar Tipo';

            loadTiposGrabadoInSelect();
            loadTiposGrabadoList();
        }

        // Editar tipo de grabado
        function editarTipoGrabado(index) {
            const tipos = getTiposGrabado();
            const tipo = tipos[index];

            // Cargar datos en el formulario
            document.getElementById('nuevoTipoGrabadoNombre').value = tipo.nombre;
            document.getElementById('nuevoTipoGrabadoPrecioMinorista').value = tipo.precioMinorista;
            document.getElementById('nuevoTipoGrabadoPrecioMayorista').value = tipo.precioMayorista;
            document.getElementById('editTipoGrabadoIndex').value = index;

            // Cambiar texto del bot√≥n
            document.getElementById('btnAgregarTipoGrabado').textContent = 'üíæ Guardar Cambios';

            // Scroll hacia arriba para ver el formulario
            document.getElementById('nuevoTipoGrabadoNombre').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Eliminar tipo de grabado
        function eliminarTipoGrabado(index) {
            const tipos = getTiposGrabado();
            const tipo = tipos[index];

            if (!confirm(`¬øEst√°s seguro de eliminar el tipo "${tipo.nombre}"?`)) {
                return;
            }

            tipos.splice(index, 1);
            localStorage.setItem('tiposGrabado', JSON.stringify(tipos));

            alert('‚úÖ Tipo de grabado eliminado exitosamente');
            loadTiposGrabadoInSelect();
            loadTiposGrabadoList();
        }

        // Actualizar campos seg√∫n tipo de servicio
        function updateServicioFields() {
            const servicio = document.getElementById('pedidoTipoServicio').value;
            const servicioDetails = document.getElementById('servicioDetails');
            const coloresGroup = document.getElementById('coloresGroup');
            const areaGrabadoGroup = document.getElementById('areaGrabadoGroup');

            if (servicio) {
                servicioDetails.style.display = 'block';

                // Mostrar/ocultar campos seg√∫n el servicio
                if (servicio === 'bordado') {
                    coloresGroup.style.display = 'block';
                    areaGrabadoGroup.style.display = 'none';
                } else if (servicio === 'grabado_laser') {
                    coloresGroup.style.display = 'none';
                    areaGrabadoGroup.style.display = 'block';

                    // Cargar tipos de grabado en el select
                    loadTiposGrabadoInSelect();

                    // Autocompletar precios predefinidos para Grabado L√°ser desde localStorage
                    const precios = getPreciosGrabadoLaser();
                    document.getElementById('pedidoPrecioMinorista').value = precios.minorista;
                    document.getElementById('pedidoPrecioMayorista').value = precios.mayorista;

                    // Recalcular total
                    calcularTotal();
                } else {
                    coloresGroup.style.display = 'block';
                    areaGrabadoGroup.style.display = 'none';
                }
            } else {
                servicioDetails.style.display = 'none';
            }
        }

        // Toggle delivery
        function toggleDelivery() {
            const incluye = document.getElementById('pedidoIncluyeDelivery').checked;
            const deliveryGroup = document.getElementById('deliveryPriceGroup');
            deliveryGroup.style.display = incluye ? 'block' : 'none';
            calcularTotal();
        }

        // Toggle paquete de regalo
        function togglePaqueteRegalo() {
            const paraRegalo = document.getElementById('pedidoParaRegalo').checked;
            const paqueteGroup = document.getElementById('paqueteRegaloGroup');
            paqueteGroup.style.display = paraRegalo ? 'block' : 'none';

            // Si se desmarca, limpiar el precio de extras
            if (!paraRegalo) {
                document.getElementById('pedidoPaqueteRegalo').value = '';
                document.getElementById('pedidoPrecioExtras').value = 0;
                calcularTotal();
            }
        }

        // Actualizar precio extras cuando se selecciona un paquete de regalo
        function updatePrecioExtrasFromPaquete() {
            const select = document.getElementById('pedidoPaqueteRegalo');
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption && selectedOption.value) {
                const precio = parseFloat(selectedOption.dataset.price) || 0;
                document.getElementById('pedidoPrecioExtras').value = precio;
                calcularTotal();
            } else {
                document.getElementById('pedidoPrecioExtras').value = 0;
                calcularTotal();
            }
        }

        // Cargar paquetes de regalo en el selector
        async function loadPaquetesRegaloInSelect() {
            try {
                const select = document.getElementById('pedidoPaqueteRegalo');
                select.innerHTML = '<option value="">Seleccionar paquete...</option>';

                // Cargar productos de categor√≠a "paquete_regalo"
                const paquetes = products.filter(p => p.category === 'paquete_regalo');

                paquetes.forEach(paquete => {
                    const option = document.createElement('option');
                    option.value = paquete.id;
                    option.textContent = `${paquete.name} (Stock: ${paquete.stock})`;
                    option.dataset.stock = paquete.stock;
                    option.dataset.price = paquete.price;
                    option.dataset.name = paquete.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar paquetes de regalo:', error);
            }
        }

        // Calcular total del pedido
        function calcularTotal() {
            const cantidad = parseInt(document.getElementById('pedidoCantidad').value) || 1;
            const precioBase = parseFloat(document.getElementById('pedidoPrecioBase').value) || 0;
            const precioServicio = parseFloat(document.getElementById('pedidoPrecioServicio').value) || 0;
            const precioExtras = parseFloat(document.getElementById('pedidoPrecioExtras').value) || 0;
            const descuentoPorcentaje = parseFloat(document.getElementById('pedidoDescuento').value) || 0;
            const recargoUrgente = parseFloat(document.getElementById('pedidoRecargoUrgente').value) || 0;
            const esUrgente = document.getElementById('pedidoEsUrgente').checked;
            const incluyeDelivery = document.getElementById('pedidoIncluyeDelivery').checked;
            const precioDelivery = parseFloat(document.getElementById('pedidoPrecioDelivery').value) || 0;

            // Calcular subtotal
            let subtotal = (precioBase + precioServicio + precioExtras) * cantidad;

            // Aplicar descuento
            const descuento = subtotal * (descuentoPorcentaje / 100);
            subtotal -= descuento;

            // Aplicar recargo urgente si est√° marcado
            let recargo = 0;
            if (esUrgente && recargoUrgente > 0) {
                recargo = subtotal * (recargoUrgente / 100);
                subtotal += recargo;
            }

            // Agregar delivery si est√° incluido
            let delivery = 0;
            if (incluyeDelivery) {
                delivery = precioDelivery;
                subtotal += delivery;
            }

            // Mostrar total
            document.getElementById('pedidoTotalDisplay').textContent = formatGuaranies(subtotal);

            // Mostrar info de subtotal
            let infoText = '';
            if (descuento > 0) {
                infoText += `Descuento: -‚Ç≤ ${formatNumber(descuento)} `;
            }
            if (recargo > 0) {
                infoText += `Recargo urgente: +‚Ç≤ ${formatNumber(recargo)} `;
            }
            if (delivery > 0) {
                infoText += `Delivery: +‚Ç≤ ${formatNumber(delivery)}`;
            }
            document.getElementById('pedidoSubtotalInfo').textContent = infoText;

            return subtotal;
        }

        // Guardar pedido
        async function savePedido(event) {
            event.preventDefault();

            const pedidoId = document.getElementById('pedidoId').value;
            const clienteSelect = document.getElementById('pedidoClienteId');
            const clienteOption = clienteSelect.options[clienteSelect.selectedIndex];

            if (!clienteOption || !clienteOption.value) {
                alert('Por favor selecciona un cliente');
                return;
            }

            const total = calcularTotal();

            const pedidoData = {
                cliente_id: parseInt(clienteSelect.value),
                cliente_nombre: clienteOption.textContent.split(' - ')[0],
                cliente_telefono: document.getElementById('pedidoClienteTelefono').value,
                cliente_email: document.getElementById('pedidoClienteEmail').value,
                tipo_servicio: document.getElementById('pedidoTipoServicio').value,
                producto_base: getPedidoProductoBaseNombre(),
                producto_foto: document.getElementById('pedidoProductoFoto').value,
                tamano: document.getElementById('pedidoTamano').value,
                color: document.getElementById('pedidoColor').value,
                material: getPedidoMaterial(),
                tamano_diseno: document.getElementById('pedidoTamanoDiseno').value,
                cantidad_colores: parseInt(document.getElementById('pedidoCantidadColores').value) || 1,
                area_grabado: document.getElementById('pedidoAreaGrabado').value,
                cantidad: parseInt(document.getElementById('pedidoCantidad').value),
                precio_base: parseFloat(document.getElementById('pedidoPrecioBase').value) || 0,
                precio_servicio: parseFloat(document.getElementById('pedidoPrecioServicio').value) || 0,
                precio_extras: parseFloat(document.getElementById('pedidoPrecioExtras').value) || 0,
                descuento_porcentaje: parseFloat(document.getElementById('pedidoDescuento').value) || 0,
                recargo_urgente: parseFloat(document.getElementById('pedidoRecargoUrgente').value) || 0,
                precio_delivery: parseFloat(document.getElementById('pedidoPrecioDelivery').value) || 0,
                total: total,
                es_urgente: document.getElementById('pedidoEsUrgente').checked,
                incluye_delivery: document.getElementById('pedidoIncluyeDelivery').checked,
                diseno_personalizado: document.getElementById('pedidoDisenoPersonalizado').checked,
                para_regalo: document.getElementById('pedidoParaRegalo').checked,
                paquete_regalo_id: document.getElementById('pedidoParaRegalo').checked ?
                    (parseInt(document.getElementById('pedidoPaqueteRegalo').value) || null) : null,
                fecha_pedido: document.getElementById('pedidoFechaPedido').value,
                fecha_entrega: document.getElementById('pedidoFechaEntrega').value || null,
                observaciones: document.getElementById('pedidoObservaciones').value,
                notas_internas: document.getElementById('pedidoNotasInternas').value,
                estado: pedidoId ? undefined : 'presupuesto' // Solo establecer estado en nuevos pedidos
            };

            try {
                if (pedidoId) {
                    // Actualizar pedido existente
                    await updatePedidoInDB(pedidoId, pedidoData);
                    showAlert('‚úÖ Pedido actualizado correctamente', 'success');
                } else {
                    // Crear nuevo pedido
                    await createPedidoInDB(pedidoData);
                    showAlert('‚úÖ Pedido creado correctamente', 'success');
                }

                closeNuevoPedidoModal();
                await loadPedidos();
            } catch (error) {
                console.error('Error al guardar pedido:', error);
                showAlert('‚ùå Error al guardar el pedido: ' + error.message, 'error');
            }
        }

        // Crear pedido en base de datos
        async function createPedidoInDB(pedidoData) {
            // Primero obtener el n√∫mero de pedido
            const { data: numeroData, error: numeroError } = await supabase
                .rpc('generate_numero_pedido');

            if (numeroError) throw numeroError;

            pedidoData.numero_pedido = numeroData;

            const { data, error } = await supabase
                .from('pedidos')
                .insert([pedidoData])
                .select();

            if (error) throw error;
            return data[0];
        }

        // Actualizar pedido en base de datos
        async function updatePedidoInDB(pedidoId, pedidoData) {
            const { data, error } = await supabase
                .from('pedidos')
                .update(pedidoData)
                .eq('id', pedidoId)
                .select();

            if (error) throw error;
            return data[0];
        }

        // Cargar pedidos desde base de datos
        async function loadPedidos() {
            try {
                const { data, error } = await supabase
                    .from('pedidos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allPedidos = data || [];
                filterPedidos();
            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                showAlert('‚ùå Error al cargar pedidos', 'error');
                allPedidos = [];
                renderPedidos([]);
            }
        }

        // Filtrar pedidos
        function filterPedidos() {
            const searchTerm = document.getElementById('searchPedidos').value.toLowerCase();

            filteredPedidos = allPedidos.filter(pedido => {
                const matchesEstado = currentEstadoFilter === 'todos' || pedido.estado === currentEstadoFilter;
                const matchesSearch = !searchTerm ||
                    pedido.numero_pedido.toLowerCase().includes(searchTerm) ||
                    pedido.cliente_nombre.toLowerCase().includes(searchTerm) ||
                    (pedido.producto_base && pedido.producto_base.toLowerCase().includes(searchTerm));

                return matchesEstado && matchesSearch;
            });

            renderPedidos(filteredPedidos);
        }

        // Filtrar por estado
        function filterPedidosByEstado(estado) {
            currentEstadoFilter = estado;

            // Actualizar botones activos
            document.querySelectorAll('.pedidos-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.estado === estado) {
                    btn.classList.add('active');
                }
            });

            filterPedidos();
        }

        // Renderizar pedidos
        function renderPedidos(pedidos) {
            const container = document.getElementById('pedidosListContainer');
            const emptyState = document.getElementById('pedidosEmptyState');

            if (pedidos.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = pedidos.map(pedido => `
                <div class="pedido-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${getEstadoColor(pedido.estado)};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #333;">${pedido.numero_pedido}</h3>
                            <div style="color: #666; font-size: 14px;">
                                <strong>${pedido.cliente_nombre}</strong>
                                ${pedido.cliente_telefono ? `‚Ä¢ ${pedido.cliente_telefono}` : ''}
                            </div>
                        </div>
                        <span class="estado-badge" style="background: ${getEstadoColor(pedido.estado)}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            ${getEstadoText(pedido.estado)}
                        </span>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        ${pedido.producto_base ? `
                            <div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Producto</div>
                                <div style="font-weight: 500;">${pedido.producto_base}</div>
                            </div>
                        ` : ''}
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Servicio</div>
                            <div style="font-weight: 500;">${getServicioText(pedido.tipo_servicio)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Cantidad</div>
                            <div style="font-weight: 500;">${pedido.cantidad} unid.</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 3px;">Total</div>
                            <div style="font-weight: bold; color: #28a745; font-size: 16px;">${formatGuaranies(pedido.total)}</div>
                        </div>
                    </div>

                    ${pedido.fecha_entrega ? `
                        <div style="margin-bottom: 15px; padding: 10px; background: ${isPedidoUrgente(pedido) ? '#fff3cd' : '#e7f3ff'}; border-radius: 6px; font-size: 13px;">
                            üìÖ Entrega: <strong>${formatDate(pedido.fecha_entrega)}</strong>
                            ${isPedidoUrgente(pedido) ? ' <span style="color: #dc3545;">‚ö° URGENTE</span>' : ''}
                        </div>
                    ` : ''}

                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="viewPedidoDetalle(${pedido.id})" style="background: #667eea; color: white;">
                            üëÅÔ∏è Ver Detalle
                        </button>
                        <button class="btn btn-sm" onclick="editPedido(${pedido.id})" style="background: #ffc107; color: #333;">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn btn-sm" onclick="cambiarEstadoPedido(${pedido.id}, '${pedido.estado}')" style="background: #17a2b8; color: white;">
                            üîÑ Cambiar Estado
                        </button>
                        ${pedido.estado !== 'cancelado' ? `
                            <button class="btn btn-sm" onclick="cancelarPedido(${pedido.id})" style="background: #dc3545; color: white;">
                                ‚ùå Cancelar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Ver detalle de pedido
        async function viewPedidoDetalle(pedidoId) {
            try {
                const { data, error } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('id', pedidoId)
                    .single();

                if (error) throw error;

                const pedido = data;
                const modal = document.getElementById('detallePedidoModal');
                const content = document.getElementById('detallePedidoContent');

                document.getElementById('detallePedidoTitle').textContent = `üìù Pedido ${pedido.numero_pedido}`;

                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <!-- Estado y fechas -->
                        <div style="background: linear-gradient(135deg, ${getEstadoColor(pedido.estado)}, ${getEstadoColor(pedido.estado)}dd); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Estado Actual</div>
                            <div style="font-size: 24px; font-weight: bold;">${getEstadoText(pedido.estado).toUpperCase()}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 10px;">
                                Creado: ${formatDate(pedido.fecha_pedido)}
                                ${pedido.fecha_entrega ? ` | Entrega: ${formatDate(pedido.fecha_entrega)}` : ''}
                            </div>
                        </div>

                        <!-- Informaci√≥n del cliente -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h3 style="margin: 0 0 15px 0; color: #667eea;">üë§ Cliente</h3>
                            <div style="display: grid; gap: 10px;">
                                <div><strong>Nombre:</strong> ${pedido.cliente_nombre}</div>
                                ${pedido.cliente_telefono ? `<div><strong>Tel√©fono:</strong> ${pedido.cliente_telefono}</div>` : ''}
                                ${pedido.cliente_email ? `<div><strong>Email:</strong> ${pedido.cliente_email}</div>` : ''}
                            </div>
                        </div>

                        <!-- Detalles del producto -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h3 style="margin: 0 0 15px 0; color: #667eea;">üì¶ Producto y Servicio</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${pedido.producto_base ? `<div><strong>Producto:</strong> ${pedido.producto_base}</div>` : ''}
                                <div><strong>Servicio:</strong> ${getServicioText(pedido.tipo_servicio)}</div>
                                <div><strong>Cantidad:</strong> ${pedido.cantidad} unidades</div>
                                ${pedido.tamano ? `<div><strong>Tama√±o:</strong> ${pedido.tamano}</div>` : ''}
                                ${pedido.color ? `<div><strong>Color:</strong> ${pedido.color}</div>` : ''}
                                ${pedido.tamano_diseno ? `<div><strong>Tama√±o dise√±o:</strong> ${pedido.tamano_diseno}</div>` : ''}
                                ${pedido.cantidad_colores > 1 ? `<div><strong>Colores:</strong> ${pedido.cantidad_colores}</div>` : ''}
                            </div>
                            ${pedido.producto_foto ? `
                                <div style="margin-top: 15px;">
                                    <img src="${pedido.producto_foto}" style="max-width: 300px; border-radius: 8px; border: 2px solid #ddd;">
                                </div>
                            ` : ''}
                        </div>

                        <!-- Detalles de precio -->
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                            <h3 style="margin: 0 0 15px 0; color: #28a745;">üí∞ Detalles de Precio</h3>
                            <div style="display: grid; gap: 10px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Precio base:</span>
                                    <strong>${formatGuaranies(pedido.precio_base)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Precio servicio:</span>
                                    <strong>${formatGuaranies(pedido.precio_servicio)}</strong>
                                </div>
                                ${pedido.precio_extras > 0 ? `
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Extras:</span>
                                        <strong>${formatGuaranies(pedido.precio_extras)}</strong>
                                    </div>
                                ` : ''}
                                ${pedido.descuento_porcentaje > 0 ? `
                                    <div style="display: flex; justify-content: space-between; color: #dc3545;">
                                        <span>Descuento (${pedido.descuento_porcentaje}%):</span>
                                        <strong>-${formatGuaranies((pedido.precio_base + pedido.precio_servicio + pedido.precio_extras) * pedido.cantidad * pedido.descuento_porcentaje / 100)}</strong>
                                    </div>
                                ` : ''}
                                ${pedido.recargo_urgente > 0 && pedido.es_urgente ? `
                                    <div style="display: flex; justify-content: space-between; color: #ffc107;">
                                        <span>Recargo urgente (${pedido.recargo_urgente}%):</span>
                                        <strong>+${formatGuaranies(pedido.total * pedido.recargo_urgente / (100 + pedido.recargo_urgente))}</strong>
                                    </div>
                                ` : ''}
                                ${pedido.incluye_delivery ? `
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Delivery:</span>
                                        <strong>${formatGuaranies(pedido.precio_delivery)}</strong>
                                    </div>
                                ` : ''}
                                <div style="border-top: 2px solid #28a745; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-size: 18px;">
                                    <span><strong>TOTAL:</strong></span>
                                    <strong style="color: #28a745;">${formatGuaranies(pedido.total)}</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Opciones -->
                        ${pedido.es_urgente || pedido.incluye_delivery || pedido.diseno_personalizado ? `
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px;">
                                <h4 style="margin: 0 0 10px 0;">‚öôÔ∏è Opciones</h4>
                                ${pedido.es_urgente ? '<div>‚ö° Pedido urgente</div>' : ''}
                                ${pedido.incluye_delivery ? '<div>üöö Incluye delivery</div>' : ''}
                                ${pedido.diseno_personalizado ? '<div>üé® Dise√±o personalizado</div>' : ''}
                            </div>
                        ` : ''}

                        <!-- Observaciones -->
                        ${pedido.observaciones || pedido.notas_internas ? `
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                                <h3 style="margin: 0 0 15px 0; color: #667eea;">üìù Notas</h3>
                                ${pedido.observaciones ? `
                                    <div style="margin-bottom: 10px;">
                                        <strong>Observaciones del cliente:</strong>
                                        <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 5px;">${pedido.observaciones}</div>
                                    </div>
                                ` : ''}
                                ${pedido.notas_internas ? `
                                    <div>
                                        <strong>Notas internas:</strong>
                                        <div style="margin-top: 5px; padding: 10px; background: white; border-radius: 5px; border-left: 3px solid #ffc107;">${pedido.notas_internas}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Botones -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                            <button class="btn" onclick="closeDetallePedidoModal()" style="background: #6c757d; color: white;">Cerrar</button>
                            <button class="btn" onclick="closeDetallePedidoModal(); editPedido(${pedido.id});" style="background: #ffc107; color: #333;">‚úèÔ∏è Editar</button>
                            <button class="btn" onclick="closeDetallePedidoModal(); cambiarEstadoPedido(${pedido.id}, '${pedido.estado}');" style="background: #17a2b8; color: white;">üîÑ Cambiar Estado</button>
                        </div>
                    </div>
                `;

                modal.style.display = 'block';
            } catch (error) {
                console.error('Error al cargar detalle del pedido:', error);
                showAlert('‚ùå Error al cargar el pedido', 'error');
            }
        }

        // Cerrar modal de detalle
        function closeDetallePedidoModal() {
            document.getElementById('detallePedidoModal').style.display = 'none';
        }

        // Editar pedido
        async function editPedido(pedidoId) {
            try {
                const { data, error } = await supabase
                    .from('pedidos')
                    .select('*')
                    .eq('id', pedidoId)
                    .single();

                if (error) throw error;

                const pedido = data;

                // Abrir modal y cargar clientes
                await openNuevoPedidoModal();

                // Cambiar t√≠tulo
                document.getElementById('pedidoModalTitle').textContent = `‚úèÔ∏è Editar Pedido ${pedido.numero_pedido}`;

                // Llenar formulario
                document.getElementById('pedidoId').value = pedido.id;
                document.getElementById('pedidoClienteId').value = pedido.cliente_id;
                loadClienteData(pedido.cliente_id);
                document.getElementById('pedidoTipoServicio').value = pedido.tipo_servicio;
                updateServicioFields();
                // Intentar encontrar el producto en el selector
                const productoEncontrado = products.find(p => p.name === pedido.producto_base);
                if (productoEncontrado) {
                    document.getElementById('pedidoProductoBase').value = productoEncontrado.id;
                } else if (pedido.producto_base) {
                    // Producto personalizado
                    document.getElementById('pedidoProductoBase').value = '__custom__';
                    document.getElementById('pedidoProductoBaseCustom').style.display = 'block';
                    document.getElementById('pedidoProductoBaseCustom').value = pedido.producto_base;
                }
                document.getElementById('pedidoCantidad').value = pedido.cantidad;
                document.getElementById('pedidoTamano').value = pedido.tamano || '';
                document.getElementById('pedidoColor').value = pedido.color || '';
                document.getElementById('pedidoProductoFoto').value = pedido.producto_foto || '';
                document.getElementById('pedidoTamanoDiseno').value = pedido.tamano_diseno || '';
                document.getElementById('pedidoCantidadColores').value = pedido.cantidad_colores;
                document.getElementById('pedidoAreaGrabado').value = pedido.area_grabado || '';
                document.getElementById('pedidoPrecioBase').value = pedido.precio_base;
                document.getElementById('pedidoPrecioServicio').value = pedido.precio_servicio;
                document.getElementById('pedidoPrecioExtras').value = pedido.precio_extras;
                document.getElementById('pedidoDescuento').value = pedido.descuento_porcentaje;
                document.getElementById('pedidoRecargoUrgente').value = pedido.recargo_urgente;
                document.getElementById('pedidoEsUrgente').checked = pedido.es_urgente;
                document.getElementById('pedidoIncluyeDelivery').checked = pedido.incluye_delivery;
                toggleDelivery();
                document.getElementById('pedidoPrecioDelivery').value = pedido.precio_delivery;
                document.getElementById('pedidoDisenoPersonalizado').checked = pedido.diseno_personalizado;
                document.getElementById('pedidoFechaPedido').value = pedido.fecha_pedido;
                document.getElementById('pedidoFechaEntrega').value = pedido.fecha_entrega || '';
                document.getElementById('pedidoObservaciones').value = pedido.observaciones || '';
                document.getElementById('pedidoNotasInternas').value = pedido.notas_internas || '';

                calcularTotal();
            } catch (error) {
                console.error('Error al cargar pedido para editar:', error);
                showAlert('‚ùå Error al cargar el pedido', 'error');
            }
        }

        // Cambiar estado de pedido
        async function cambiarEstadoPedido(pedidoId, estadoActual) {
            const estados = [
                { value: 'presupuesto', label: 'Presupuesto', color: '#6c757d' },
                { value: 'confirmado', label: 'Confirmado', color: '#007bff' },
                { value: 'en_produccion', label: 'En Producci√≥n', color: '#ffc107' },
                { value: 'listo', label: 'Listo', color: '#17a2b8' },
                { value: 'entregado', label: 'Entregado', color: '#28a745' },
                { value: 'cancelado', label: 'Cancelado', color: '#dc3545' }
            ];

            let optionsHTML = estados.map(estado =>
                `<option value="${estado.value}" ${estado.value === estadoActual ? 'selected' : ''}>${estado.label}</option>`
            ).join('');

            const nuevoEstado = prompt(
                `Cambiar estado del pedido:\n\nEstado actual: ${getEstadoText(estadoActual)}\n\nIngresa el nuevo estado:\n` +
                estados.map(e => `- ${e.value}: ${e.label}`).join('\n')
            );

            if (!nuevoEstado) return;

            const estadoValido = estados.find(e => e.value === nuevoEstado.toLowerCase());
            if (!estadoValido) {
                alert('Estado no v√°lido');
                return;
            }

            try {
                const { error } = await supabase
                    .from('pedidos')
                    .update({ estado: estadoValido.value })
                    .eq('id', pedidoId);

                if (error) throw error;

                showAlert(`‚úÖ Estado cambiado a: ${estadoValido.label}`, 'success');
                await loadPedidos();
            } catch (error) {
                console.error('Error al cambiar estado:', error);
                showAlert('‚ùå Error al cambiar el estado', 'error');
            }
        }

        // Cancelar pedido
        async function cancelarPedido(pedidoId) {
            if (!confirm('¬øEst√°s seguro de que deseas cancelar este pedido?')) return;

            try {
                const { error } = await supabase
                    .from('pedidos')
                    .update({ estado: 'cancelado' })
                    .eq('id', pedidoId);

                if (error) throw error;

                showAlert('‚úÖ Pedido cancelado', 'success');
                await loadPedidos();
            } catch (error) {
                console.error('Error al cancelar pedido:', error);
                showAlert('‚ùå Error al cancelar el pedido', 'error');
            }
        }

        // Funciones auxiliares
        function getEstadoColor(estado) {
            const colors = {
                'presupuesto': '#6c757d',
                'confirmado': '#007bff',
                'en_produccion': '#ffc107',
                'listo': '#17a2b8',
                'entregado': '#28a745',
                'cancelado': '#dc3545'
            };
            return colors[estado] || '#999';
        }

        function getEstadoText(estado) {
            const texts = {
                'presupuesto': 'Presupuesto',
                'confirmado': 'Confirmado',
                'en_produccion': 'En Producci√≥n',
                'listo': 'Listo',
                'entregado': 'Entregado',
                'cancelado': 'Cancelado'
            };
            return texts[estado] || estado;
        }

        function getServicioText(servicio) {
            const texts = {
                'sublimacion': 'Sublimaci√≥n',
                'grabado_laser': 'Grabado L√°ser',
                'bordado': 'Bordado',
                'otro': 'Otro'
            };
            return texts[servicio] || servicio;
        }

        function isPedidoUrgente(pedido) {
            if (!pedido.fecha_entrega) return false;
            const entrega = new Date(pedido.fecha_entrega);
            const hoy = new Date();
            const diffDays = Math.ceil((entrega - hoy) / (1000 * 60 * 60 * 24));
            return diffDays <= 3 || pedido.es_urgente;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-PY', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

    </script>

    <!-- MODAL DE CATEGOR√çAS -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gestionar Categor√≠as</h2>
                <span class="close-btn" onclick="closeCategoryModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px;">
                    <label>Nueva Categor√≠a</label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="newCategoryName" placeholder="Nombre de la categor√≠a" style="flex:1;" oninput="capitalizeFirst(this)">
                        <button class="btn btn-primary" onclick="addCategory()">‚ûï Agregar</button>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom:10px;">Categor√≠as actuales:</h3>
                    <div id="categoriesList" style="max-height:300px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal de Nuevo Pedido -->
    <div id="nuevoPedidoModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="pedidoModalTitle">üìù Nuevo Pedido</h2>
                <span class="close-btn" onclick="closeNuevoPedidoModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <form id="pedidoForm" onsubmit="savePedido(event)">
                    <input type="hidden" id="pedidoId">

                    <!-- Informaci√≥n del Cliente -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">üë§ Informaci√≥n del Cliente</h3>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Cliente *</label>
                                <select id="pedidoClienteId" required onchange="loadClienteData(this.value)" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Seleccionar cliente...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="text" id="pedidoClienteTelefono" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="pedidoClienteEmail" readonly style="background: #f5f5f5;">
                        </div>
                    </div>

                    <!-- Tipo de Servicio -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #667eea;">üé® Tipo de Servicio</h3>
                            <button type="button" class="btn btn-secondary" onclick="openGestionServiciosModal()" style="font-size: 12px; padding: 8px 12px;">‚öôÔ∏è Gestionar Servicios</button>
                        </div>
                        <div class="form-group">
                            <label>Servicio *</label>
                            <select id="pedidoTipoServicio" required onchange="updateServicioFields()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">Seleccionar servicio...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Detalles del Producto -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">üì¶ Detalles del Producto</h3>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group" style="position: relative;">
                                <label>Producto Base</label>

                                <!-- Bot√≥n para abrir dropdown -->
                                <div id="productoBaseSelector" onclick="toggleProductosDropdown()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                    <span id="productoBaseSelectorText" style="color: #999;">Seleccionar producto...</span>
                                    <span style="font-size: 12px;">‚ñº</span>
                                </div>

                                <!-- Dropdown con buscador y listado -->
                                <div id="productosBaseDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px; background: white; border: 2px solid #667eea; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 350px; overflow: hidden;">
                                    <!-- Buscador -->
                                    <div style="padding: 10px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
                                        <input type="text" id="searchProductoBase" placeholder="üîç Buscar producto..." style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px;" oninput="filterProductosBase()" onclick="event.stopPropagation()">
                                    </div>

                                    <!-- Listado con fotos -->
                                    <div id="productosBaseList" style="max-height: 290px; overflow-y: auto;">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>

                                <!-- Input oculto -->
                                <input type="hidden" id="pedidoProductoBase">
                                <input type="hidden" id="pedidoPrecioBase">
                                <input type="hidden" id="pedidoProductoFoto">

                                <!-- Input personalizado -->
                                <input type="text" id="pedidoProductoBaseCustom" placeholder="Nombre del producto" style="display: none; margin-top: 10px; width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;" oninput="capitalizeFirst(this)">
                            </div>
                            <div class="form-group">
                                <label>Cantidad *</label>
                                <input type="number" id="pedidoCantidad" value="1" min="1" required onchange="calcularTotal()">
                            </div>
                        </div>

                        <!-- Material del Producto (solo para personalizado) -->
                        <div id="materialProductoGroup" class="form-group" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="margin: 0;">Material del Producto</label>
                                <button type="button" class="btn btn-secondary" onclick="openGestionMaterialesModal()" style="font-size: 11px; padding: 6px 10px;">‚öôÔ∏è Gestionar</button>
                            </div>
                            <select id="pedidoMaterial" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">Seleccionar...</option>
                            </select>
                            <input type="text" id="pedidoMaterialOtro" placeholder="Especificar material" style="display: none; margin-top: 10px; width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;" oninput="capitalizeFirst(this)">
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Tama√±o (opcional)</label>
                                <select id="pedidoTamano" onchange="calcularTotal()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Seleccionar...</option>
                                    <option value="unico">Tama√±o √∫nico</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Color</label>
                                <input type="text" id="pedidoColor" placeholder="Ej: Blanco, Negro, Azul" oninput="capitalizeFirst(this)">
                            </div>
                        </div>
                    </div>

                    <!-- Detalles del Dise√±o/Servicio -->
                    <div id="servicioDetails" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; display: none;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">‚ú® Detalles del Dise√±o</h3>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Tama√±o del Dise√±o</label>
                                <select id="pedidoTamanoDiseno" onchange="calcularTotal()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Seleccionar...</option>
                                    <option value="pequeno">Peque√±o</option>
                                    <option value="mediano">Mediano</option>
                                    <option value="grande">Grande</option>
                                    <option value="full">Full Print</option>
                                </select>
                            </div>
                            <div class="form-group" id="coloresGroup">
                                <label>Cantidad de Colores</label>
                                <input type="number" id="pedidoCantidadColores" value="1" min="1" max="10" onchange="calcularTotal()">
                            </div>
                        </div>
                        <div id="areaGrabadoGroup" style="display: none;">
                            <!-- Tipo de Grabado -->
                            <div class="form-group">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label style="margin: 0;">Tipo de Grabado</label>
                                    <button type="button" class="btn btn-secondary" onclick="openGestionTiposGrabadoModal()" style="font-size: 11px; padding: 6px 10px;">‚öôÔ∏è Gestionar</button>
                                </div>
                                <select id="pedidoTipoGrabado" onchange="updatePreciosPorTipoGrabado()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                    <option value="">Seleccionar tipo...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>√Årea de Grabado</label>
                                <input type="text" id="pedidoAreaGrabado" placeholder="Ej: 10x10cm">
                            </div>

                            <!-- Precios para Grabado L√°ser -->
                            <div style="margin-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <label style="margin: 0; font-weight: bold;">‚ö° Precios de Grabado L√°ser</label>
                                </div>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label>üíµ Precio Minorista (‚Ç≤)</label>
                                        <input type="number" id="pedidoPrecioMinorista" value="0" min="0" step="1000" onchange="calcularTotal()" placeholder="Precio para venta individual">
                                    </div>
                                    <div class="form-group">
                                        <label>üì¶ Precio Mayorista (‚Ç≤)</label>
                                        <input type="number" id="pedidoPrecioMayorista" value="0" min="0" step="1000" onchange="calcularTotal()" placeholder="Precio para venta por cantidad">
                                    </div>
                                </div>
                            </div>

                            <!-- √Årea de carga de foto para Grabado L√°ser -->
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">üì∏ Foto del Dise√±o/Producto</label>
                                <div style="border: 2px dashed #667eea; border-radius: 8px; padding: 20px; background: #f9f9f9; text-align: center; cursor: pointer; transition: all 0.3s;"
                                     ondragover="event.preventDefault(); event.stopPropagation(); this.style.background='#e8f0fe'; this.style.borderColor='#4285f4';"
                                     ondragleave="event.preventDefault(); event.stopPropagation(); this.style.background='#f9f9f9'; this.style.borderColor='#667eea';"
                                     ondrop="handlePedidoDrop(event)"
                                     onclick="document.getElementById('pedidoImageInput').click()">
                                    <p style="margin: 0; color: #666;">üñºÔ∏è Arrastra una imagen aqu√≠ o haz clic para seleccionar</p>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <input type="file" id="pedidoImageInput" accept="image/*" style="display: none;" onchange="handlePedidoImageSelect(event)">
                                    <button type="button" class="btn btn-primary" onclick="document.getElementById('pedidoImageInput').click()" style="flex: 1; font-size: 13px;">üìÅ Subir Archivo</button>
                                    <button type="button" class="btn btn-primary" onclick="takePedidoPhoto()" style="flex: 1; font-size: 13px;">üì∑ Tomar Foto</button>
                                </div>
                                <div id="pedidoImagePreview" style="margin-top: 10px; display: none; text-align: center;">
                                    <img id="pedidoPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                                    <button type="button" class="btn btn-danger" onclick="clearPedidoImage()" style="display: block; margin: 10px auto 0; width: 200px; font-size: 12px;">üóëÔ∏è Eliminar Foto</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Precios y C√°lculos -->
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <h3 style="margin: 0 0 15px 0; color: #28a745;">üí∞ Precios y C√°lculos</h3>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Precio Base (‚Ç≤) <small style="color: #999;">Autom√°tico</small></label>
                                <input type="number" id="pedidoPrecioBase" value="0" min="0" step="1000" readonly style="background: #f0f0f0; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label>Precio Servicio (‚Ç≤) <small style="color: #999;">Autom√°tico</small></label>
                                <input type="number" id="pedidoPrecioServicio" value="0" min="0" step="1000" readonly style="background: #f0f0f0; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label>Extras (‚Ç≤) <small style="color: #999;">Autom√°tico</small></label>
                                <input type="number" id="pedidoPrecioExtras" value="0" min="0" step="1000" readonly style="background: #f0f0f0; cursor: not-allowed;">
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Descuento (%)</label>
                                <input type="number" id="pedidoDescuento" value="0" min="0" max="100" step="5" onchange="calcularTotal()">
                            </div>
                            <div class="form-group">
                                <label>Recargo Urgente (%)</label>
                                <input type="number" id="pedidoRecargoUrgente" value="20" min="0" max="100" step="5" onchange="calcularTotal()">
                            </div>
                        </div>
                    </div>

                    <!-- Opciones Adicionales -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">‚öôÔ∏è Opciones Adicionales</h3>
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="pedidoEsUrgente" onchange="calcularTotal()" style="width: 20px; height: 20px;">
                                <span>‚ö° Es urgente (aplica recargo)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="pedidoIncluyeDelivery" onchange="toggleDelivery()" style="width: 20px; height: 20px;">
                                <span>üöö Incluye delivery</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="pedidoDisenoPersonalizado" style="width: 20px; height: 20px;">
                                <span>üé® Dise√±o personalizado</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="pedidoParaRegalo" onchange="togglePaqueteRegalo()" style="width: 20px; height: 20px;">
                                <span>üéÅ Para regalo</span>
                            </label>
                        </div>
                        <div class="form-group" id="deliveryPriceGroup" style="display: none;">
                            <label>Precio Delivery (‚Ç≤)</label>
                            <input type="number" id="pedidoPrecioDelivery" value="15000" min="0" step="1000" onchange="calcularTotal()">
                        </div>
                        <div class="form-group" id="paqueteRegaloGroup" style="display: none;">
                            <label>Paquete de Regalo</label>
                            <select id="pedidoPaqueteRegalo" onchange="updatePrecioExtrasFromPaquete()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                <option value="">Seleccionar paquete...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fechas -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">üìÖ Fechas</h3>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Fecha de Pedido</label>
                                <input type="date" id="pedidoFechaPedido" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Entrega</label>
                                <input type="date" id="pedidoFechaEntrega">
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #667eea;">üìù Observaciones</h3>
                        <div class="form-group">
                            <label>Observaciones del Cliente</label>
                            <textarea id="pedidoObservaciones" rows="3" placeholder="Detalles especiales del pedido..." oninput="capitalizeFirst(this)"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Notas Internas</label>
                            <textarea id="pedidoNotasInternas" rows="2" placeholder="Notas privadas (no visible para el cliente)..." oninput="capitalizeFirst(this)"></textarea>
                        </div>
                    </div>

                    <!-- Total -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 18px; margin-bottom: 5px; opacity: 0.9;">TOTAL</div>
                        <div id="pedidoTotalDisplay" style="font-size: 36px; font-weight: bold;">‚Ç≤ 0</div>
                        <div id="pedidoSubtotalInfo" style="font-size: 14px; margin-top: 10px; opacity: 0.8;"></div>
                    </div>

                    <!-- Botones -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeNuevoPedidoModal()" style="background: #6c757d; color: white;">Cancelar</button>
                        <button type="submit" class="btn btn-success" id="savePedidoBtn">üíæ Guardar Pedido</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalle de Pedido -->
    <div id="detallePedidoModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="detallePedidoTitle">üìù Detalle del Pedido</h2>
                <span class="close-btn" onclick="closeDetallePedidoModal()">‚úñ</span>
            </div>
            <div class="modal-body" id="detallePedidoContent">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Servicios -->
    <div id="gestionServiciosModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gesti√≥n de Servicios</h2>
                <span class="close-btn" onclick="closeGestionServiciosModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar servicio -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0;">‚ûï Agregar Nuevo Servicio</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nuevoServicioNombre" placeholder="Nombre del servicio (ej: Serigraf√≠a)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <button type="button" class="btn btn-primary" onclick="agregarNuevoServicio()">Agregar</button>
                    </div>
                </div>

                <!-- Lista de servicios -->
                <div>
                    <h3 style="margin: 0 0 15px 0;">üìã Servicios Actuales</h3>
                    <div id="serviciosListContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Materiales -->
    <div id="gestionMaterialesModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gesti√≥n de Materiales</h2>
                <span class="close-btn" onclick="closeGestionMaterialesModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar material -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0;">‚ûï Agregar Nuevo Material</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nuevoMaterialNombre" placeholder="Nombre del material (ej: Cuero)" style="flex: 1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <button type="button" class="btn btn-primary" onclick="agregarNuevoMaterial()">Agregar</button>
                    </div>
                </div>

                <!-- Lista de materiales -->
                <div>
                    <h3 style="margin: 0 0 15px 0;">üìã Materiales Actuales</h3>
                    <div id="materialesListContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Precios de Grabado L√°ser -->
    <div id="gestionPreciosGrabadoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚ö° Gesti√≥n de Precios - Grabado L√°ser</h2>
                <span class="close-btn" onclick="closeGestionPreciosGrabadoModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <!-- Configuraci√≥n de precios -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="margin: 0 0 15px 0;">üí∞ Configurar Precios Predeterminados</h3>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                        Estos precios se aplicar√°n autom√°ticamente cuando selecciones el servicio de Grabado L√°ser.
                    </p>

                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>üíµ Precio Minorista (‚Ç≤)</label>
                        <input type="number" id="configPrecioMinorista" value="15000" min="0" step="1000" oninput="updatePreciosPreview()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <small style="color: #666; font-size: 11px;">Precio para ventas individuales</small>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>üì¶ Precio Mayorista (‚Ç≤)</label>
                        <input type="number" id="configPrecioMayorista" value="10000" min="0" step="1000" oninput="updatePreciosPreview()" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <small style="color: #666; font-size: 11px;">Precio para ventas por cantidad</small>
                    </div>

                    <button type="button" class="btn btn-success" onclick="guardarPreciosGrabado()" style="width: 100%;">üíæ Guardar Configuraci√≥n</button>
                </div>

                <!-- Vista previa -->
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 10px 0; color: #28a745; font-size: 14px;">‚ÑπÔ∏è Vista Previa</h4>
                    <div style="font-size: 13px; color: #555;">
                        <div style="margin-bottom: 5px;">
                            ‚Ä¢ Al seleccionar <strong>Grabado L√°ser</strong>, se aplicar√°:
                        </div>
                        <div style="margin-left: 20px; margin-top: 5px;">
                            <div>‚Üí Minorista: <span id="previewMinorista" style="font-weight: bold; color: #28a745;">‚Ç≤15.000</span></div>
                            <div>‚Üí Mayorista: <span id="previewMayorista" style="font-weight: bold; color: #28a745;">‚Ç≤10.000</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Tipos de Grabado -->
    <div id="gestionTiposGrabadoModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gesti√≥n de Tipos de Grabado</h2>
                <span class="close-btn" onclick="closeGestionTiposGrabadoModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <!-- Formulario para agregar tipo de grabado -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0;">‚ûï Agregar Nuevo Tipo de Grabado</h3>
                    <input type="hidden" id="editTipoGrabadoIndex" value="">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Nombre del Tipo (ej: Nombre, Nombre y Apellido, Frase Corta)</label>
                        <input type="text" id="nuevoTipoGrabadoNombre" placeholder="Ej: Nombre y Apellido" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>üíµ Precio Minorista (‚Ç≤)</label>
                            <input type="number" id="nuevoTipoGrabadoPrecioMinorista" value="0" min="0" step="1000" placeholder="Ej: 20000" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label>üì¶ Precio Mayorista (‚Ç≤)</label>
                            <input type="number" id="nuevoTipoGrabadoPrecioMayorista" value="0" min="0" step="1000" placeholder="Ej: 15000" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        </div>
                    </div>
                    <button type="button" id="btnAgregarTipoGrabado" class="btn btn-primary" onclick="agregarNuevoTipoGrabado()" style="width: 100%;">‚ûï Agregar Tipo</button>
                </div>

                <!-- Lista de tipos de grabado -->
                <div>
                    <h3 style="margin: 0 0 15px 0;">üìã Tipos de Grabado Actuales</h3>
                    <div id="tiposGrabadoListContainer" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    </body>
</html>
