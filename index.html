<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=10.0, user-scalable=yes">
    <title>TURISTA PARAGUAY - Sistema de Inventario</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            max-width: 100%;
            overflow-x: hidden;
            /* Permitir zoom con dedos */
            touch-action: manipulation;
        }

        body {
            max-width: 100%;
            overflow-x: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            /* Permitir zoom con dedos */
            touch-action: manipulation;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #764ba2;
        }

        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f5f5f5;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            color: #333;
        }

        tbody tr:hover {
            background: #f9f9f9;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #4CAF50;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-danger {
            background: #f44336;
            color: white;
        }

        .badge-info {
            background: #2196F3;
            color: white;
        }

        .action-btns {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 500;
            z-index: 10001;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .low-stock-alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .unit-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            /* Layout general m√≥vil */
            .container {
                padding: 10px;
                width: 100%;
                overflow-x: hidden;
            }

            .form-row, .form-row-3 {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            .header {
                flex-direction: column;
                gap: 12px;
                padding: 15px;
                width: 100%;
            }

            .header h1 {
                font-size: 20px;
                text-align: center;
            }

            .logo {
                font-size: 20px;
            }

            /* Navegaci√≥n m√≥vil mejorada */
            .nav {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .nav-btn {
                width: 100%;
                padding: 12px;
                font-size: 14px;
                text-align: center;
                white-space: normal;
            }

            /* Formularios m√°s amigables */
            .form-group {
                width: 100%;
            }

            .form-group label {
                font-size: 13px;
                font-weight: 600;
            }

            input, select, textarea {
                font-size: 16px !important;
                padding: 12px;
                width: 100%;
                max-width: 100%;
            }

            /* Botones m√°s grandes para dedos */
            .btn {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 48px;
                width: 100%;
            }

            .action-btn {
                padding: 10px 14px;
                min-width: 44px;
                min-height: 44px;
            }

            /* Contenedores de botones en m√≥vil */
            .modal-content > form > div:last-child,
            .section > div > button {
                width: 100%;
            }

            /* Alinear botones de acci√≥n en filas verticales */
            .action-btns {
                display: flex;
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
                width: 100%;
            }

            .action-btns .action-btn {
                width: 100%;
                justify-content: center;
            }

            /* TODOS los contenedores flex con botones */
            div[style*="display: flex"],
            div[style*="display:flex"] {
                flex-wrap: wrap !important;
            }

            div[style*="display: flex"][style*="gap"],
            div[style*="display:flex"][style*="gap"] {
                flex-direction: column !important;
                gap: 10px !important;
                width: 100% !important;
            }

            div[style*="display: flex"] > button,
            div[style*="display:flex"] > button,
            div[style*="display: flex"] > .btn,
            div[style*="display:flex"] > .btn {
                width: 100% !important;
                flex: 1 1 100% !important;
            }

            /* Tablas responsivas */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }

            table {
                font-size: 11px;
                min-width: 600px;
            }

            table th, table td {
                padding: 8px 4px;
                white-space: nowrap;
            }

            /* Cards m√°s compactas */
            .stat-card {
                padding: 15px;
                width: 100%;
            }

            .stat-value {
                font-size: 20px !important;
            }

            /* Modal casi full screen en m√≥vil */
            .modal {
                padding: 5px;
            }

            .modal-content {
                width: 98% !important;
                max-width: 98% !important;
                margin: 5px auto;
                max-height: 95vh;
                overflow-y: auto;
            }

            .modal-header {
                padding: 15px;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-body {
                padding: 15px;
            }

            /* Selector de productos m√°s grande */
            .custom-select-button {
                padding: 14px;
                font-size: 15px;
                width: 100%;
            }

            .custom-dropdown {
                max-height: 60vh;
                overflow-y: auto;
            }

            .product-option {
                padding: 12px;
                min-height: 60px;
            }

            .product-option-image {
                width: 50px;
                height: 50px;
            }

            /* Toast m√°s visible en m√≥vil */
            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 14px;
            }

            /* Carrito m√°s compacto */
            #cartSection {
                padding: 15px;
                width: 100%;
            }

            #cartSection table {
                font-size: 11px;
            }

            /* Mejorar espaciado general */
            .section {
                padding: 15px;
                width: 100%;
                margin-bottom: 15px;
            }

            h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            h3 {
                font-size: 16px;
            }

            /* Header de secciones con botones */
            .section > div[style*="display: flex"][style*="justify-content: space-between"],
            .section > div[style*="display:flex"][style*="justify-content:space-between"] {
                flex-direction: column !important;
                gap: 12px !important;
                align-items: stretch !important;
            }

            .section > div[style*="display: flex"][style*="justify-content: space-between"] > h2,
            .section > div[style*="display:flex"][style*="justify-content:space-between"] > h2 {
                text-align: center;
            }

            /* Botones de carrito */
            #cartSection > div:last-child,
            #cartSection div[style*="display:flex"],
            #cartSection div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 10px !important;
                width: 100% !important;
            }

            #cartSection > div:last-child > button,
            #cartSection div[style*="display:flex"] > button,
            #cartSection div[style*="display: flex"] > button {
                width: 100% !important;
                flex: none !important;
            }

            /* Info boxes */
            .info-box {
                padding: 12px;
                font-size: 13px;
                margin-bottom: 15px;
            }
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }

        /* Estilos para detalles del producto */
        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .product-detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .product-detail-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .product-detail-value {
            font-size: 16px;
            color: #212529;
            font-weight: 500;
        }

        .product-image-container {
            grid-column: 1 / -1;
            text-align: center;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .product-image-large {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .product-description-box {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        @media (max-width: 768px) {
            .product-details-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
        }
    
        /* Selector personalizado con im√°genes */
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        
        .custom-select-button {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }
        
        .custom-select-button:hover {
            border-color: #667eea;
        }
        
        .custom-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .product-option {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .product-option:hover {
            background: #f5f5f5;
        }
        
        .product-option:last-child {
            border-bottom: none;
        }
        
        .product-option-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 12px;
            border: 1px solid #ddd;
        }
        
        .product-option-no-image {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 5px;
            margin-right: 12px;
            font-size: 24px;
        }
        
        .product-option-info {
            flex: 1;
        }
        
        .product-option-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }
        
        .product-option-details {
            font-size: 12px;
            color: #666;
        }

        </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üáµüáæ TURISTA PARAGUAY - Sistema de Inventario</div>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" onclick="showSection('products')">üì¶ Productos</button>
                <button class="nav-btn" onclick="showSection('clients')">üë• Clientes</button>
                <button class="nav-btn" onclick="showSection('sales')">üí∞ Ventas</button>
                <button class="nav-btn" onclick="showSection('reports')">üìà Reportes</button>
            </div>
        </div>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 20px;">Dashboard General</h2>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-warning" onclick="migrateLocalStorageToSupabase()" style="width: 100%;">Migrar Datos desde localStorage</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Productos</div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">en inventario</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Valor Total Inventario</div>
                        <div class="stat-value" id="totalValue">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ventas Hoy</div>
                        <div class="stat-value" id="todaySales">‚Ç≤0</div>
                        <div class="stat-label">guaran√≠es</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Stock Bajo</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div class="stat-label">productos</div>
                    </div>
                </div>

                <div id="lowStockAlerts"></div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Productos M√°s Vendidos</h3>
                <div class="table-container">
                    <table id="topProductsTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Cantidad Vendida</th>
                                <th>Ingresos</th>
                            </tr>
                        </thead>
                        <tbody id="topProductsBody">
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <div class="empty-state-icon">üì¶</div>
                                    <div>No hay datos de ventas a√∫n</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PRODUCTOS -->
            <div id="products" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Productos</h2>
                    <button class="btn btn-primary" onclick="openProductModal()">‚ûï Agregar Producto</button>
                </div>

                <div class="info-box">
                    <div class="info-box-title">üí° Sistema con Unidades de Medida</div>
                    <div>Ahora puedes gestionar productos con diferentes unidades: unidades, metros, hojas, paquetes, litros, kilos, etc.</div>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchProducts" placeholder="üîç Buscar productos..." onkeyup="filterProducts()">
                    <select id="categoryFilter" onchange="filterProducts()">
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Marca</th>
                                <th>Categor√≠a</th>
                                <th>Stock</th>
                                <th>Precio de Venta</th>
                                <th>Imagen</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CLIENTES -->
            <div id="clients" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gesti√≥n de Clientes</h2>
                    <button class="btn btn-primary" onclick="openClientModal()">‚ûï Nuevo Cliente</button>
                </div>

                <div class="search-bar">
                    <input type="text" id="searchClients" placeholder="üîç Buscar clientes por nombre, documento o tel√©fono..." onkeyup="filterClients()">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre Completo</th>
                                <th>Documento</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Ciudad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VENTAS -->
            <div id="sales" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Registrar Venta</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Seleccionar Producto</label>
                        <!-- Selector personalizado con im√°genes -->
                        <div class="custom-select-container">
                            <div id="customSelectButton" class="custom-select-button" onclick="toggleProductDropdown()">
                                <span id="selectedProductText">-- Seleccionar Producto --</span>
                                <span style="float:right;">‚ñº</span>
                            </div>
                            <div id="productDropdown" class="custom-dropdown" style="display:none;">
                                <input type="text" id="productSearchInput" placeholder="üîç Buscar producto..." onkeyup="filterProductOptions()" style="width:100%;padding:10px;border:none;border-bottom:2px solid #eee;box-sizing:border-box;">
                                <div id="productOptionsList" style="max-height:300px;overflow-y:auto;">
                                    <!-- Las opciones se cargan din√°micamente -->
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="saleProduct">
                    </div>
                    <div class="form-group">
                        <label>Cantidad <span id="saleUnitLabel"></span></label>
                        <input type="number" id="saleQuantity" min="1" step="1" value="1" onchange="updateSaleTotal()" onfocus="this.select()">
                    </div>
                </div>

                <!-- Preview de imagen del producto seleccionado -->
                <div id="saleProductImagePreview" style="display:none; margin-bottom:15px;">
                    <button type="button" onclick="toggleImagePreview()" style="width:100%; padding:8px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:space-between; transition:all 0.2s;">
                        <span style="font-size:13px; color:#495057; font-weight:500;">üì∏ Ver imagen de referencia</span>
                        <span id="imageToggleIcon" style="font-size:12px; color:#6c757d;">‚ñº</span>
                    </button>
                    <div id="imagePreviewContent" style="display:none; margin-top:10px; padding:10px; background:#f8f9fa; border-radius:6px; border-left:4px solid #667eea;">
                        <img id="saleProductImage" style="width:100%; max-width:300px; height:auto; border-radius:6px; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); display:block; margin:0 auto;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio Unitario</label>
                        <input type="text" id="salePrice" readonly style="text-align:left; font-weight:bold;">
                    </div>
                    <div class="form-group">
                        <label>Subtotal Item</label>
                        <input type="text" id="saleTotal" readonly style="font-weight:bold; font-size:18px; text-align:left;">
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addToCart()" style="width: 100%; font-size: 16px;">üõí Agregar al Carrito</button>
                </div>

                <!-- Carrito de Compras -->
                <div id="cartSection" style="display:none; background:#f8f9fa; padding:20px; border-radius:10px; margin-bottom:20px;">
                    <h3 style="margin:0 0 15px 0;">üõí Carrito de Compras</h3>
                    <div class="table-container" style="margin-bottom:15px;">
                        <table style="font-size:14px;">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>P. Unit.</th>
                                    <th>Subtotal</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="cartItems">
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align:right; padding:10px; background:white; border-radius:5px; margin-bottom:15px;">
                        <strong style="font-size:18px;">Total Venta: <span id="cartTotal" style="color:#28a745;">Gs. 0</span></strong>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Cliente *</label>
                            <select id="saleCustomer" required>
                                <option value="">-- Seleccionar Cliente --</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn btn-primary" onclick="openClientModal()" style="width: 100%;">‚ûï Nuevo Cliente</button>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="completeSale()" style="flex: 1; font-size: 16px;">‚úÖ Completar Venta</button>
                        <button class="btn btn-danger" onclick="clearCart()" style="padding: 10px 20px;">üóëÔ∏è Vaciar</button>
                    </div>
                </div>

                <h3 style="margin-top: 40px; margin-bottom: 15px;">Historial de Ventas</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Marca</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Cliente</th>
                            </tr>
                        </thead>
                        <tbody id="salesHistoryBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTES -->
            <div id="reports" class="section">
                <h2 style="margin-bottom: 20px;">Reportes y Estad√≠sticas</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (Mes)</div>
                        <div class="stat-value" id="monthSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Ventas (A√±o)</div>
                        <div class="stat-value" id="yearSales">‚Ç≤0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Transacciones</div>
                        <div class="stat-value" id="totalSoldUnits">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Categor√≠a M√°s Vendida</div>
                        <div class="stat-value" style="font-size: 24px;" id="topCategory">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">Ventas por Categor√≠a</h3>
                    <div id="categoryReport"></div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="exportData()">üì• Exportar Datos (JSON)</button>
                    <button class="btn btn-warning" onclick="generateCSVReport()">üìä Exportar Reporte (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Agregar Producto</h2>
                <button class="close-btn" onclick="closeProductModal()">&times;</button>
            </div>

            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">

                <!-- Secci√≥n de vista previa del producto (solo visible en edici√≥n) -->
                <div id="productDetailView" style="display:none;background:#f5f5f5;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <div style="display:grid;grid-template-columns:200px 1fr;gap:20px;align-items:start;">
                        <div>
                            <img id="detailProductImage" style="width:100%;border-radius:8px;border:2px solid #ddd;display:none;">
                            <div id="noImagePlaceholder" style="width:100%;height:200px;background:#e0e0e0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;">
                                üì¶ Sin imagen
                            </div>
                        </div>
                        <div>
                            <h3 id="detailProductName" style="margin:0 0 15px 0;color:#667eea;"></h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #ff6b6b;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üí∞ Precio de Compra</div>
                                    <div id="detailCostPrice" style="font-size:20px;font-weight:bold;color:#ff6b6b;"></div>
                                </div>
                                <div style="background:white;padding:15px;border-radius:8px;border-left:4px solid #51cf66;">
                                    <div style="font-size:12px;color:#666;margin-bottom:5px;">üíµ Precio de Venta</div>
                                    <div id="detailSalePrice" style="font-size:20px;font-weight:bold;color:#51cf66;"></div>
                                </div>
                            </div>
                            <div style="margin-top:15px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <div>
                                    <span style="font-size:12px;color:#666;">Stock:</span>
                                    <strong id="detailStock" style="margin-left:5px;"></strong>
                                </div>
                                <div>
                                    <span style="font-size:12px;color:#666;">Estado:</span>
                                    <span id="detailStatus" style="margin-left:5px;"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Producto *</label>
                        <input type="text" id="productCode" required placeholder="Ej: TP-001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a *</label>
                        <select id="productCategory" required>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openCategoryModal()" style="margin-top:10px;width:100%;">‚öôÔ∏è Gestionar Categor√≠as</button>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Producto *</label>
                        <input type="text" id="productName" required placeholder="Ej: Remera Paraguay" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="productBrand" placeholder="Ej: Nike, Adidas (opcional)" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label>Stock *</label>
                        <input type="number" id="productStock" required min="0" step="1" placeholder="Cantidad">
                    </div>
                    <div class="form-group">
                        <label>Unidad de Medida *</label>
                        <select id="productUnit" required>
                            <option value="unidades">Unidades</option>
                            <option value="metros">Metros</option>
                            <option value="hojas">Hojas</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="litros">Litros</option>
                            <option value="kilos">Kilos</option>
                            <option value="gramos">Gramos</option>
                            <option value="cajas">Cajas</option>
                            <option value="rollos">Rollos</option>
                            <option value="pares">Pares</option>
                            <option value="docenas">Docenas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="productMinStock" min="0" step="1" value="3" placeholder="M√≠nimo">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Precio de Costo (‚Ç≤)</label>
                        <input type="text" id="productCost" placeholder="Ej: 50.000" oninput="formatPriceInput(this)">
                    </div>
                    <div class="form-group">
                        <label>Precio de Venta (‚Ç≤) *</label>
                        <input type="text" id="productPrice" required placeholder="Ej: 100.000" oninput="formatPriceInput(this)">
                    </div>
                </div>

               <!-- Campo de Foto -->
<div class="form-group">
    <label>üì∏ Foto del Producto (Opcional)</label>
    <div id="dropZone" style="border:2px dashed #ccc;border-radius:5px;padding:20px;text-align:center;background:#f9f9f9;margin-bottom:10px;cursor:pointer;"
         ondragenter="event.preventDefault();event.stopPropagation();this.style.background='#e3f2fd';"
         ondragover="event.preventDefault();event.stopPropagation();this.style.background='#e3f2fd';"
         ondragleave="event.preventDefault();event.stopPropagation();this.style.background='#f9f9f9';"
         ondrop="handleDrop(event)"
         onclick="document.getElementById('productImage').click()">
        <p style="margin:0;color:#666;">üñºÔ∏è Arrastra una imagen aqu√≠ o haz clic para seleccionar</p>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:10px;">
        <input type="file" id="productImage" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('productImage').click()">üìÅ Subir Archivo</button>
        <button type="button" class="btn btn-primary" onclick="takePhoto()">üì∑ Tomar Foto</button>
    </div>
    <div id="imagePreview" style="margin-top:10px;display:none;">
        <img id="previewImg" style="max-width:200px;max-height:200px;border-radius:5px;border:2px solid #ddd;">
        <button type="button" class="btn btn-danger" onclick="clearImage()" style="display:block;margin-top:10px;width:200px;">üóëÔ∏è Eliminar Foto</button>
    </div>
</div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cliente -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle">Agregar Cliente</h2>
            <form id="clientForm" onsubmit="saveClient(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>C√≥digo del Cliente *</label>
                        <input type="text" id="clientCode" required placeholder="CL-0001" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Tipo de Documento *</label>
                        <select id="clientDocType" required>
                            <option value="CI">C√©dula de Identidad</option>
                            <option value="RUC">RUC</option>
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>N√∫mero de Documento *</label>
                        <input type="text" id="clientDocNumber" required placeholder="Ej: 1.234.567" oninput="formatDocumentNumber(this)">
                    </div>
                    <div class="form-group">
                        <label>Nombre Completo *</label>
                        <input type="text" id="clientName" required placeholder="Nombre y Apellido" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tel√©fono *</label>
                        <input type="tel" id="clientPhone" required placeholder="Ej: 0981234567">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="clientEmail" placeholder="correo@ejemplo.com">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ciudad *</label>
                        <input type="text" id="clientCity" required placeholder="Ej: Asunci√≥n" oninput="capitalizeFirst(this)">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="clientAddress" placeholder="Direcci√≥n completa" oninput="capitalizeFirst(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="clientNotes" rows="2" placeholder="Notas adicionales (opcional)" oninput="capitalizeFirst(this)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Guardar Cliente</button>
                    <button type="button" class="btn btn-danger" onclick="closeClientModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalles del Producto -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üì¶ Detalles del Producto</h2>
                <span class="close" onclick="closeProductDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="productDetailsContent">
                    <!-- El contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base de datos con Supabase
        let products = [];
        let sales = [];
        let clients = [];
        let cart = []; // Carrito de compras temporal

        // Funci√≥n para mostrar notificaciones toast
        function showToast(message, duration = 2000) {
            // Crear elemento toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span>‚úÖ</span><span>${message}</span>`;

            // Agregar al body
            document.body.appendChild(toast);

            // Remover despu√©s de la duraci√≥n especificada
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300); // Tiempo de la animaci√≥n de salida
            }, duration);
        }

        // Variables globales
        let editingProductId = null;
        let editingClientId = null;
        let selectedImageFile = null;
        let currentCameraMode = 'environment'; // 'user' para frontal, 'environment' para trasera

        // Categor√≠as del sistema
        let categories = [];

        // Cargar categor√≠as desde Supabase
        async function loadCategories() {
            try {
                categories = await loadCategoriesFromDB();
                updateCategorySelects();
            } catch (error) {
                console.error('Error al cargar categor√≠as:', error);
                // Usar categor√≠as predeterminadas si falla
                categories = [
                    'Remeras', 'Recuerdos', 'Botellas', 'Stickers', 
                    'Gorras', 'Llaveros', 'Tazas', 'Materiales', 'Telas', 'Otros'
                ];
                updateCategorySelects();
            }
        }

        // Ya no se usa - las categor√≠as se guardan directamente en Supabase

        // Actualizar todos los selects de categor√≠as
        function updateCategorySelects() {
            // Select del formulario de productos
            const productCategorySelect = document.getElementById('productCategory');
            if (productCategorySelect) {
                const currentValue = productCategorySelect.value;
                productCategorySelect.innerHTML = '<option value="">-- Seleccionar --</option>';
                categories.forEach(cat => {
                    productCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentValue && categories.includes(currentValue)) {
                    productCategorySelect.value = currentValue;
                }
            }

            // Select del filtro
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                const currentFilter = categoryFilter.value;
                categoryFilter.innerHTML = '<option value="">Todas las categor√≠as</option>';
                categories.forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (currentFilter && categories.includes(currentFilter)) {
                    categoryFilter.value = currentFilter;
                }
            }

            // Lista en el modal de gesti√≥n
            if (document.getElementById('categoriesList')) {
                updateCategoriesList();
            }
        }

        // Abrir modal de categor√≠as
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('active');
            updateCategoriesList();
        }

        // Cerrar modal de categor√≠as
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.getElementById('newCategoryName').value = '';
        }

        // Agregar nueva categor√≠a
        async function addCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                alert('‚ö†Ô∏è Por favor ingresa un nombre para la categor√≠a');
                return;
            }

            if (categories.includes(categoryName)) {
                alert('‚ö†Ô∏è Esta categor√≠a ya existe');
                return;
            }

            try {
                await saveCategoryToDB(categoryName);
                categories.push(categoryName);
                categories.sort();
                updateCategorySelects();
                document.getElementById('newCategoryName').value = '';
                alert('‚úÖ Categor√≠a agregada correctamente');
            } catch (error) {
                alert('‚ùå Error al agregar categor√≠a: ' + error.message);
            }
        }

        // Eliminar categor√≠a
        async function deleteCategory(categoryName) {
            if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${categoryName}"?

Nota: Los productos con esta categor√≠a no se eliminar√°n.`)) {
                return;
            }

            try {
                await deleteCategoryFromDB(categoryName);
                categories = categories.filter(cat => cat !== categoryName);
                updateCategorySelects();
                alert('‚úÖ Categor√≠a eliminada correctamente');
            } catch (error) {
                alert('‚ùå Error al eliminar categor√≠a: ' + error.message);
            }
        }

        // Actualizar lista de categor√≠as en el modal
        function updateCategoriesList() {
            const list = document.getElementById('categoriesList');
            if (!list) return;
            
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No hay categor√≠as</p>';
                return;
            }

            categories.forEach(cat => {
                list.innerHTML += `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;">
                        <span style="font-weight:500;">${cat}</span>
                        <button class="btn btn-danger" onclick="deleteCategory('${cat}')" style="padding:5px 10px;font-size:12px;">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            });
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCategories();
            await loadProducts();
            await loadSales();
            await loadClients();
            await updateDashboard();
            await updateReports();
        });

        // Navegaci√≥n
        async function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'dashboard') await updateDashboard();
            if (sectionName === 'products') await loadProducts();
            if (sectionName === 'clients') await loadClients();
            if (sectionName === 'sales') await loadSalesForm();
            if (sectionName === 'reports') await updateReports();
        }

        // Generar c√≥digo autom√°tico √∫nico
        function generateProductCode() {
            const prefix = 'TP';
            const existingCodes = products.map(p => p.code);
            let number = 1;
            let code = '';

            // Buscar el siguiente n√∫mero disponible
            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Modal de productos
        function openProductModal(productId = null) {
            document.getElementById('productModal').classList.add('active');
            document.getElementById('productForm').reset();

            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('modalTitle').textContent = 'Editar Producto';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productCode').value = product.code;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand || '';
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productUnit').value = product.unit || 'unidades';
                    document.getElementById('productCost').value = product.cost ? product.cost.toLocaleString('de-DE') : '';
                    document.getElementById('productPrice').value = product.price.toLocaleString('de-DE');
                    document.getElementById('productMinStock').value = product.minStock || 3;
                    document.getElementById('productDescription').value = product.description || '';
                    editingProductId = productId;

                    // Mostrar vista detallada del producto
                    document.getElementById('productDetailView').style.display = 'block';
                    document.getElementById('detailProductName').textContent = product.name + (product.brand ? ` - ${product.brand}` : '');
                    document.getElementById('detailCostPrice').textContent = formatGuaranies(product.cost || 0);
                    document.getElementById('detailSalePrice').textContent = formatGuaranies(product.price);
                    document.getElementById('detailStock').textContent = formatUnit(product.stock, product.unit);

                    // Calcular estado
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';
                    document.getElementById('detailStatus').innerHTML = stockStatus;

                    // Mostrar imagen en la vista detallada
                    if (product.imageUrl) {
                        document.getElementById('detailProductImage').src = product.imageUrl;
                        document.getElementById('detailProductImage').style.display = 'block';
                        document.getElementById('noImagePlaceholder').style.display = 'none';

                        // Tambi√©n en el preview del formulario
                        document.getElementById('previewImg').src = product.imageUrl;
                        document.getElementById('imagePreview').style.display = 'block';
                    } else {
                        document.getElementById('detailProductImage').style.display = 'none';
                        document.getElementById('noImagePlaceholder').style.display = 'flex';
                    }
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Agregar Producto';
                document.getElementById('productDetailView').style.display = 'none';
                editingProductId = null;
                // Generar c√≥digo autom√°tico para producto nuevo
                document.getElementById('productCode').value = generateProductCode();
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
            clearImage();
        }

        // Guardar producto
        async function saveProduct(event) {
            event.preventDefault();

            const productData = {
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value || '',
                category: document.getElementById('productCategory').value,
                stock: parseFloat(document.getElementById('productStock').value),
                unit: document.getElementById('productUnit').value,
                cost: parseFormattedPrice(document.getElementById('productCost').value),
                price: parseFormattedPrice(document.getElementById('productPrice').value),
                minStock: parseFloat(document.getElementById('productMinStock').value) || 3,
                description: document.getElementById('productDescription')?.value || ''
            };

            // Si hay imagen, subirla primero
            if (selectedImageFile && productData.code) {
                const imageUrl = await uploadProductImage(selectedImageFile, productData.code);
                if (imageUrl) {
                    productData.imageUrl = imageUrl;
                }
            }

            try {

                // Obtener el ID del producto del campo oculto o de la variable global

                const productId = document.getElementById('productId').value || editingProductId;

                if (productId) {

                    // Modo edici√≥n - actualizar producto existente
                    await updateProductInDB(parseInt(productId), productData);
                    alert('‚úÖ Producto actualizado correctamente');
                    closeProductModal();
                } else {

                    // Modo creaci√≥n - crear nuevo producto

                    await saveProductToDB(productData);
                    alert('‚úÖ Producto agregado correctamente');

                    // Limpiar formulario para agregar otro producto r√°pidamente
                    document.getElementById('productForm').reset();
                    document.getElementById('productCode').value = generateProductCode();
                    document.getElementById('productUnit').value = 'unidades';
                    document.getElementById('productMinStock').value = 3;
                    document.getElementById('productName').focus();
                    clearImage();
                }

                await loadProducts();
                await updateDashboard();
            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al guardar producto: ' + error.message);
            }
        }

        // Formatear guaran√≠es con separador de miles (punto decimal)
        function formatGuaranies(amount) {
            if (amount === null || amount === undefined || amount === '') return 'Gs. 0';
            // Convertir a n√∫mero y redondear
            const num = Math.round(Number(amount));
            // Convertir a string
            let str = num.toString();
            // Aplicar separador de miles (punto)
            str = str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const result = `Gs. ${str}`;
            console.log(`formatGuaranies(${amount}) = ${result}`); // DEBUG
            return result;
        }

        // Capitalizar primera letra
        function capitalizeFirst(input) {
            if (input.value.length > 0) {
                input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
            }
        }



        // Formatear n√∫mero con puntos (auxiliar)
        function formatNumberWithDots(number) {
            if (!number) return '';
            const str = number.toString();
            return str.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // Formatear n√∫mero de documento con puntos
        function formatDocumentNumber(input) {
            // Obtener solo n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Aplicar formato con puntos cada 3 d√≠gitos
            if (value.length > 0) {
                value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            input.value = value;
            // Guardar valor sin formato en data attribute
            input.dataset.rawValue = value.replace(/\./g, '');
        }

        // ===== FUNCIONES PARA MANEJO DE FOTOS =====
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                return;
            }

            // Validar formato
            if (!file.type.match('image/(jpeg|jpg|png|webp)')) {
                alert('‚ùå Formato no v√°lido. Usa JPG, PNG o WEBP.');
                return;
            }

            selectedImageFile = file;

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            // Restaurar estilo
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.style.background = '#f9f9f9';
            }

            // Verificar que hay archivos
            if (!event.dataTransfer || !event.dataTransfer.files) {
                console.log('No se encontraron archivos en el evento');
                return;
            }

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Validar que sea imagen
                if (!file.type.match('image.*')) {
                    alert('‚ùå Por favor arrastra una imagen');
                    return;
                }

                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå La imagen es muy grande. M√°ximo 5MB.');
                    return;
                }

                selectedImageFile = file;

                // Mostrar preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        async function takePhoto() {
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo acceder a la c√°mara: ' + error.message);
            }
        }

        async function startCamera() {
            // Detener stream anterior si existe
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
            }

            // Constraints mejorados para mejor calidad
            const constraints = {
                video: {
                    facingMode: currentCameraMode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    aspectRatio: { ideal: 4/3 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);

            // Si ya existe el modal, solo actualizar el video
            if (window.cameraModal) {
                const video = document.getElementById('cameraVideo');
                video.srcObject = stream;
                window.currentStream = stream;
                return;
            }

            // Crear modal con video mejorado y controles profesionales
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;">
                    <div style="background:white;padding:20px;border-radius:15px;max-width:650px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                        <h3 style="margin:0 0 15px 0;text-align:center;color:#333;">üì∏ Tomar Fotograf√≠a</h3>

                        <!-- Vista previa de c√°mara -->
                        <div style="position:relative;background:#000;border-radius:10px;overflow:hidden;">
                            <video id="cameraVideo" autoplay playsinline style="width:100%;height:auto;display:block;"></video>

                            <!-- Grilla de ayuda compositiva (regla de tercios) -->
                            <div id="gridOverlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;">
                                <svg width="100%" height="100%" style="position:absolute;top:0;left:0;">
                                    <line x1="33.33%" y1="0" x2="33.33%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="66.66%" y1="0" x2="66.66%" y2="100%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="33.33%" x2="100%" y2="33.33%" stroke="white" stroke-width="1" opacity="0.3"/>
                                    <line x1="0" y1="66.66%" x2="100%" y2="66.66%" stroke="white" stroke-width="1" opacity="0.3"/>
                                </svg>
                            </div>

                            <!-- Marco de enfoque central -->
                            <div id="focusFrame" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:70%;height:70%;border:2px solid rgba(255,255,255,0.5);border-radius:10px;pointer-events:none;"></div>

                            <!-- Efecto flash -->
                            <div id="captureFlash" style="position:absolute;top:0;left:0;width:100%;height:100%;background:white;opacity:0;pointer-events:none;transition:opacity 0.1s;"></div>

                            <!-- Indicador de c√°mara activa -->
                            <div style="position:absolute;top:10px;left:10px;background:rgba(255,0,0,0.8);color:white;padding:5px 10px;border-radius:15px;font-size:12px;font-weight:bold;">
                                ‚óè REC
                            </div>

                            <!-- Informaci√≥n de resoluci√≥n -->
                            <div id="resolutionInfo" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:5px 10px;border-radius:5px;font-size:11px;"></div>
                        </div>

                        <!-- Controles de c√°mara -->
                        <div style="margin-top:15px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="gridToggle" onchange="toggleGrid(this.checked)" style="cursor:pointer;">
                                Grilla
                            </label>
                            <label style="display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;user-select:none;">
                                <input type="checkbox" id="focusFrameToggle" checked onchange="toggleFocusFrame(this.checked)" style="cursor:pointer;">
                                Marco
                            </label>
                            <div style="flex:1;"></div>
                            <span style="font-size:12px;color:#666;">Zoom:</span>
                            <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1" onchange="adjustZoom(this.value)" style="width:100px;cursor:pointer;">
                            <span id="zoomValue" style="font-size:12px;color:#666;min-width:35px;">1.0x</span>
                        </div>

                        <!-- Botones principales -->
                        <div style="margin-top:20px;text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                            <button class="btn btn-success" onclick="capturePhoto()" style="flex:1;min-width:140px;font-size:16px;padding:12px;">üì∏ Capturar</button>
                            <button class="btn btn-secondary" onclick="flipCamera()" style="padding:12px 20px;">üîÑ C√°mara</button>
                            <button class="btn btn-danger" onclick="closeCamera()" style="padding:12px 20px;">‚ùå Cerrar</button>
                        </div>

                        <p style="margin:10px 0 0 0;text-align:center;font-size:11px;color:#999;">
                            üí° Centra el producto en el marco ‚Ä¢ Usa buena iluminaci√≥n ‚Ä¢ Mant√©n el dispositivo estable
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const video = document.getElementById('cameraVideo');
            video.srcObject = stream;

            // Mostrar informaci√≥n de resoluci√≥n cuando el video est√© listo
            video.addEventListener('loadedmetadata', () => {
                const resInfo = document.getElementById('resolutionInfo');
                if (resInfo) {
                    resInfo.textContent = `${video.videoWidth}x${video.videoHeight}`;
                }

                // Verificar si el dispositivo soporta zoom
                const track = stream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    const zoomSlider = document.getElementById('zoomSlider');
                    zoomSlider.min = capabilities.zoom.min || 1;
                    zoomSlider.max = capabilities.zoom.max || 3;
                    zoomSlider.step = capabilities.zoom.step || 0.1;
                }
            });

            window.currentStream = stream;
            window.cameraModal = modal;

            // Agregar atajo de teclado para capturar (Espacio)
            window.cameraKeyHandler = (e) => {
                if (e.code === 'Space' && window.cameraModal) {
                    e.preventDefault();
                    capturePhoto();
                } else if (e.code === 'Escape' && window.cameraModal) {
                    e.preventDefault();
                    closeCamera();
                }
            };
            document.addEventListener('keydown', window.cameraKeyHandler);
        }

        // Funci√≥n para alternar grilla de composici√≥n
        function toggleGrid(show) {
            const grid = document.getElementById('gridOverlay');
            if (grid) {
                grid.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para alternar marco de enfoque
        function toggleFocusFrame(show) {
            const frame = document.getElementById('focusFrame');
            if (frame) {
                frame.style.display = show ? 'block' : 'none';
            }
        }

        // Funci√≥n para ajustar zoom
        function adjustZoom(value) {
            const zoomValueDisplay = document.getElementById('zoomValue');
            if (zoomValueDisplay) {
                zoomValueDisplay.textContent = parseFloat(value).toFixed(1) + 'x';
            }

            if (window.currentStream) {
                const track = window.currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};

                if (capabilities.zoom) {
                    track.applyConstraints({
                        advanced: [{ zoom: parseFloat(value) }]
                    }).catch(err => {
                        console.log('Zoom no soportado:', err);
                    });
                } else {
                    // Fallback: zoom digital mediante CSS transform
                    const video = document.getElementById('cameraVideo');
                    if (video) {
                        video.style.transform = `scale(${value})`;
                        video.style.transformOrigin = 'center center';
                    }
                }
            }
        }

        async function flipCamera() {
            // Cambiar entre frontal y trasera
            currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            try {
                await startCamera();
            } catch (error) {
                alert('‚ùå No se pudo cambiar la c√°mara: ' + error.message);
                // Volver al modo anterior si falla
                currentCameraMode = currentCameraMode === 'user' ? 'environment' : 'user';
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');

            // Usar resoluci√≥n del video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Efecto flash visual
            const flash = document.getElementById('captureFlash');
            if (flash) {
                flash.style.opacity = '0.7';
                setTimeout(() => flash.style.opacity = '0', 100);
            }

            // Comprimir imagen para tama√±o √≥ptimo
            // Si la imagen es muy grande, redimensionar
            let finalCanvas = canvas;
            const maxDimension = 1600; // M√°ximo ancho o alto

            if (canvas.width > maxDimension || canvas.height > maxDimension) {
                finalCanvas = document.createElement('canvas');
                const scale = Math.min(maxDimension / canvas.width, maxDimension / canvas.height);
                finalCanvas.width = canvas.width * scale;
                finalCanvas.height = canvas.height * scale;

                const finalCtx = finalCanvas.getContext('2d');
                finalCtx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
            }

            // Convertir a blob con calidad ajustada (0.85 = 85% calidad)
            finalCanvas.toBlob((blob) => {
                // Verificar tama√±o del archivo
                const sizeMB = blob.size / (1024 * 1024);
                console.log(`Tama√±o de imagen: ${sizeMB.toFixed(2)} MB`);

                if (sizeMB > 5) {
                    alert('‚ö†Ô∏è La imagen es muy grande. Intenta con mejor iluminaci√≥n o m√°s cerca del producto.');
                    return;
                }

                selectedImageFile = new File([blob], 'photo.jpg', { type: 'image/jpeg' });

                document.getElementById('previewImg').src = finalCanvas.toDataURL('image/jpeg', 0.85);
                document.getElementById('imagePreview').style.display = 'block';

                closeCamera();
            }, 'image/jpeg', 0.85);
        }

        function closeCamera() {
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
                window.currentStream = null;
            }
            if (window.cameraModal) {
                window.cameraModal.remove();
                window.cameraModal = null;
            }
            // Remover listener de teclado
            if (window.cameraKeyHandler) {
                document.removeEventListener('keydown', window.cameraKeyHandler);
                window.cameraKeyHandler = null;
            }
            // Resetear zoom
            currentCameraMode = 'environment';
        }

        function clearImage() {
            selectedImageFile = null;
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function showImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;" onclick="this.parentElement.remove()">
                    <div style="max-width:90%;max-height:90%;text-align:center;">
                        <img src="${imageUrl}" style="max-width:100%;max-height:90vh;border-radius:10px;">
                        <p style="color:white;margin-top:10px;">Click para cerrar</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Formatear input de precio con punto decimal
        function formatPriceInput(input) {
            // Remover todo excepto n√∫meros
            let value = input.value.replace(/\D/g, '');

            // Si est√° vac√≠o, dejar vac√≠o
            if (value === '') {
                input.value = '';
                return;
            }

            // Convertir a n√∫mero
            let num = parseInt(value, 10);

            // Formatear con puntos
            input.value = num.toLocaleString('de-DE'); // Usa formato alem√°n que tiene punto como separador
        }

        // Convertir precio formateado a n√∫mero
        function parseFormattedPrice(formattedValue) {
            if (!formattedValue || formattedValue === '') return 0;
            // Remover puntos y convertir a n√∫mero
            return parseFloat(formattedValue.replace(/\./g, '')) || 0;
        }

        // Formatear unidad de medida
        function formatUnit(quantity, unit) {
            const formatted = parseFloat(quantity).toFixed(2).replace(/\.?0+$/, '');
            return `${formatted} ${unit}`;
        }

        // Cargar productos
        async function loadProducts() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            try {
                products = await loadProductsFromDB();

                if (products.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <div>No hay productos registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openProductModal()">Agregar Primer Producto</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                products.forEach(product => {
                    const stockStatus = product.stock <= product.minStock ?
                        '<span class="badge badge-danger">Stock Bajo</span>' :
                        product.stock <= product.minStock * 2 ?
                        '<span class="badge badge-warning">Stock Medio</span>' :
                        '<span class="badge badge-success">Stock OK</span>';

                    const brandCell = product.brand ? `<td>${product.brand}</td>` : '<td><em style="color: #999;">-</em></td>';

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${product.code}</strong></td>
                            <td>${product.name}</td>
                            ${brandCell}
                            <td>${product.category}</td>
                            <td><strong>${formatUnit(product.stock, product.unit)}</strong></td>
                            <td><strong>${formatGuaranies(product.price)}</strong></td>
                             <td>${product.imageUrl ? `<img src="${product.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;cursor:pointer;" onclick='showImageModal("${product.imageUrl}")'>` : '‚ùå'}</td>
                            <td>${stockStatus}</td>
                            <td class="action-btns">
                                <button class="action-btn btn-info" onclick="showProductDetails(${product.id})" style="background: #17a2b8;">üëÅÔ∏è Ver</button>
                                <button class="action-btn btn-primary" onclick="openProductModal(${product.id})">‚úèÔ∏è Editar</button>
                                <button class="action-btn btn-danger" onclick="deleteProduct(${product.id})">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar productos: ' + error.message);
            }
        }

        // Eliminar producto
        async function deleteProduct(productId) {
            if (confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
                try {
                    await deleteProductFromDB(productId);
                    await loadProducts();
                    await updateDashboard();
                    alert('‚úÖ Producto eliminado correctamente');
                } catch (error) {
                    alert('Error al eliminar producto: ' + error.message);
                }
            }
        }

        // Filtrar productos
        function filterProducts() {
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            const rows = document.querySelectorAll('#productsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                // Categor√≠a est√° en la columna 3 (√≠ndice 3): C√≥digo, Nombre, Marca, Categor√≠a
                const category = row.children[3]?.textContent || '';

                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;

                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }


        // ===== FUNCIONES PARA SELECTOR PERSONALIZADO DE PRODUCTOS =====
        
        function toggleProductDropdown() {
            const dropdown = document.getElementById('productDropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }
        
        function closeProductDropdown() {
            document.getElementById('productDropdown').style.display = 'none';
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.custom-select-container');
            if (container && !container.contains(event.target)) {
                closeProductDropdown();
            }
        });
        
        // Toggle de vista previa de imagen
        function toggleImagePreview() {
            const content = document.getElementById('imagePreviewContent');
            const icon = document.getElementById('imageToggleIcon');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            // Actualizar campo oculto
            document.getElementById('saleProduct').value = productId;

            // Actualizar texto del bot√≥n
            document.getElementById('selectedProductText').textContent = product.name + ' (' + formatUnit(product.stock, product.unit) + ')';

            // Mostrar imagen del producto si existe
            const imagePreview = document.getElementById('saleProductImagePreview');
            const imageElement = document.getElementById('saleProductImage');

            if (product.imageUrl) {
                imageElement.src = product.imageUrl;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            // Cerrar dropdown
            closeProductDropdown();

            // Actualizar precio
            updateSalePrice();
        }
        
        function filterProductOptions() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const options = document.querySelectorAll('.product-option');
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function loadProductOptions() {
            const optionsList = document.getElementById('productOptionsList');
            optionsList.innerHTML = '';
            
            // Filtrar solo productos con stock
            const availableProducts = products.filter(p => p.stock > 0);
            
            if (availableProducts.length === 0) {
                optionsList.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No hay productos disponibles</div>';
                return;
            }
            
            availableProducts.forEach(product => {
                const option = document.createElement('div');
                option.className = 'product-option';
                option.onclick = () => selectProduct(product.id);
                
                // Imagen o placeholder
                let imageHTML = '';
                if (product.imageUrl && product.imageUrl.trim() !== '') {
                    imageHTML = `<img src="${product.imageUrl}" class="product-option-image" alt="${product.name}">`;
                } else {
                    imageHTML = '<div class="product-option-no-image">üì¶</div>';
                }
                
                option.innerHTML = `
                    ${imageHTML}
                    <div class="product-option-info">
                        <div class="product-option-name">${product.name}</div>
                        <div class="product-option-details">
                            Stock: ${formatUnit(product.stock, product.unit)} | Precio: ${formatGuaranies(product.price)}
                        </div>
                    </div>
                `;
                
                optionsList.appendChild(option);
            });
        }

        // Cargar formulario de ventas
        async function loadSalesForm() {
            // Cargar productos en selector personalizado
            loadProductOptions();

            // Cargar clientes
            const selectCustomer = document.getElementById('saleCustomer');
            selectCustomer.innerHTML = '<option value="">-- Seleccionar Cliente --</option>';

            clients.forEach(client => {
                selectCustomer.innerHTML += `<option value="${client.id}">${client.name} - ${client.docType}: ${formatNumberWithDots(client.docNumber)}</option>`;
            });

            await loadSalesHistory();
        }

        // Actualizar precio de venta
        function updateSalePrice() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                document.getElementById('salePrice').value = formatGuaranies(product.price);
                document.getElementById('salePrice').dataset.rawValue = product.price; // Guardar valor num√©rico
                document.getElementById('saleUnitLabel').textContent = `(${product.unit})`;
                updateSaleTotal();
            } else {
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleUnitLabel').textContent = '';
            }
        }

        // Actualizar total de venta
        function updateSaleTotal() {
            const priceElement = document.getElementById('salePrice');
            const price = parseFloat(priceElement.dataset.rawValue) || 0;
            const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
            const total = price * quantity;
            document.getElementById('saleTotal').value = formatGuaranies(total);
            document.getElementById('saleTotal').dataset.rawValue = total; // Guardar valor num√©rico
        }

        // ===== FUNCIONES DEL CARRITO DE COMPRAS =====

        // Agregar producto al carrito
        function addToCart() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseFloat(document.getElementById('saleQuantity').value);

            if (!productId || !quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            const product = products.find(p => p.id === productId);

            if (quantity > product.stock) {
                alert(`‚ö†Ô∏è No hay suficiente stock disponible. Stock actual: ${formatUnit(product.stock, product.unit)}`);
                return;
            }

            // Verificar si el producto ya est√° en el carrito
            const existingItem = cart.find(item => item.productId === productId);

            if (existingItem) {
                // Si ya existe, actualizar cantidad
                const newQuantity = existingItem.quantity + quantity;
                if (newQuantity > product.stock) {
                    alert(`‚ö†Ô∏è No hay suficiente stock. Stock disponible: ${formatUnit(product.stock, product.unit)}`);
                    return;
                }
                existingItem.quantity = newQuantity;
                existingItem.subtotal = existingItem.price * newQuantity;
            } else {
                // Agregar nuevo item al carrito
                cart.push({
                    productId: product.id,
                    productName: product.name,
                    productBrand: product.brand || '',
                    category: product.category,
                    quantity: quantity,
                    unit: product.unit,
                    price: product.price,
                    subtotal: product.price * quantity,
                    stock: product.stock
                });
            }

            // Limpiar selecci√≥n de producto
            document.getElementById('saleProduct').value = '';
            document.getElementById('selectedProductText').textContent = '-- Seleccionar Producto --';
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('salePrice').value = '';
            document.getElementById('saleTotal').value = '';
            document.getElementById('saleUnitLabel').textContent = '';
            // Ocultar y resetear imagen
            document.getElementById('saleProductImagePreview').style.display = 'none';
            document.getElementById('imagePreviewContent').style.display = 'none';
            document.getElementById('imageToggleIcon').textContent = '‚ñº';

            // Actualizar vista del carrito
            updateCartView();

            // Mostrar notificaci√≥n
            showToast('Producto agregado al carrito');
        }

        // Actualizar vista del carrito
        function updateCartView() {
            const cartItemsBody = document.getElementById('cartItems');
            const cartSection = document.getElementById('cartSection');
            const cartTotalSpan = document.getElementById('cartTotal');

            if (cart.length === 0) {
                cartSection.style.display = 'none';
                return;
            }

            cartSection.style.display = 'block';
            cartItemsBody.innerHTML = '';

            let total = 0;

            cart.forEach((item, index) => {
                total += item.subtotal;

                cartItemsBody.innerHTML += `
                    <tr>
                        <td><strong>${item.productName}</strong>${item.productBrand ? '<br><small>' + item.productBrand + '</small>' : ''}</td>
                        <td>${formatUnit(item.quantity, item.unit)}</td>
                        <td>${formatGuaranies(item.price)}</td>
                        <td><strong>${formatGuaranies(item.subtotal)}</strong></td>
                        <td class="action-btns">
                            <button class="action-btn btn-danger" onclick="removeFromCart(${index})" style="padding:5px 10px;font-size:12px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

            cartTotalSpan.textContent = formatGuaranies(total);
        }

        // Remover item del carrito
        function removeFromCart(index) {
            const item = cart[index];
            if (confirm(`¬øEliminar ${item.productName} del carrito?`)) {
                cart.splice(index, 1);
                updateCartView();
            }
        }

        // Vaciar carrito
        function clearCart() {
            if (cart.length === 0) return;

            if (confirm('¬øEst√°s seguro de vaciar el carrito?')) {
                cart = [];
                updateCartView();
            }
        }

        // Completar venta con m√∫ltiples productos
        async function completeSale() {
            const customerId = parseInt(document.getElementById('saleCustomer').value);

            if (cart.length === 0) {
                alert('‚ö†Ô∏è El carrito est√° vac√≠o. Agrega productos antes de completar la venta.');
                return;
            }

            if (!customerId) {
                alert('‚ö†Ô∏è Por favor selecciona un cliente');
                return;
            }

            const client = clients.find(c => c.id == customerId);

            try {
                // Registrar cada producto del carrito como una venta individual
                for (const item of cart) {
                    const saleData = {
                        productId: item.productId,
                        productName: item.productName,
                        productBrand: item.productBrand,
                        category: item.category,
                        quantity: item.quantity,
                        unit: item.unit,
                        price: item.price,
                        total: item.subtotal,
                        customerId: client.id,
                        customer: client.name,
                        customerDoc: `${client.docType}: ${formatNumberWithDots(client.docNumber)}`
                    };

                    // Guardar venta
                    await saveSaleToDB(saleData);

                    // Actualizar stock del producto
                    const newStock = item.stock - item.quantity;
                    await updateProductInDB(item.productId, { stock: newStock });
                }

                const totalVenta = cart.reduce((sum, item) => sum + item.subtotal, 0);
                alert(`‚úÖ Venta completada exitosamente!\n\nTotal: ${formatGuaranies(totalVenta)}\nProductos: ${cart.length}\nCliente: ${client.name}`);

                // Limpiar carrito y formulario
                cart = [];
                updateCartView();
                document.getElementById('saleCustomer').value = '';

                // Recargar datos
                await loadProducts();
                await loadSales();
                await loadSalesForm();
                await updateDashboard();
            } catch (error) {
                alert('Error al completar la venta: ' + error.message);
            }
        }

        // Registrar venta (mantener para compatibilidad, pero ya no se usa)
        async function registerSale() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseFloat(document.getElementById('saleQuantity').value);
            const customerId = parseInt(document.getElementById('saleCustomer').value);

            if (!productId || !quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor selecciona un producto y cantidad v√°lida');
                return;
            }

            if (!customerId) {
                alert('‚ö†Ô∏è Por favor selecciona un cliente');
                return;
            }

            const product = products.find(p => p.id === productId);
            const client = clients.find(c => c.id == customerId);

            if (quantity > product.stock) {
                alert(`‚ö†Ô∏è No hay suficiente stock disponible. Stock actual: ${formatUnit(product.stock, product.unit)}`);
                return;
            }

            const saleData = {
                productId: productId,
                productName: product.name,
                productBrand: product.brand || '',
                category: product.category,
                quantity: quantity,
                unit: product.unit,
                price: product.price,
                total: product.price * quantity,
                customerId: client.id,
                customer: client.name,
                customerDoc: `${client.docType}: ${client.docNumber}`
            };

            try {
                // Guardar venta
                await saveSaleToDB(saleData);

                // Actualizar stock del producto
                const newStock = product.stock - quantity;
                await updateProductInDB(productId, { stock: newStock });

                alert('‚úÖ Venta registrada exitosamente');

                // Limpiar formulario
                document.getElementById('saleProduct').value = '';
                document.getElementById('selectedProductText').textContent = '-- Seleccionar Producto --';
                document.getElementById('saleQuantity').value = 1;
                document.getElementById('salePrice').value = '';
                document.getElementById('saleTotal').value = '';
                document.getElementById('saleCustomer').value = '';
                document.getElementById('saleUnitLabel').textContent = '';
                document.getElementById('saleProductImagePreview').style.display = 'none';
                document.getElementById('imagePreviewContent').style.display = 'none';
                document.getElementById('imageToggleIcon').textContent = '‚ñº';

                await loadProducts();
                await loadSalesForm();
                await updateDashboard();
            } catch (error) {
                alert('Error al registrar venta: ' + error.message);
            }
        }

        // Cargar historial de ventas
        async function loadSalesHistory() {
            const tbody = document.getElementById('salesHistoryBody');
            tbody.innerHTML = '';

            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <div>No hay ventas registradas</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Mostrar √∫ltimas 20 ventas
            const recentSales = [...sales].reverse().slice(0, 20);

            recentSales.forEach(sale => {
                const date = new Date(sale.created_at);
                const formattedDate = date.toLocaleString('es-PY', {
                    timeZone: 'America/Asuncion',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const brandCell = sale.productBrand ? `<td>${sale.productBrand}</td>` : '<td><em style="color: #999;">Sin marca</em></td>';
                tbody.innerHTML += `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${sale.productName}</td>
                        ${brandCell}
                        <td>${formatUnit(sale.quantity, sale.unit)}</td>
                        <td><strong>${formatGuaranies(sale.total)}</strong></td>
                        <td>${sale.customer}</td>
                    </tr>
                `;
            });
        }

        // Cargar ventas
        async function loadSales() {
            try {
                sales = await loadSalesFromDB();
                await loadSalesHistory();
            } catch (error) {
                alert('Error al cargar ventas: ' + error.message);
            }
        }

        // Actualizar dashboard
        async function updateDashboard() {
            // Total productos
            document.getElementById('totalProducts').textContent = products.length;

            // Valor total inventario (basado en precio de costo)
            const totalValue = products.reduce((sum, p) => sum + (p.stock * (p.cost || 0)), 0);
            document.getElementById('totalValue').textContent = formatGuaranies(totalValue);

            // Ventas de hoy - usar formato de fecha simple para comparaci√≥n
            const today = new Date();
            const todayStr = today.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' });

            const todaySales = sales.filter(s => {
                const saleDate = new Date(s.created_at || s.date);
                const saleDateStr = saleDate.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' });
                return saleDateStr === todayStr;
            });
            const todayTotal = todaySales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('todaySales').textContent = formatGuaranies(todayTotal);

            // Debug: mostrar en consola
            console.log('Fecha de hoy:', todayStr);
            console.log('Ventas totales:', sales.length);
            console.log('Ventas de hoy:', todaySales.length, 'Total:', todayTotal);
            if (sales.length > 0) {
                const ultimaVenta = sales[sales.length - 1];
                const ultimaFecha = new Date(ultimaVenta.created_at || ultimaVenta.date);
                console.log('√öltima venta fecha:', ultimaFecha.toLocaleDateString('es-PY', { timeZone: 'America/Asuncion' }));
            }

            // Stock bajo
            const lowStock = products.filter(p => p.stock <= p.minStock);
            document.getElementById('lowStockCount').textContent = lowStock.length;

            // Alertas de stock bajo
            const alertsDiv = document.getElementById('lowStockAlerts');
            alertsDiv.innerHTML = '';

            if (lowStock.length > 0) {
                alertsDiv.innerHTML = `
                    <div class="low-stock-alert">
                        <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Alertas de Stock Bajo</h3>
                        ${lowStock.map(p => `
                            <div style="margin: 5px 0;">
                                <strong>${p.name}</strong> - Solo quedan ${formatUnit(p.stock, p.unit)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Productos m√°s vendidos
            const productSales = {};
            sales.forEach(sale => {
                if (!productSales[sale.productId]) {
                    productSales[sale.productId] = {
                        name: sale.productName,
                        category: sale.category,
                        units: 0,
                        unit: sale.unit,
                        revenue: 0
                    };
                }
                productSales[sale.productId].units += sale.quantity;
                productSales[sale.productId].revenue += sale.total;
            });

            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            const topBody = document.getElementById('topProductsBody');
            topBody.innerHTML = '';

            if (topProducts.length > 0) {
                topProducts.forEach(p => {
                    topBody.innerHTML += `
                        <tr>
                            <td><strong>${p.name}</strong></td>
                            <td>${p.category}</td>
                            <td>${formatUnit(p.units, p.unit)}</td>
                            <td><strong>${formatGuaranies(p.revenue)}</strong></td>
                        </tr>
                    `;
                });
            } else {
                topBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div>No hay datos de ventas a√∫n</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Actualizar reportes
        async function updateReports() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            // Ventas del mes
            const monthSales = sales.filter(s => {
                const saleDate = new Date(s.created_at);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthTotal = monthSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('monthSales').textContent = formatGuaranies(monthTotal);

            // Ventas del a√±o
            const yearSales = sales.filter(s => new Date(s.created_at).getFullYear() === currentYear);
            const yearTotal = yearSales.reduce((sum, s) => sum + s.total, 0);
            document.getElementById('yearSales').textContent = formatGuaranies(yearTotal);

            // Total transacciones
            document.getElementById('totalSoldUnits').textContent = sales.length;

            // Categor√≠a m√°s vendida
            const categorySales = {};
            sales.forEach(s => {
                if (!categorySales[s.category]) categorySales[s.category] = 0;
                categorySales[s.category] += s.total;
            });

            const topCategory = Object.entries(categorySales)
                .sort((a, b) => b[1] - a[1])[0];

            document.getElementById('topCategory').textContent = topCategory ? topCategory[0] : '-';

            // Reporte por categor√≠a
            const categoryReport = document.getElementById('categoryReport');
            categoryReport.innerHTML = '';

            if (Object.keys(categorySales).length > 0) {
                Object.entries(categorySales)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, total]) => {
                        const percentage = (total / yearTotal * 100).toFixed(1);
                        categoryReport.innerHTML += `
                            <div style="margin: 10px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${category}</strong>
                                    <span>${formatGuaranies(total)} (${percentage}%)</span>
                                </div>
                                <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div style="background: #667eea; height: 100%; width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    });
            } else {
                categoryReport.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>No hay datos de ventas para mostrar</div></div>';
            }
        }

        // Exportar datos
        function exportData() {
            const data = {
                products: products,
                sales: sales,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `turista_paraguay_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            alert('‚úÖ Datos exportados correctamente');
        }

        // Generar reporte CSV
        function generateCSVReport() {
            let csv = 'Producto,Categor√≠a,Stock,Unidad,Precio,Valor Total\n';

            products.forEach(p => {
                csv += `"${p.name}","${p.category}",${p.stock},"${p.unit}",${p.price},${p.stock * p.price}\n`;
            });

            csv += '\n\nHistorial de Ventas\n';
            csv += 'Fecha,Producto,Cantidad,Unidad,Total,Cliente\n';

            sales.forEach(s => {
                const date = new Date(s.created_at).toLocaleString('es-PY');
                csv += `"${date}","${s.productName}",${s.quantity},"${s.unit}",${s.total},"${s.customer}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `reporte_turista_paraguay_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            alert('‚úÖ Reporte CSV generado correctamente');
        }

        // ========================
        // GESTI√ìN DE CLIENTES
        // ========================

        // Generar c√≥digo autom√°tico de cliente
        function generateClientCode() {
            const prefix = 'CL';
            const existingCodes = clients.map(c => c.code);
            let number = 1;
            let code = '';

            do {
                code = `${prefix}-${String(number).padStart(4, '0')}`;
                number++;
            } while (existingCodes.includes(code));

            return code;
        }

        // Abrir modal de cliente
        function openClientModal(clientId = null) {
            document.getElementById('clientModal').classList.add('active');
            document.getElementById('clientForm').reset();

            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('clientModalTitle').textContent = 'Editar Cliente';
                    document.getElementById('clientCode').value = client.code;
                    document.getElementById('clientDocType').value = client.docType;
                    const docInput = document.getElementById('clientDocNumber');
                    docInput.value = formatNumberWithDots(client.docNumber);
                    docInput.dataset.rawValue = client.docNumber;
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone;
                    document.getElementById('clientEmail').value = client.email || '';
                    document.getElementById('clientCity').value = client.city;
                    document.getElementById('clientAddress').value = client.address || '';
                    document.getElementById('clientNotes').value = client.notes || '';
                    editingClientId = clientId;
                }
            } else {
                document.getElementById('clientModalTitle').textContent = 'Agregar Cliente';
                editingClientId = null;
                document.getElementById('clientCode').value = generateClientCode();
            }
        }

        // Cerrar modal de cliente
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('active');
            editingClientId = null;
        }

        // Abrir modal de detalles del producto
        function showProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const stockStatus = product.stock <= product.minStock ?
                '<span class="badge badge-danger">‚ö†Ô∏è Stock Bajo</span>' :
                product.stock <= product.minStock * 2 ?
                '<span class="badge badge-warning">‚ö° Stock Medio</span>' :
                '<span class="badge badge-success">‚úÖ Stock OK</span>';

            const content = `
                <div class="product-details-grid">
                    <div class="product-detail-item">
                        <div class="product-detail-label">üìù C√≥digo</div>
                        <div class="product-detail-value">${product.code}</div>
                    </div>

                    ${product.imageUrl ? `
                        <div class="product-image-container">
                            <img src="${product.imageUrl}" alt="${product.name}" class="product-image-large" onclick='showImageModal("${product.imageUrl}")' style="cursor: pointer;">
                            <p style="color: #6c757d; font-size: 12px; margin-top: 10px;">Click en la imagen para ampliar</p>
                        </div>
                    ` : ''}

                    <div class="product-detail-item">
                        <div class="product-detail-label">üè∑Ô∏è Nombre</div>
                        <div class="product-detail-value">${product.name}</div>
                    </div>

                    ${product.brand ? `
                        <div class="product-detail-item">
                            <div class="product-detail-label">üé® Marca</div>
                            <div class="product-detail-value">${product.brand}</div>
                        </div>
                    ` : ''}

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìÇ Categor√≠a</div>
                        <div class="product-detail-value">${product.category}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üì¶ Stock Actual</div>
                        <div class="product-detail-value">${formatUnit(product.stock, product.unit)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">‚ö†Ô∏è Stock M√≠nimo</div>
                        <div class="product-detail-value">${formatUnit(product.minStock, product.unit)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üí∞ Precio de Costo</div>
                        <div class="product-detail-value">${formatGuaranies(product.cost)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üíµ Precio de Venta</div>
                        <div class="product-detail-value" style="color: #28a745; font-size: 18px; font-weight: 700;">${formatGuaranies(product.price)}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìä Estado de Stock</div>
                        <div class="product-detail-value">${stockStatus}</div>
                    </div>

                    <div class="product-detail-item">
                        <div class="product-detail-label">üìà Margen de Ganancia</div>
                        <div class="product-detail-value" style="color: #667eea;">
                            ${formatGuaranies(product.price - product.cost)}
                            <small style="color: #6c757d;">(${(((product.price - product.cost) / product.cost) * 100).toFixed(1)}%)</small>
                        </div>
                    </div>

                    ${product.description ? `
                        <div class="product-description-box">
                            <div class="product-detail-label">üìÑ Descripci√≥n</div>
                            <div class="product-detail-value" style="font-size: 14px; line-height: 1.6; margin-top: 8px;">
                                ${product.description}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 2px solid #dee2e6;">
                    <button class="btn btn-primary" onclick="openProductModal(${product.id}); closeProductDetailsModal();" style="flex: 1;">
                        ‚úèÔ∏è Editar Producto
                    </button>
                    <button class="btn btn-secondary" onclick="closeProductDetailsModal()">
                        ‚ùå Cerrar
                    </button>
                </div>
            `;

            document.getElementById('productDetailsContent').innerHTML = content;
            document.getElementById('productDetailsModal').classList.add('active');
        }

        function closeProductDetailsModal() {
            document.getElementById('productDetailsModal').classList.remove('active');
        }

        // Guardar cliente
        async function saveClient(event) {
            event.preventDefault();

            const docInput = document.getElementById('clientDocNumber');
            const clientData = {
                code: document.getElementById('clientCode').value,
                docType: document.getElementById('clientDocType').value,
                docNumber: docInput.dataset.rawValue || docInput.value.replace(/./g, ''),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                email: document.getElementById('clientEmail').value,
                city: document.getElementById('clientCity').value,
                address: document.getElementById('clientAddress').value,
                notes: document.getElementById('clientNotes').value
            };

            try {
                if (editingClientId) {
                    await updateClientInDB(editingClientId, clientData);
                    alert('‚úÖ Cliente actualizado correctamente');
                } else {
                    await saveClientToDB(clientData);
                    alert('‚úÖ Cliente registrado correctamente');
                }

                closeClientModal();
                await loadClients();
                await loadSalesForm();
            } catch (error) {
                alert('Error al guardar cliente: ' + error.message);
            }
        }

        // Cargar clientes
        async function loadClients() {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            try {
                clients = await loadClientsFromDB();

                if (clients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <div>No hay clientes registrados</div>
                                <button class="btn btn-primary" style="margin-top: 20px;" onclick="openClientModal()">Agregar Primer Cliente</button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                clients.forEach(client => {
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${client.code}</strong></td>
                            <td>${client.name}</td>
                            <td>${client.docType}: ${formatNumberWithDots(client.docNumber)}</td>
                            <td>${client.phone}</td>
                            <td>${client.email || '-'}</td>
                            <td>${client.city}</td>
                            <td class="action-btns">
                                <button class="action-btn btn-warning" onclick="openClientModal(${client.id})">‚úèÔ∏è Editar</button>
                                <button class="action-btn btn-danger" onclick="deleteClient(${client.id})">üóëÔ∏è Eliminar</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                alert('Error al cargar clientes: ' + error.message);
            }
        }

        // Filtrar clientes
        function filterClients() {
            const search = document.getElementById('searchClients').value.toLowerCase().trim();
            const searchNumbers = search.replace(/\D/g, ''); // B√∫squeda sin puntos ni caracteres especiales
            const rows = document.querySelectorAll('#clientsTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const textNumbers = text.replace(/\D/g, ''); // Texto sin puntos ni caracteres especiales

                // Buscar tanto en texto normal como en n√∫meros sin formato
                const matchesText = text.includes(search);
                const matchesNumbers = searchNumbers.length > 0 && textNumbers.includes(searchNumbers);

                row.style.display = (matchesText || matchesNumbers) ? '' : 'none';
            });
        }

        // Eliminar cliente
        async function deleteClient(clientId) {
            if (!confirm('¬øEst√°s seguro de eliminar este cliente?')) return;

            try {
                await deleteClientFromDB(clientId);
                await loadClients();
                await loadSalesForm();
                alert('‚úÖ Cliente eliminado correctamente');
            } catch (error) {
                alert('Error al eliminar cliente: ' + error.message);
            }
        }
    </script>

    <!-- MODAL DE CATEGOR√çAS -->
    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gestionar Categor√≠as</h2>
                <span class="close-btn" onclick="closeCategoryModal()">‚úñ</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px;">
                    <label>Nueva Categor√≠a</label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="newCategoryName" placeholder="Nombre de la categor√≠a" style="flex:1;" oninput="capitalizeFirst(this)">
                        <button class="btn btn-primary" onclick="addCategory()">‚ûï Agregar</button>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom:10px;">Categor√≠as actuales:</h3>
                    <div id="categoriesList" style="max-height:300px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    </body>
</html>
